{"ver":"0.1","info":{"id":"fs23Wd","date":"1618155030","viewed":161,"name":"Render 2D light - Part 2","username":"johnao","description":"Inspired by https://github.com/miloyip/light2d.\n\nPart 1: Basic shapes and operations https://www.shadertoy.com/view/Ndj3Dt\nPart 2: Reflection https://www.shadertoy.com/view/fs23Wd\nPart 3: Refraction https://www.shadertoy.com/view/Nd2GDd","likes":5,"published":1,"flags":32,"usePreview":0,"tags":["2d","light"],"hasliked":0,"parentid":"Ndj3Dt","parentname":"Render 2D light - Part 1"},"renderpass":[{"inputs":[{"id":"4dXGR8","filepath":"/media/previz/buffer00.png","previewfilepath":"/media/previz/buffer00.png","type":"buffer","channel":0,"sampler":{"filter":"linear","wrap":"clamp","vflip":"true","srgb":"false","internal":"byte"},"published":1}],"outputs":[{"id":"4dfGRr","channel":0}],"code":"void mainImage( out vec4 fragColor, in vec2 fragCoord )\n{\n    vec2 uv=(fragCoord+.5*vec2(max(0.,iResolution.y-iResolution.x),max(0.,iResolution.x-iResolution.y)))/max(iResolution.x,iResolution.y);\n    vec4 data=texture(iChannel0,uv);\n    vec3 col=data.xyz/data.w;\n    fragColor = vec4(col,1.0);\n}","name":"Image","description":"","type":"image"},{"inputs":[{"id":"4dXGR8","filepath":"/media/previz/buffer00.png","previewfilepath":"/media/previz/buffer00.png","type":"buffer","channel":0,"sampler":{"filter":"linear","wrap":"clamp","vflip":"true","srgb":"false","internal":"byte"},"published":1}],"outputs":[{"id":"4dXGR8","channel":0}],"code":"// sampling directions\n#define N_DIRECTION 32\n#define fN_DIRECTION 32.\n\n// constants\n#define PI 3.1415926535\n#define TAU 6.2831853\n#define MAX_DISTANCE 2.\n#define MAX_DEPTH 3\n#define MAX_STEP 64\n#define BIAS 1e-4\n#define EPSILON 1e-6\n#define REPEAT 0\n\nfloat rand(vec2 co){\n    return fract(sin(dot(co,vec2(12.9898,78.233)))*43758.5453);\n}\n\nvec3 opUnion(vec3 a,vec3 b){\n    return a.x<b.x?a:b;\n}\n\nvec3 opIntersect(vec3 a,vec3 b){\n    return a.x<b.x?vec3(b.x,a.yz):vec3(a.x,b.yz);\n}\n\nvec3 opSub(vec3 a,vec3 b){\n    return a.x>-b.x?vec3(a.x,a.yz):vec3(-b.x,a.yz);\n}\n\nvec3 opComp(vec3 a){\n    return vec3(-a.x,a.yz);\n}\n\nfloat sdfCircle(vec2 c,float r,vec2 p){\n    return length(p-c)-r;\n}\n\nfloat sdfPlane(vec2 a,vec2 n,vec2 p){\n    return dot(p-a,n);\n}\n\nfloat sdfCapsule(vec2 a,vec2 b,float r,vec2 p){\n    vec2 ap=p-a,ab=b-a;\n    return length(ap-ab*clamp(dot(ap,ab)/dot(ab,ab),0.,1.))-r;\n}\n\nfloat sdfOrientedBox(vec2 a,vec2 b,float th,vec2 p){\n    float l=length(b-a);\n    vec2 d=(b-a)/l;\n    vec2 q=(p-(a+b)*.5);\n    q=mat2(d.x,-d.y,d.y,d.x)*q;\n    q=abs(q)-vec2(l,th)*.5;\n    return length(max(q,0.))+min(max(q.x,q.y),0.);\n}\n\nvec3 map(vec2 p){\n    vec3 res=vec3(sdfCircle(vec2(.2,.8),.05,p),3.,0.);\n    res=opUnion(res,opSub(vec3(sdfPlane(vec2(.5),vec2(0.,1.),p),0.,1.),vec3(sdfCircle(vec2(.5),.3,p),0.,0.)));\n    return res;\n}\n\nvec2 gradient(vec2 p){\n    vec2 eps=vec2(1e-4,0.);\n    return normalize(vec2(map(p+eps).x-map(p-eps).x,map(p+eps.yx).x-map(p-eps.yx).x));\n}\n\nfloat trace(vec2 ro,vec2 rd){\n    float t=0.;\n    float sum=0.;\n    float coeff=1.;\n    for(int depth=0;depth<MAX_DEPTH;++depth){\n        bool ref=false;\n        for(int i=0;i<MAX_STEP&&t<MAX_DISTANCE;++i){\n            vec2 p=ro+t*rd;\n            vec3 res=map(p);\n            if(res.x<EPSILON){\n                sum+=coeff*res.y;\n                if(res.z>0.){\n                    t=0.;\n                    vec2 n=gradient(p);\n                    ro=p+n*BIAS;\n                    rd=reflect(rd,n);\n                    coeff*=res.z;\n                    ref=true;\n                }\n                break;\n            }\n            t+=res.x;\n        }\n        if(!ref){\n            break;\n        }\n    }\n    return sum;\n}\n\nfloat sampling(vec2 p){\n    float s=0.;\n    float n=rand(p)+iTime;\n    for(int i=0;i<N_DIRECTION;++i){\n        n+=1.;\n        s+=trace(p,vec2(sin(n*TAU/fN_DIRECTION),cos(n*TAU/fN_DIRECTION)));\n    }\n    return s/fN_DIRECTION;\n}\n\nvoid mainImage(out vec4 fragColor,in vec2 fragCoord){\n    vec2 uv=fragCoord/iResolution.xy;\n    float s=sampling(uv);\n    vec4 data=texture(iChannel0,uv);\n    if(iFrame==0){\n        data=vec4(0.);\n    }\n    data+=vec4(vec3(s),1.);\n    fragColor = data;\n}","name":"Buffer A","description":"","type":"buffer"}]}