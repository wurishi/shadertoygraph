{"ver":"0.1","renderpass":[{"outputs":[{"channel":0,"id":"4dfGRr"}],"inputs":[],"code":"#define t (iTime * 2.)\n\n#define DETAIL 8\n\nfloat hash(float v) { return fract(sin(v)*45841.117); }\nfloat noise(float v) {\n\tfloat F = floor(v), f = fract(v);\n\tf = f * f * (3. - 2. *f);\n\treturn mix(hash(F), hash(F+1.), f);\n}\nfloat noise(vec2 v) {\n\tvec2 F = floor(v), f = fract(v);\n\tfloat V = F.x + F.y * 117.;\n\tf = f * f * (3. - 2. *f);\n\treturn mix(mix(hash(V), hash(V+1.), f.x),\n\t\t\t   mix(hash(V+117.), hash(V+118.), f.x), f.y);\n}\nfloat fnoise(vec2 v) {\n\treturn .5 * noise(v) + .25*noise(v*1.98) + .125 * noise(v * 4.12);\n}\n\nfloat isect_tri(in vec3 O, in vec3 D, in vec3 v0, in vec3 v1, in vec3 v2, out vec3 n, out vec3 p, out vec3 c) {\n\t// MÃ¶llerâ€“Trumbore\n\tvec3 e1 = v1 - v0;\n\tvec3 e2 = v2 - v0;\n\tvec3 P, Q, T;\n\tfloat det, inv_det, u, v, tt;\n\tP = cross(D, e2);\n\tdet = dot(e1, P);\n\tif (abs(det) < 1e-4) return -1.;\n\tinv_det = 1. / det;\n\tT = O - v0;\n\tu = dot(T, P) * inv_det;\n\tif (u < 0. || u > 1.) return -1.;\n\tQ = cross(T, e1);\n\tv = dot(D, Q) * inv_det;\n\tif (v < 0. || (v+u) > 1.) return -1.;\n\ttt = dot(e2, Q) * inv_det;\n\tif (tt <= 0.) return -1.;\n\tn = normalize(cross(e1, e2));\n\tp = O + D * tt;\n\tc = vec3(u, v, 1. - u - v);\n\treturn tt;\n}\n\nvec3 lookat(vec3 pos, vec3 at, vec3 rdir) {\n\tvec3 f = normalize(at - pos);\n\tvec3 r = cross(f, vec3(0., 1., 0.));\n\tvec3 u = cross(r, f);\n\treturn mat3(r, u, -f) * rdir;\n}\n\nstruct material_t {\n\tvec3 diffuse;\n\tvec3 specular;\n\tfloat specular_power;\n};\n\nvec3 light_dir(vec3 at, vec3 normal, vec3 l_eye, material_t m, vec3 l_color, vec3 l_dir) {\n\tvec3 color = m.diffuse * l_color * max(0.,dot(normal,l_dir));\n\t\n\tif (m.specular_power > 0.) {\n\t\tvec3 h = normalize(l_dir + l_eye);\n\t\tcolor += l_color * m.specular * pow(max(0.,dot(normal,h)), m.specular_power) * (m.specular_power + 8.) / 25.;\n\t}\n\treturn color;\n}\n\nvec3 v_i(in vec2 v) {\n\tfloat phi = v.x * 6.2831;\n\tfloat theta = v.y * 3.1416;\n\tfloat r = sin(theta);\n\tfloat R = 1.5 + .6*sin(phi*2.+t+sin(theta*3.+t));//noise(sin(10.*fract(v)+t*1.4));\n\treturn R * vec3(r*cos(phi), cos(theta), r*sin(phi));\n}\n\nvoid mainImage( out vec4 fragColor, in vec2 fragCoord ) {\n\tvec2 uv = fragCoord.xy / iResolution.xy * 2. - 1.;\n\tuv.x *= iResolution.x / iResolution.y;\n\t\n\tfloat ta = 3.5 * cos(t*.14);\n\tvec3 at = .3*(vec3(noise(t+.3), noise(ta), noise(t+7.6)) - .5);\n\tvec3 O = 5. * vec3(cos(ta), cos(t*.3), sin(ta));\n\tvec3 D = lookat(O, at, normalize(vec3(uv, -2.)));\n\t\n\tvec3 color = vec3(0.,.2,.1);\n\tvec3 N, P, C;\n\tfloat minlen = 10000.;\n\t\n\tmaterial_t m;\n\tm.diffuse = vec3(.8);\n\tm.specular = 10.*vec3(1., .2, 1.);\n\tm.specular_power = 30.;\n\t\n\tfor (int i = 0; i < DETAIL*DETAIL; ++i) {\n\t\tvec2 vi = vec2(mod(float(i),float(DETAIL)), float(i/DETAIL)) / float(DETAIL);\n\t\tvec3 v0 = v_i(vi);\n\t\tvec3 v1 = v_i(vi + vec2(1./float(DETAIL), 0.));\n\t\tvec3 v2 = v_i(vi + vec2(.0, 1./float(DETAIL)));\n\t\tvec3 v3 = v_i(vi + vec2(1./float(DETAIL), 1./float(DETAIL)));\n\t\tvec3 n, p, c;\n\t\tfloat len = isect_tri(O, D, v0, v3, v1, n, p, c);\n\t\tif (len >= 0. && len < minlen && dot(n,D) >= 0.) {\n\t\t\tN = n;\n\t\t\tP = p;\n\t\t\tC = c;\n\t\t\tminlen = len;\n\t\t}\n\t\tlen = isect_tri(O, D, v0, v2, v3, n, p, c);\n\t\tif (len >= 0. && len < minlen && dot(n,D) >= 0.) {\n\t\t\tN = n;\n\t\t\tP = p;\n\t\t\tC = c;\n\t\t\tminlen = len;\n\t\t}\n\t}\n\t\n\tif (minlen < 10000.) {\n\t\tC = vec3(smoothstep(.3,.8,pow(min(C.x, min(C.y, C.z)), .1)));\n\t\tvec3 eyedir = normalize(at-O);\n\t\tcolor = C * m.diffuse * .03;\n\t\tcolor += C * light_dir(P, N, eyedir, m, vec3(1.,.2,.1), normalize(vec3(1.,0.,1.)));\n\t\tcolor += C * light_dir(P, N, eyedir, m, vec3(.0,.2,.9), normalize(vec3(0.,1.,-1.)));\n\t} else {\n\t\tvec2 np = uv*20. + 2.7*at.xy;\n\t\tnp.x += .2 * cos(fnoise(np) * 6.2831);\n\t\tnp.y += .2 * sin(fnoise(np) * 6.2831);\n\t\tcolor *= .8 + .2 * fnoise(np);\n\t}\n\t\t\n\tfragColor = vec4(pow(color, vec3(1./2.2)),1.0);\n}","name":"Image","description":"","type":"image"}],"flags":{"mFlagVR":false,"mFlagWebcam":false,"mFlagSoundInput":false,"mFlagSoundOutput":false,"mFlagKeyboard":false,"mFlagMultipass":false,"mFlagMusicStream":false},"info":{"id":"MsBGDR","date":"1385959598","viewed":949,"name":"I accidentally a thing","username":"w23","description":"Playing with ray-triangle intersection.","likes":35,"published":1,"flags":0,"usePreview":0,"tags":["raytracing","triangle","mesh"],"hasliked":0,"parentid":"","parentname":""}}