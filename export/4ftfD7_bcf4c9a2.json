{"ver":"0.1","info":{"id":"4ftfD7","date":"1733182441","viewed":89,"name":"Smoke Saver","username":"Dusty","description":"turning smoke toy into smoke saver\n\nfullscreen is fine, no iteration stuff, 60fps on yesteryears integrated gpu","likes":10,"published":1,"flags":32,"usePreview":0,"tags":["simulation","smoke","gas"],"hasliked":0,"parentid":"lccBzH","parentname":"Smoke Toy"},"renderpass":[{"inputs":[{"id":"4dXGR8","filepath":"/media/previz/buffer00.png","previewfilepath":"/media/previz/buffer00.png","type":"buffer","channel":0,"sampler":{"filter":"linear","wrap":"clamp","vflip":"true","srgb":"false","internal":"byte"},"published":1},{"id":"XsXGR8","filepath":"/media/previz/buffer01.png","previewfilepath":"/media/previz/buffer01.png","type":"buffer","channel":1,"sampler":{"filter":"linear","wrap":"clamp","vflip":"true","srgb":"false","internal":"byte"},"published":1},{"id":"4sXGR8","filepath":"/media/previz/buffer02.png","previewfilepath":"/media/previz/buffer02.png","type":"buffer","channel":2,"sampler":{"filter":"linear","wrap":"clamp","vflip":"true","srgb":"false","internal":"byte"},"published":1},{"id":"XdfGR8","filepath":"/media/previz/buffer03.png","previewfilepath":"/media/previz/buffer03.png","type":"buffer","channel":3,"sampler":{"filter":"linear","wrap":"clamp","vflip":"true","srgb":"false","internal":"byte"},"published":1}],"outputs":[{"id":"4dfGRr","channel":0}],"code":"#define field iChannel3\n\n// xy is flow field\n// the position of these values within a cell:\n//\n//     o          o\n//\n//\n// +-------+\n// |       |\n// x   o   |      o\n// |       |\n// +---y---+\n//\n// so x and y is flow at the edges of cells\n//\n// z is virtual pressure field\n// w is smoke field\n//\n// these values represent the entire cell, unlike x and y\n//\n// In Buffer A, the edge velocities are considered in updating the virtual pressure\n// In buffer B, the virtual pressure is considered in updating the edge velocities\n// In Buffer C, the field is resampled based on cell flow (computed for the center of the cell)\n// In Buffer D, smoke is blown based on sketchy bodgy stuff\n\n#define HALF (0.5*iResolution.xy)\n#define GrayShade(gray, r, g, b) vec3(pow(gray, 1.0 / (r)), pow(gray, 1.0 / (g)), pow(gray, 1.0 / (b)))\n\nMAIN\n{   \n    vec2 coord = (Coord-HALF)*1.25+HALF;\n    vec4 c = Sample(field, coord);\n    float p = smoothstep(-0.05, 0.05,c.z)-0.5;\n    float d = Sample(field, coord+0.5).w \n            - Sample(field, coord-0.5).w;\n    fragColor = vec4(\n        GrayShade(c.w, 2.2+p, 2.2, 2.2-p),\n        1.0);\n\n    // green/purple fringing in dramatic areas\n    fragColor.g += 3.1415*d;    \n}","name":"Image","description":"","type":"image"},{"inputs":[],"outputs":[],"code":"#define MAIN void mainImage( out vec4 fragColor, in vec2 fragCoord )\n\n// Coord and iCoord are taken to be points on a lattice, not cell centers\n\n#define Coord floor(fragCoord)\n#define iCoord ivec2(Coord)\n\n// handy\n\n#define S ivec2(0,-1)\n#define W ivec2(-1,0)\n#define N ivec2(0,1)\n#define E ivec2(1,0)\n\n// Sample(...) expects lattice-relative coordinates such as Coord or iCoord\n// (limited) tiling is handled \n\nvec4 Sample(sampler2D s, ivec2 coord)\n{ \n    return texelFetch(s, (coord + textureSize(s,0)*textureSize(s,0)) % textureSize(s,0), 0);\n}\n\nmat4 Sample4(sampler2D s, ivec2 coord) \n{ \n    return mat4( \n        Sample(s, coord),\n        Sample(s, coord + E), \n        Sample(s, coord + N), \n        Sample(s, coord + 1) ); \n}\n\nvec4 Mix4(mat4 M, vec2 f) \n{ \n    return mix(mix(M[0], M[1], f.x), mix(M[2], M[3], f.x), f.y);\n}\n\nvec4 Sample(sampler2D s, vec2 coord) \n{\n    return Mix4( Sample4(s, ivec2(floor(coord))), fract(coord) );\n}\n\n// am I even using this now?\nfloat RND(int key, int x)\n{\n    uint h = uint(key); h *= 747796405u;\n    h += uint(x); h *= 747796405u;\n    h ^= (h >> 16); h *= 747796405u;\n    h ^= (h >> 16); h *= 747796405u;\n    return exp2(-32.0) * float(h);\n}\n\n","name":"Common","description":"","type":"common"},{"inputs":[{"id":"4dXGR8","filepath":"/media/previz/buffer00.png","previewfilepath":"/media/previz/buffer00.png","type":"buffer","channel":0,"sampler":{"filter":"linear","wrap":"clamp","vflip":"true","srgb":"false","internal":"byte"},"published":1},{"id":"XsXGR8","filepath":"/media/previz/buffer01.png","previewfilepath":"/media/previz/buffer01.png","type":"buffer","channel":1,"sampler":{"filter":"linear","wrap":"clamp","vflip":"true","srgb":"false","internal":"byte"},"published":1},{"id":"4sXGR8","filepath":"/media/previz/buffer02.png","previewfilepath":"/media/previz/buffer02.png","type":"buffer","channel":2,"sampler":{"filter":"linear","wrap":"clamp","vflip":"true","srgb":"false","internal":"byte"},"published":1},{"id":"XdfGR8","filepath":"/media/previz/buffer03.png","previewfilepath":"/media/previz/buffer03.png","type":"buffer","channel":3,"sampler":{"filter":"linear","wrap":"clamp","vflip":"true","srgb":"false","internal":"byte"},"published":1}],"outputs":[{"id":"4dXGR8","channel":0}],"code":"#define field iChannel3\n\n// change of \"pressure\" due to flow\n\nMAIN\n{\n    vec4 c = Sample(field, iCoord);\n    float n = Sample(field, iCoord + N).y;\n    float e = Sample(field, iCoord + E).x;\n    fragColor = vec4(\n        c.x,\n        c.y,\n        c.z + 0.0625*(c.x + c.y - n - e),\n        c.w);    \n}\n\n\n\n","name":"Buffer A","description":"","type":"buffer"},{"inputs":[{"id":"4dXGR8","filepath":"/media/previz/buffer00.png","previewfilepath":"/media/previz/buffer00.png","type":"buffer","channel":0,"sampler":{"filter":"linear","wrap":"clamp","vflip":"true","srgb":"false","internal":"byte"},"published":1},{"id":"XsXGR8","filepath":"/media/previz/buffer01.png","previewfilepath":"/media/previz/buffer01.png","type":"buffer","channel":1,"sampler":{"filter":"linear","wrap":"clamp","vflip":"true","srgb":"false","internal":"byte"},"published":1},{"id":"4sXGR8","filepath":"/media/previz/buffer02.png","previewfilepath":"/media/previz/buffer02.png","type":"buffer","channel":2,"sampler":{"filter":"linear","wrap":"clamp","vflip":"true","srgb":"false","internal":"byte"},"published":1},{"id":"XdfGR8","filepath":"/media/previz/buffer03.png","previewfilepath":"/media/previz/buffer03.png","type":"buffer","channel":3,"sampler":{"filter":"linear","wrap":"clamp","vflip":"true","srgb":"false","internal":"byte"},"published":1}],"outputs":[{"id":"XsXGR8","channel":0}],"code":"#define field iChannel0\n\n// change of flow due to \"pressure\"\n\nMAIN\n{\n    vec4 c = Sample(field, iCoord);\n    float w = Sample(field, iCoord + W).z;\n    float s = Sample(field, iCoord + S).z;\n    fragColor = vec4(\n        c.x + 0.5*(w-c.z), \n        c.y + 0.5*(s-c.z), \n        c.z,\n        c.w);\n}\n","name":"Buffer B","description":"","type":"buffer"},{"inputs":[{"id":"4dXGR8","filepath":"/media/previz/buffer00.png","previewfilepath":"/media/previz/buffer00.png","type":"buffer","channel":0,"sampler":{"filter":"linear","wrap":"clamp","vflip":"true","srgb":"false","internal":"byte"},"published":1},{"id":"XsXGR8","filepath":"/media/previz/buffer01.png","previewfilepath":"/media/previz/buffer01.png","type":"buffer","channel":1,"sampler":{"filter":"linear","wrap":"clamp","vflip":"true","srgb":"false","internal":"byte"},"published":1},{"id":"4sXGR8","filepath":"/media/previz/buffer02.png","previewfilepath":"/media/previz/buffer02.png","type":"buffer","channel":2,"sampler":{"filter":"linear","wrap":"clamp","vflip":"true","srgb":"false","internal":"byte"},"published":1},{"id":"XdfGR8","filepath":"/media/previz/buffer03.png","previewfilepath":"/media/previz/buffer03.png","type":"buffer","channel":3,"sampler":{"filter":"linear","wrap":"clamp","vflip":"true","srgb":"false","internal":"byte"},"published":1}],"outputs":[{"id":"4sXGR8","channel":0}],"code":"#define field iChannel1\n\n#define DECAY vec4(1.0, 1.0, 1.0, 0.9997)\n\n// change of position due to flow\n\nMAIN\n{\n    vec2 c = Sample(field, iCoord).xy;\n    float n = Sample(field, iCoord+N).y;\n    float e = Sample(field, iCoord+E).x;\n    vec2 o = 0.5 * (c + vec2(e, n));\n    fragColor = Sample(field, Coord - o) * DECAY;\n}","name":"Buffer C","description":"","type":"buffer"},{"inputs":[{"id":"4dXGR8","filepath":"/media/previz/buffer00.png","previewfilepath":"/media/previz/buffer00.png","type":"buffer","channel":0,"sampler":{"filter":"linear","wrap":"clamp","vflip":"true","srgb":"false","internal":"byte"},"published":1},{"id":"XsXGR8","filepath":"/media/previz/buffer01.png","previewfilepath":"/media/previz/buffer01.png","type":"buffer","channel":1,"sampler":{"filter":"linear","wrap":"clamp","vflip":"true","srgb":"false","internal":"byte"},"published":1},{"id":"4sXGR8","filepath":"/media/previz/buffer02.png","previewfilepath":"/media/previz/buffer02.png","type":"buffer","channel":2,"sampler":{"filter":"linear","wrap":"clamp","vflip":"true","srgb":"false","internal":"byte"},"published":1},{"id":"XdfGR8","filepath":"/media/previz/buffer03.png","previewfilepath":"/media/previz/buffer03.png","type":"buffer","channel":3,"sampler":{"filter":"linear","wrap":"clamp","vflip":"true","srgb":"false","internal":"byte"},"published":1}],"outputs":[{"id":"XdfGR8","channel":0}],"code":"#define field iChannel2\n\n#define SIZE iResolution.y\n#define BLOW_RATE 360\n#define BLOW_DURATION 240\n#define BLOW_START (0.125 * iResolution.xy + 0.75 * iResolution.xy * vec2(RND(iFrame/BLOW_RATE-0, 42), RND(iFrame/BLOW_RATE-2, 42)))\n#define BLOW_END (0.125 * iResolution.xy + 0.75 * iResolution.xy * vec2(RND(iFrame/BLOW_RATE-1, 42), RND(iFrame/BLOW_RATE-3, 42)))\n#define BLOW_R (SIZE*0.0033)\n\n#define SD(a,b,p) length(((p)-(a))-((b)-(a))*clamp(dot((p)-(a),(b)-(a))/dot((b)-(a),(b)-(a)), 0.0, 1.0))\n\nMAIN\n{\n    fragColor = Sample(field, iCoord);\n    if(iFrame % BLOW_RATE >= (BLOW_RATE - BLOW_DURATION))\n    {\n        vec2 start = BLOW_START;\n        vec2 end = BLOW_END;\n        float d = SD(end, start, fragCoord); \n        vec2 delta = (end - start);\n        if(d < BLOW_R && length(delta) > BLOW_R)\n        {\n            fragColor.xy += (4.0/SIZE) * ((BLOW_R - d) / BLOW_R) * (delta/length(delta));\n            fragColor.w = fragColor.w + (8.0/SIZE) * ((BLOW_R - d) / BLOW_R);\n        }\n        \n    }\n}","name":"Buffer D","description":"","type":"buffer"}]}