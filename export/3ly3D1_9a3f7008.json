{"ver":"0.1","info":{"id":"3ly3D1","date":"1578775675","viewed":364,"name":"water tunnel fog","username":"jojobavg","description":"Procedural sea tunnel with big fog\nAfter around 30 seconds, there are more details because the \"color\" variable (bad named) adds some noise looks like subsurface.","likes":10,"published":1,"flags":0,"usePreview":0,"tags":["procedural","raymarching","noise","tunnel","sea","water"],"hasliked":0,"parentid":"","parentname":""},"renderpass":[{"inputs":[],"outputs":[{"id":"4dfGRr","channel":0}],"code":"// Using code from\n\n//Morgan McGuire for the noise function\n// https://www.shadertoy.com/view/4dS3Wd\n\n// TDM for the getSkyColor function\n// https://www.shadertoy.com/view/Ms2SD1\n\n#define time iTime\n#define depth 20.0\n#define fogSize 10.0\n#define seuil 4.0\n#define steps 100.0\nfloat fogCoef=1.0/(depth-fogSize);\n\n\nfloat PI=acos(-1.0);\n\nfloat random (in float x) {\n\treturn fract(sin(x)*1e4);\n}\n\n\nfloat noise(in vec3 p) {\n\tconst vec3 step = vec3(110.0, 241.0, 171.0);\n\n\tvec3 i = floor(p);\n\tvec3 f = fract(p);\n\n\t// For performance, compute the base input to a\n\t// 1D random from the integer part of the\n\t// argument and the incremental change to the\n\t// 1D based on the 3D -> 1D wrapping\n\tfloat n = dot(i, step);\n\n\tvec3 u = f * f * (3.0 - 2.0 * f);\n\treturn mix( mix(mix(random(n + dot(step, vec3(0,0,0))),\n\trandom(n + dot(step, vec3(1,0,0))),\n\tu.x),\n\tmix(random(n + dot(step, vec3(0,1,0))),\n\trandom(n + dot(step, vec3(1,1,0))),\n\tu.x),\n\tu.y),\n\tmix(mix(random(n + dot(step, vec3(0,0,1))),\n\trandom(n + dot(step, vec3(1,0,1))),\n\tu.x),\n\tmix(random(n + dot(step, vec3(0,1,1))),\n\trandom(n + dot(step, vec3(1,1,1))),\n\tu.x),\n\tu.y),\n\tu.z);\n}\n\nmat2 rot(float a) {\n\tfloat ca=cos(a);\n\tfloat sa=sin(a);\n\treturn mat2(ca,sa,-sa,ca);\n}\n\nfloat water(in vec3 p, vec3 centerPos, float scale,float radius ) {\n\tvec3 truc = vec3(p.x+sin(length(p*0.2)+time)*2.0,p.y+sin(length(p*0.2))*2.0,0.0);\n\tfloat coef = length(truc)-4.0;\n\n\tfloat c=1.0;\n\tfloat n1=1.0;\n        \n\tfloat d=1.0;\n\tfor(int i=0; i<8; ++i) {\n\t\tn1+=2.0/c*abs(noise((p*c-time*2.0*d)*scale));\n\t\tc*=2.0;\n\t\td+=1.5;\n\t}\n\n\treturn n1*coef;\n\n}\n\nfloat mapHyper(vec3 p){\n\treturn water(p,vec3(0,0,0),0.3,0.1);\n}  \n\n\nvec3 tunnel(vec3 p){\n\tvec3 off=vec3(0);\n\toff.x += sin(p.z*0.2)*1.5;\n\toff.y += sin(p.z*0.3)*1.3;\n\treturn off;\n}\nvec3 getSkyColor(vec3 e) {\n\te.y = abs(e.y);\n\te.y = max(e.y,0.0);\n\treturn vec3(pow(1.0-e.y,2.0), 1.0-e.y, 0.6+(1.0-e.y)*0.4);\n}\n\nvoid mainImage(out vec4 fragColor, in vec2 fragCoord)\n{\n\t\n\t\n  vec2 uv = vec2(fragCoord.x / iResolution.x, fragCoord.y / iResolution.y);\n  uv -= 0.5;\n  uv /= vec2(iResolution.y / iResolution.x, 1);\n  vec3 s=vec3(-1.0,-1.0,-3);\n  float t2=(time*1.5);\n  s.xz *= rot(sin(t2)*0.015);\n \n  vec3 t=vec3(0,0,0);\n\ts -= tunnel(s);\n\tt -= tunnel(t);\n  s.x += cos(t2*0.2)*1.0*sin(time*0.01);\n  s.y += sin(t2*0.2)*1.0*sin(time*0.01+10.0);\n  vec3 cz=normalize(t-s);\n  vec3 cx=normalize(cross(cz,vec3(0,1,0)));\n  vec3 cy=normalize(cross(cz,cx));\n  vec3 r=normalize(uv.x*cx+uv.y*cy+cz*0.7);\n\n\tvec3 p=s;\n\n\tfloat c= 0.0;\n\tfloat color = 0.0;\n\tvec3 p2;\n\tbool hit = false;\n\tfor(int i=0; i<int(steps); ++i) \n\t{\n\t\tfloat truc;\n\t\ttruc = mapHyper(p);\n\t\tc =truc;    \n\t\tif( c>seuil )\n\t\t{\n\t\t\tcolor+=1.0;\n\t\t\n\t\t}\n\t\tp+=r*(truc-seuil)*0.09;\n        if(length(p-s)>depth){hit = false;break;}\nhit = true;\n\t}\n\tvec3 col=vec3(0);\n    float fresnel;\n    vec3 reflected;\nif (hit)\n{\n\tvec2 off=vec2(0.01,0.0);\n\tvec3 n=normalize(mapHyper(p)-vec3(mapHyper(p-off.xyy), mapHyper(p-off.yxy), mapHyper(p-off.yyx)));\n\tcol = mix(vec3(0.2,0.3,0.4),vec3(0.1,0.365,0.441),1.0-clamp(color,0.0,1.0));\n\n\t fresnel = clamp(1.0- dot(n,s), 0.05, 0.75);\n\t reflected = getSkyColor(reflect(r,normalize(n*0.5+vec3(0.0,1.0,0.0)*0.5)))*0.7;\n\tcol = mix(col,reflected,fresnel*reflected);\n    //col = vec3(spec);\n\n}else\n    col=vec3(0.95,0.95,0.95);//getSkyColor(r)*0.8;\n    float fog =  clamp((length(p-s)-fogSize)*fogCoef,0.0,1.0);\n    col = mix(col,vec3(0.85,0.85,0.85),fog);\n\tfragColor = vec4(col,1.0);\n}","name":"Image","description":"","type":"image"}]}