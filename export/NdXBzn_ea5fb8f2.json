{"ver":"0.1","info":{"id":"NdXBzn","date":"1644365164","viewed":159,"name":"Flowing Fog of Time","username":"Hyeve","description":"...i'm surprised this runs so well, ngl. All \"real\" raymarched rendering - no trickery for the volumetrics or transparency, they're all real raymarched objects. Apologies for the absolutely awful compacted code ;)","likes":10,"published":1,"flags":0,"usePreview":0,"tags":["3d","raymarching","transparency","volumetric","fog"],"hasliked":0,"parentid":"","parentname":""},"renderpass":[{"inputs":[],"outputs":[{"id":"4dfGRr","channel":0}],"code":"#define rot(a) mat2(cos(a),sin(a),-sin(a),cos(a))\n\nvec2 uv;\nvec3 cp,cn,cr,ro,rd,ss,oc,cc,gl,vb;\nvec4 fc;\nfloat tt,cd,sd,io,oa,td;\nint es=0,ec;\n\nfloat bx(vec3 p,vec3 s){vec3 q=abs(p)-s;return min(max(q.x,max(q.y,q.z)),0.)+length(max(q,0.));}\nfloat cy(vec3 p, vec2 s){p.y+=s.x/2.;p.y-=clamp(p.y,0.,s.x);return length(p)-s.y;}\nfloat tor(vec3 p,vec2 t){return length(vec2(length(p.xz)-t.x,p.y))-t.y;}\nfloat smin(float a, float b, float k){float h=clamp(0.5+0.5*(b-a)/k,0.,1.);return mix(b,a,h)-k*h*(1.-h);}\n\n\nfloat mp(vec3 p)\n{\n\t\tvec3 ppp=p;\n\t\tp.yz *= rot(sin(tt*0.5)*0.1);\n\t\tfloat zid=p.z;\n\t\tp.z=abs(p.z)-2.;\n\t\tp.x+=tt*0.3*(zid>0.?-1.:1.);\n\t\tfloat xid=floor(p.x / 5.);\n\t\tp.x=mod(p.x, 5.)-2.5;\n\t\tfloat bd=abs(bx(p, vec3(3.)))+0.05;\n\t\tfloat sp=0.4+sin(xid)*0.2;\n\t\tvec3 bc=mix(vec3(0.4,0.25,1.),vec3(0.8,0.25,0.5),cos(xid*1.2)*0.5+0.5);\n\t\tvec3 vc=mix(vec3(0.1,0.65,0.3),vec3(0.2,0.3,0.8),sin(xid*1.2)*0.5+0.5);\t\n\t  float an=(1.-pow(1.-abs(sin(tt*sp)),1.4))*sign(sin(tt*sp));\n\t\tfloat ra=clamp(sin(tt*sp+0.8) * 1.5, -1., 1.);\n\t  float rn=(1.-pow(1.-abs(ra),2.5))*sign(ra);\n\t\tp.yx*=rot(1.552 * rn - 1.57);vec3 pp=p;\n\t\tfloat de=1.-pow(clamp(abs(p.y+an+p.x*(1.-pow(abs(an),2.))),0.,1.),1.);\n\t\tfloat c=cy(p, vec2(3.,1.));p.y=abs(p.y)-1.4;\n\t\tfloat cc=length(p)-0.5;p=pp;c=mix(c,cc,0.5)-0.;\n\t\tcc=cy(p,vec2(0.3,0.15));c=smin(c,cc,0.2);\t\n\t\tc=max(c,abs(p.y)-1.6);p.y=abs(p.y)-1.7;\n\t\tcc=length(p.xz)-0.8;float ca=max(cc,abs(p.y)-0.1);\n\t\tgl+=0.02/(0.02+ca*ca)*bc*0.005;\n\t\tp.y=abs(p.y)-0.12;ca=smin(ca,tor(p, vec2(0.79, 0.03)),0.06);\n\t  c=min(c,ca);p=pp;float vl=abs(c+0.04)-0.001;\n\t\tfloat vd=abs(c+0.03)-0.001;vl=min(vl,vd);\n\t\tgl+=0.02/(0.02+vd*vd)*vc*0.0021;\n\t\tc=abs(c)-0.001;sd=min(vl,c);\n\t\tppp.xy*=rot(tt*0.05);\n\t\tppp.x=mod(ppp.x,3.)-1.5;\n\t\tfloat pl = abs(cy(ppp,vec2(10,0.5)))-0.001;\n\t\tsd=min(sd,bd);\t\n\t\tsd=min(sd,pl);\n\t\tif(sd<0.001)\n\t\t{\n\t\t\toc=bc;\n\t\t\tio=1.1;\n\t\t\tif(ca<sd+0.01){oa=1.;ss=pow(length(p)*0.4,5.)*oc*0.35;}\n\t\t  if(vl<sd+0.01){oa=0.;oc=vc;vb=vec3(1.,max(2.-de*5.,1.),1.1);io=1.;}ec=3;\t\n\t\t\tif(pl<sd+0.01){oc=vec3(1);oa=0.;io=1.;vb=vec3(1.,2.,3.);}\n\t\t}\n\t\treturn sd;\n}\n\nvoid tr(){vb.x=0.;cd=0.;for(float i=0.;i<512.;i++){mp(ro+rd*cd);cd+=sd;td+=sd;if(sd<0.0001||cd>128.)break;}}\nvoid nm(){mat3 k=mat3(cp,cp,cp)-mat3(.001);cn=normalize(mp(cp)-vec3(mp(k[0]),mp(k[1]),mp(k[2])));}\n\nvoid px()\n{\n  cc=vec3(0.25,0.4,0.6)+length(pow(rd+vec3(0,0.5,0),vec3(2)))*0.3+gl;\n  if(cd>128.){oa=1.;return;}\n  vec3 l=vec3(0.4,0.7,0.8);\n  float df=clamp(length(cn*l),0.,1.);\n  float fr=pow(1.-df,3.)*0.2;\n\tfloat sp=(1.-length(cross(cr,cn*l)))*0.2;\n\tfloat ao=min(mp(cp+cn*0.3)-0.3,0.3)*0.6;\n  cc=mix((oc*(df+fr+ss)+fr+sp+ao+gl),oc,vb.x);\n}\n\nvec4 render(vec2 fragCoord)\n{\n\ttt=mod(iTime, 300.);\n  uv=vec2(fragCoord.x/iResolution.x,fragCoord.y/iResolution.y);\n  uv-=0.5;uv/=vec2(iResolution.y/iResolution.x,1);\n  ro=vec3(0,0,-7);rd=normalize(vec3(uv,1));\n  \n\tfor(int i=0;i<12;i++)\n  {\n\t\ttr();cp=ro+rd*cd;\n    nm();ro=cp-cn*0.01;\n    cr=refract(rd,cn,i%2==0?1./io:io);\n    if(length(cr)==0.&&es<=0){cr=reflect(rd,cn);es=ec;}\n    if(max(es,0)%3==0&&cd<128.)rd=cr;es--;\n\t\tif(vb.x>0.&&i%2==1)oa=pow(clamp(cd/vb.y,0.,1.),vb.z);\n\t\tpx();fc=fc+vec4(cc*oa,oa)*(1.-fc.a);\t\n\t\tif((fc.a>=1.||cd>128.))break;\n  }\n  return pow(fc/fc.a,vec4(1.1))*1.15;\n}\n\nvoid mainImage( out vec4 fragColor, in vec2 fragCoord )\n{\n    \n    fragColor = render(fragCoord);\n}","name":"Image","description":"","type":"image"}]}