{"ver":"0.1","info":{"id":"fsGfWt","date":"1658965678","viewed":253,"name":"Rainbow Sand Experiment 2","username":"fenix","description":"This is like one of those sand paintings in a bottle, but with crazy colors. The idea is to move particles within 2x2 cells ensuring no loss of mass.\n* Mouse at top of screen: grab particle spawner\n* Mouse elsewhere: delete particles\n* Space: reset","likes":6,"published":3,"flags":48,"usePreview":0,"tags":["simulation","particles","sand"],"hasliked":0,"parentid":"NsVfWy","parentname":"Rainbow Sand Experiment"},"renderpass":[{"inputs":[{"id":"4dXGR8","filepath":"/media/previz/buffer00.png","previewfilepath":"/media/previz/buffer00.png","type":"buffer","channel":0,"sampler":{"filter":"nearest","wrap":"clamp","vflip":"true","srgb":"false","internal":"byte"},"published":1}],"outputs":[{"id":"4dfGRr","channel":0}],"code":"// ---------------------------------------------------------------------------------------\n//\tCreated by fenix in 2022\n//\tLicense Creative Commons Attribution-NonCommercial-ShareAlike 3.0 Unported License.\n//\n//  Particles are capable of falling or sliding down a slope greater than 45 degrees. \n//  Particle motion is performed within 2x2 cells. Buffer A's cells are in a natural\n//  alignment: cell 0, 0 includes the four cells (0 ... 1, 0 ... 1). Buffer B is offset\n//  by 1, 1 so it can advect particles across buffer A's cell boundaries. Buffers C and D\n//  are just copies of A and B respectively to get twice the integration speed.\n//\n// ---------------------------------------------------------------------------------------\n\nvoid mainImage( out vec4 fragColor, in vec2 fragCoord )\n{\n    ivec2 ifc = ivec2(fragCoord);\n    vec4 top = texelFetch(iChannel0, ivec2(ifc.x, ifc.y & ~1), 0);\n    vec4 bottom = texelFetch(iChannel0, ivec2(ifc.x, ifc.y | 1), 0);\n    fragColor = max(top, bottom);\n}","name":"Image","description":"","type":"image"},{"inputs":[{"id":"4dXGRr","filepath":"/presets/tex00.jpg","previewfilepath":"/presets/tex00.jpg","type":"keyboard","channel":3,"sampler":{"filter":"linear","wrap":"clamp","vflip":"true","srgb":"false","internal":"byte"},"published":1},{"id":"XdfGR8","filepath":"/media/previz/buffer03.png","previewfilepath":"/media/previz/buffer03.png","type":"buffer","channel":0,"sampler":{"filter":"linear","wrap":"clamp","vflip":"true","srgb":"false","internal":"byte"},"published":1},{"id":"XdfGR8","filepath":"/media/previz/buffer03.png","previewfilepath":"/media/previz/buffer03.png","type":"buffer","channel":1,"sampler":{"filter":"mipmap","wrap":"clamp","vflip":"true","srgb":"false","internal":"byte"},"published":1}],"outputs":[{"id":"4dXGR8","channel":0}],"code":"void mainImage( out vec4 fragColor, in vec2 fragCoord )\n{\n    if (iFrame == 0 || keyDown(32))\n    {\n        fragColor = vec4(0.0, 0.0, 0.0, 1.0);\n    }\n    else\n    {\n        ivec2 coord = ivec2(fragCoord);\n        \n        evolveByCells(iChannel0, coord, ivec2(0), ivec2(iResolution.xy), fragColor);\n        spawnSand(iFrame, fragCoord, iResolution, iMouse, fragColor);\n        removeSand(iChannel1, iFrame, fragCoord, iResolution, iMouse, fragColor);\n    }\n}","name":"Buffer A","description":"","type":"buffer"},{"inputs":[],"outputs":[],"code":"const int COLOR_CYCLE_FRAMES = 6000;\n\nfloat length2(vec2 x)\n{\n    return dot(x, x);\n}\n\nfloat square(float x)\n{\n    return x * x;\n}\n\nvec4 rainbow(int i)\n{\n    switch(i)\n    {\n        case 0:\n            return vec4(1.0, 0.0, 0.0, 1.0);\n        case 1:\n            return vec4(1.0, 0.5, 0.0, 1.0);\n        case 2:\n            return vec4(1.0, 1.0, 0.0, 1.0);\n        case 3:\n            return vec4(0.0, 1.0, 0.0, 1.0);\n        case 4:\n            return vec4(0.0, 0.0, 1.0, 1.0);\n        case 5:\n            return vec4(0.25, 0.0, 0.5, 1.0);\n        case 6:\n            return vec4(0.5, 0.0, 0.7, 1.0);\n    }\n}\n\nconst int COLOR_CHANGE_FRAMES = 200;\nvec4 colorByFrame(int frame)\n{   \n    int colorIndex = (frame / COLOR_CHANGE_FRAMES) % 7;\n    int nextColorIndex = (colorIndex + 1) % 7;\n    int blendIndex = frame % COLOR_CHANGE_FRAMES;\n    float blend = float(blendIndex) / float(COLOR_CHANGE_FRAMES);\n    return mix(rainbow(colorIndex), rainbow(nextColorIndex), blend);\n}\n\nconst float PI = 3.141592653598793;\n\nvec2 rotate(float a)\n{\n    return vec2(sin(a), cos(a));\n}\n\nvoid spawnSand(int frame, vec2 fragCoord, vec3 res, vec4 mouse, inout vec4 fragColor)\n{\n    if (fragColor == vec4(0.0, 0.0, 0.0, 1.0))\n    {\n        float centerSpeedup = (sin(float(frame) * 0.001) * 0.5 + 0.5) * 0.02;\n        float centerTime = (float(frame) * (0.001 + centerSpeedup) - PI * 0.5);\n        vec2 spawnCenter = vec2(sin(centerTime) * 0.45 + 0.5, 0.95) * res.xy;\n        \n        if (mouse.z > 0.0 && mouse.y > res.y * 0.9)\n        {\n            spawnCenter.x = mouse.x;\n        }\n\n        float rotateTime = float(frame) * 0.2;\n        float SPAWN_DISTANCE = res.x * 0.02;\n        vec2 spawnPoints[3] = vec2[](spawnCenter + SPAWN_DISTANCE * rotate(rotateTime),\n                                     spawnCenter + SPAWN_DISTANCE * rotate(rotateTime + PI * (2.0 / 3.0)),\n                                     spawnCenter + SPAWN_DISTANCE * rotate(rotateTime - PI * (2.0 / 3.0)));\n\n        for (int i = 0; i < 3; ++i)\n        {\n            if (length2(spawnPoints[i] - fragCoord) < square(res.x * 0.003))\n            {\n                fragColor = colorByFrame(frame + COLOR_CHANGE_FRAMES * i);\n            }\n        }\n    }\n}\n\nconst vec4 EMPTY = vec4(0.0, 0.0, 0.0, 1.0);\n\nvoid removeSand(sampler2D mipSampler, int frame, vec2 fragCoord, vec3 res, vec4 mouse, inout vec4 fragColor)\n{\n    if (mouse.z > 0.0 && mouse.y < res.y * 0.9)\n    {\n        vec2 removePos = mouse.xy;\n\n        if (length2(removePos - fragCoord) < square(res.x * 0.02))\n        {\n            fragColor = EMPTY;\n        }\n    }\n    \n    vec3 fullTest0 = textureLod(mipSampler, vec2(0.2, 0.6), 3.0).xyz;\n    vec3 fullTest1 = textureLod(mipSampler, vec2(0.4, 0.4), 3.0).xyz;\n    vec3 fullTest2 = textureLod(mipSampler, vec2(0.6, 0.4), 3.0).xyz;\n    vec3 fullTest3 = textureLod(mipSampler, vec2(0.8, 0.6), 3.0).xyz;\n    \n    int deleteInterval = 1000;\n    if (any(greaterThan(fullTest0, vec3(0))) &&\n        any(greaterThan(fullTest1, vec3(0))) &&\n        any(greaterThan(fullTest2, vec3(0))) &&\n        any(greaterThan(fullTest3, vec3(0))))\n    {\n        deleteInterval = 10;\n    }\n    \n    if ((frame % deleteInterval == 0) && fragCoord.y < 1.0)\n    {\n        fragColor = EMPTY;\n    }\n    //fragColor = fullTest0;\n}\n\nvoid evolveByCells(sampler2D sampler, ivec2 coord, ivec2 offset, ivec2 ires, out vec4 fragColor)\n{\n    ivec2 cellCoord = (coord - offset) / 2;\n    ivec2 llCell = cellCoord * 2 + offset;\n    ivec2 lrCell = llCell + ivec2(1, 0);\n    ivec2 ulCell = llCell + ivec2(0, 1);\n    ivec2 urCell = llCell + ivec2(1, 1);\n    \n    if (!all(lessThan(urCell, ires)) || (offset != ivec2(0) && (coord.x == 0 || coord.y == 0)))\n    {\n        fragColor = texelFetch(sampler, coord, 0);\n        return;\n    }\n    \n    vec4 ulValue = texelFetch(sampler, ulCell, 0);\n    vec4 urValue = texelFetch(sampler, urCell, 0);\n    vec4 llValue = texelFetch(sampler, llCell, 0);\n    vec4 lrValue = texelFetch(sampler, lrCell, 0);\n    ulValue.w = urValue.w = llValue.w = lrValue.w = 1.0;\n    \n    bvec4 cell = bvec4(ulValue != EMPTY, urValue != EMPTY, llValue != EMPTY, lrValue != EMPTY);\n    \n    if (cell == bvec4(true,  false,\n                      false, false) ||\n        cell == bvec4(true,  false,\n                      false, true)||\n        cell == bvec4(true,  true,\n                      false, true))\n    {\n        // left side falls\n        llValue = ulValue;\n        ulValue = EMPTY;\n    }\n    else if (cell == bvec4(false, true,\n                           false, false) ||\n             cell == bvec4(false, true,\n                           true, false) ||\n             cell == bvec4(true, true,\n                           true, false))\n    {\n        // right side falls\n        lrValue = urValue;\n        urValue = EMPTY;\n    }\n    else if (cell == bvec4(true, true,\n                           false, false))\n    {\n        // both sides fall\n        lrValue = urValue;\n        urValue = EMPTY;\n        llValue = ulValue;\n        ulValue = EMPTY;\n    }\n    else if (cell == bvec4(true, false,\n                           true, false))\n    {\n        // left side collapses\n        lrValue = ulValue;\n        ulValue = EMPTY;\n    }\n    else if (cell == bvec4(false, true,\n                           false, true))\n    {\n        // right side collapses\n        llValue = urValue;\n        urValue = EMPTY;\n    }\n\n    if (coord == llCell)\n    {\n        fragColor = llValue;\n    }\n    else if (coord == lrCell)\n    {\n        fragColor = lrValue;\n    }\n    else if (coord == ulCell)\n    {\n        fragColor = ulValue;\n    }\n    else if (coord == urCell)\n    {\n        fragColor = urValue;\n    }\n}\n\n#define keyClick(ascii)   ( texelFetch(iChannel3,ivec2(ascii,1),0).x > 0.)\n#define keyDown(ascii)    ( texelFetch(iChannel3,ivec2(ascii,0),0).x > 0.)\n","name":"Common","description":"","type":"common"},{"inputs":[{"id":"4dXGRr","filepath":"/presets/tex00.jpg","previewfilepath":"/presets/tex00.jpg","type":"keyboard","channel":3,"sampler":{"filter":"linear","wrap":"clamp","vflip":"true","srgb":"false","internal":"byte"},"published":1},{"id":"4dXGR8","filepath":"/media/previz/buffer00.png","previewfilepath":"/media/previz/buffer00.png","type":"buffer","channel":0,"sampler":{"filter":"linear","wrap":"clamp","vflip":"true","srgb":"false","internal":"byte"},"published":1},{"id":"4dXGR8","filepath":"/media/previz/buffer00.png","previewfilepath":"/media/previz/buffer00.png","type":"buffer","channel":1,"sampler":{"filter":"mipmap","wrap":"clamp","vflip":"true","srgb":"false","internal":"byte"},"published":1}],"outputs":[{"id":"XsXGR8","channel":0}],"code":"void mainImage( out vec4 fragColor, in vec2 fragCoord )\n{\n    if (iFrame == 0 || keyDown(32))\n    {\n        fragColor = vec4(0.0, 0.0, 0.0, 1.0);\n    }\n    else\n    {\n        ivec2 coord = ivec2(fragCoord);\n        \n        evolveByCells(iChannel0, coord, ivec2(1), ivec2(iResolution.xy), fragColor);\n        spawnSand(iFrame, fragCoord, iResolution, iMouse, fragColor);\n        removeSand(iChannel1, iFrame, fragCoord, iResolution, iMouse, fragColor);\n    }\n}","name":"Buffer B","description":"","type":"buffer"},{"inputs":[{"id":"4dXGRr","filepath":"/presets/tex00.jpg","previewfilepath":"/presets/tex00.jpg","type":"keyboard","channel":3,"sampler":{"filter":"linear","wrap":"clamp","vflip":"true","srgb":"false","internal":"byte"},"published":1},{"id":"XsXGR8","filepath":"/media/previz/buffer01.png","previewfilepath":"/media/previz/buffer01.png","type":"buffer","channel":0,"sampler":{"filter":"linear","wrap":"clamp","vflip":"true","srgb":"false","internal":"byte"},"published":1},{"id":"XsXGR8","filepath":"/media/previz/buffer01.png","previewfilepath":"/media/previz/buffer01.png","type":"buffer","channel":1,"sampler":{"filter":"mipmap","wrap":"clamp","vflip":"true","srgb":"false","internal":"byte"},"published":1}],"outputs":[{"id":"4sXGR8","channel":0}],"code":"void mainImage( out vec4 fragColor, in vec2 fragCoord )\n{\n    if (iFrame == 0 || keyDown(32))\n    {\n        fragColor = vec4(0.0, 0.0, 0.0, 1.0);\n    }\n    else\n    {\n        ivec2 coord = ivec2(fragCoord);\n        \n        evolveByCells(iChannel0, coord, ivec2(0), ivec2(iResolution.xy), fragColor);\n        spawnSand(iFrame, fragCoord, iResolution, iMouse, fragColor);\n        removeSand(iChannel1, iFrame, fragCoord, iResolution, iMouse, fragColor);\n    }\n}","name":"Buffer C","description":"","type":"buffer"},{"inputs":[{"id":"4dXGRr","filepath":"/presets/tex00.jpg","previewfilepath":"/presets/tex00.jpg","type":"keyboard","channel":3,"sampler":{"filter":"linear","wrap":"clamp","vflip":"true","srgb":"false","internal":"byte"},"published":1},{"id":"4sXGR8","filepath":"/media/previz/buffer02.png","previewfilepath":"/media/previz/buffer02.png","type":"buffer","channel":0,"sampler":{"filter":"linear","wrap":"clamp","vflip":"true","srgb":"false","internal":"byte"},"published":1},{"id":"4sXGR8","filepath":"/media/previz/buffer02.png","previewfilepath":"/media/previz/buffer02.png","type":"buffer","channel":1,"sampler":{"filter":"mipmap","wrap":"clamp","vflip":"true","srgb":"false","internal":"byte"},"published":1}],"outputs":[{"id":"XdfGR8","channel":0}],"code":"void mainImage( out vec4 fragColor, in vec2 fragCoord )\n{\n    if (iFrame == 0 || keyDown(32))\n    {\n        fragColor = vec4(0.0, 0.0, 0.0, 1.0);\n    }\n    else\n    {\n        ivec2 coord = ivec2(fragCoord);\n        \n        evolveByCells(iChannel0, coord, ivec2(1), ivec2(iResolution.xy), fragColor);\n        spawnSand(iFrame, fragCoord, iResolution, iMouse, fragColor);\n        removeSand(iChannel1, iFrame, fragCoord, iResolution, iMouse, fragColor);\n    }\n}","name":"Buffer D","description":"","type":"buffer"}]}