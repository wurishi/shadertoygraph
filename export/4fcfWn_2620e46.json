{"ver":"0.1","info":{"id":"4fcfWn","date":"1732900882","viewed":216,"name":"Tears for Spheres","username":"wyatt","description":"lighting","likes":15,"published":3,"flags":32,"usePreview":0,"tags":["lighting"],"hasliked":0,"parentid":"","parentname":""},"renderpass":[{"inputs":[{"id":"XsXGR8","filepath":"/media/previz/buffer01.png","previewfilepath":"/media/previz/buffer01.png","type":"buffer","channel":0,"sampler":{"filter":"linear","wrap":"clamp","vflip":"true","srgb":"false","internal":"byte"},"published":1},{"id":"XdfGR8","filepath":"/media/previz/buffer03.png","previewfilepath":"/media/previz/buffer03.png","type":"buffer","channel":1,"sampler":{"filter":"linear","wrap":"clamp","vflip":"true","srgb":"false","internal":"byte"},"published":1}],"outputs":[{"id":"4dfGRr","channel":0}],"code":"Main {\n\n    Q = A(U)*.7+.03*B(U);\n\n}","name":"Image","description":"","type":"image"},{"inputs":[],"outputs":[],"code":"#define s 5.\n#define R iResolution.xy\n#define pi 3.141592653897\n#define Main void mainImage(out vec4 Q,in vec2 U)\n#define A(U) texture(iChannel0,(U)/R)\n#define B(U) texture(iChannel1,(U)/R)\nvec2 sphere (vec3 p, vec3 d, float r) {\n\n    // (p+dx)^2=r^2\n    // pp-rr + 2pdx + xx = 0\n    \n    float c = dot(p,p)-r*r;\n    float b = 2.*dot(p,d);\n    float det = b*b-4.*c;\n    if (det < 0.) return vec2(-1);\n    return 0.5*(-b+vec2(-1,1)*sqrt(det));\n}\nfloat plane (vec3 p, vec3 d, vec3 n) {\n    \n    // p + dx . n = 0\n    // p.n + d.n x = 0\n    // x = -p.n/d.n\n    \n    return -dot(p,n)/dot(d,n);\n    \n}\nvec4 hash(vec4 p4)\n{\n    p4 = fract(p4  * vec4(.1031, .1030, .0973, .1099));\n    p4 += dot(p4, p4.wzxy+33.33);\n    return fract((p4.xxyz+p4.yzzw)*p4.zywx);\n}\n#define ei(a) mat2(cos(a),sin(a),-sin(a),cos(a))","name":"Common","description":"","type":"common"},{"inputs":[{"id":"4dXGR8","filepath":"/media/previz/buffer00.png","previewfilepath":"/media/previz/buffer00.png","type":"buffer","channel":0,"sampler":{"filter":"linear","wrap":"clamp","vflip":"true","srgb":"false","internal":"byte"},"published":1}],"outputs":[{"id":"4dXGR8","channel":0}],"code":"Main {\n    \n    #define O .5\n    Q = A(U);\n    U = 2.*(U+hash(vec4(U,iFrame,1)).xy-.5*R)/R.y;\n    for (int k = 0; k < 5; k++) {\n        \n        vec3 p = vec3(0,0,-2.5);\n        vec3 d = normalize(vec3(U,3));\n        p.yz *= ei(.4);\n        d.yz *= ei(.4);\n        \n    for (float j = 0.; j < 15.; j++) {\n        vec4 h = hash(vec4(R*U,iFrame*10+k,j));\n        float x = -1.;\n        vec3 o = d;\n        { // main sphere\n            vec2 i = sphere(p,o,.8);\n            bool b = false;\n            if (i.x>0.&&(i.x<x||x<0.)) x = i.x, b=true;\n            if (i.y>0.&&(i.y<x||x<0.)) x = i.y, b=true;\n            vec3 m = p+o*x;\n            vec3 n = normalize(m);\n            if (b) d = h.z<.5?reflect(o,n):normalize(o-O*n);\n            \n        }\n        \n        { // inner sphere 1\n            vec2 i = sphere(p-vec3(.4,.2,0),o,.2);\n            bool b = false;\n            if (i.x>0.&&(i.x<x||x<0.)) x = i.x, b=true;\n            if (i.y>0.&&(i.y<x||x<0.)) x = i.y, b=true;\n            vec3 m = p+o*x;\n            vec3 n = normalize(m);\n            if (b) d = h.z<.5?reflect(o,n):normalize(o+O*n);\n            \n        }\n        \n        { // inner sphere 2\n            vec2 i = sphere(p-vec3(-.0,.3,-.5),o,.15);\n            bool b = false;\n            if (i.x>0.&&(i.x<x||x<0.)) x = i.x, b=true;\n            if (i.y>0.&&(i.y<x||x<0.)) x = i.y, b=true;\n            vec3 m = p+o*x;\n            vec3 n = normalize(m);\n            if (b) d = h.z<.5?reflect(o,n):normalize(o+O*n);\n            \n        }\n        \n        { // inner sphere 3\n            vec2 i = sphere(p-vec3(-.3,-.2,-.3),o,.3);\n            bool b = false;\n            if (i.x>0.&&(i.x<x||x<0.)) x = i.x, b=true;\n            if (i.y>0.&&(i.y<x||x<0.)) x = i.y, b=true;\n            vec3 m = p+o*x;\n            vec3 n = normalize(m);\n            if (b) d = h.z<.5?reflect(o,n):normalize(o+O*n);\n            \n        }\n        { // inner sphere 4\n            vec2 i = sphere(p-vec3(.4,-.1,.3),o,.1);\n            bool b = false;\n            if (i.x>0.&&(i.x<x||x<0.)) x = i.x, b=true;\n            if (i.y>0.&&(i.y<x||x<0.)) x = i.y, b=true;\n            vec3 m = p+o*x;\n            vec3 n = normalize(m);\n            if (b) d = h.z<.5?reflect(o,n):normalize(o+O*n);\n            \n        }\n        \n        { // inner sphere 5\n            vec2 i = sphere(p-vec3(0.1,-.4,-.5),o,.15);\n            bool b = false;\n            if (i.x>0.&&(i.x<x||x<0.)) x = i.x, b=true;\n            if (i.y>0.&&(i.y<x||x<0.)) x = i.y, b=true;\n            vec3 m = p+o*x;\n            vec3 n = normalize(m);\n            if (b) d = h.z<.5?reflect(o,n):normalize(o+O*n);\n            \n        }\n        \n        { // backsplash\n            float i = plane(p-vec3(0,0,3 ),o,vec3(0,0,1));\n            if (i>0.&&(i<x||x<0.)) {\n                x = i;\n                vec3 m = p + o*x;\n                d = normalize(h.xyz*2.-1.);\n                    d.z = -abs(d.z);\n                if (sin(10.*m.x)*sin(10.*m.y)<0.) {\n                    d = normalize(reflect(o,vec3(0,0,1))+d);\n                }\n            }\n\n        }\n        \n        { // light\n            float i = plane(p-vec3(0,0,-4),o,vec3(0,0,1));\n            if (i>0.&&(i<x||x<0.)) {\n                x = i;\n                p += o*x;\n                Q += 5.*vec4(3,2,1,1)*float(length(p.xy-vec2(-6,1))<1.);\n                Q += 20.*vec4(1,2,3,1)*float(length(p.xy-vec2(3,-1))<.4);\n                Q += 1.*vec4(1,3,2,1)*float(length(p.xy-vec2(2,8))<2.);\n                break;\n            }\n\n        }\n        if (x>0.) p = p+o*x+d*1e-3;\n    }\n    }\n    \n    \n\n}","name":"Buffer A","description":"","type":"buffer"},{"inputs":[{"id":"4dXGR8","filepath":"/media/previz/buffer00.png","previewfilepath":"/media/previz/buffer00.png","type":"buffer","channel":0,"sampler":{"filter":"linear","wrap":"clamp","vflip":"true","srgb":"false","internal":"byte"},"published":1}],"outputs":[{"id":"XsXGR8","channel":0}],"code":"Main {\n    Q = A(U)/float(iFrame);\n    Q = pow(Q,vec4(.9));\n}","name":"Buffer B","description":"","type":"buffer"},{"inputs":[{"id":"XsXGR8","filepath":"/media/previz/buffer01.png","previewfilepath":"/media/previz/buffer01.png","type":"buffer","channel":0,"sampler":{"filter":"linear","wrap":"clamp","vflip":"true","srgb":"false","internal":"byte"},"published":1}],"outputs":[{"id":"4sXGR8","channel":0}],"code":"Main {\n    Q = vec4(0);\n    for (float i = - 20.; i <= 20.; i++) {\n    \n        Q += A(U+vec2(4.5*i,0))*exp(-0.5*i*i/s/s)*inversesqrt(2.*pi*s*s);\n    \n    }\n\n}","name":"Buffer C","description":"","type":"buffer"},{"inputs":[{"id":"4sXGR8","filepath":"/media/previz/buffer02.png","previewfilepath":"/media/previz/buffer02.png","type":"buffer","channel":0,"sampler":{"filter":"linear","wrap":"clamp","vflip":"true","srgb":"false","internal":"byte"},"published":1}],"outputs":[{"id":"XdfGR8","channel":0}],"code":"Main {\n    Q = vec4(0);\n    for (float i = - 20.; i <= 20.; i++) {\n    \n        Q += A(U+vec2(0,4.5*i))*exp(-0.5*i*i/s/s)*inversesqrt(2.*pi*s*s);\n    \n    }\n\n}","name":"Buffer D","description":"","type":"buffer"}]}