{"ver":"0.1","info":{"id":"4lKGWR","date":"1474145843","viewed":91,"name":"planemarchingcarving-16091701","username":"francisco","description":"Plane carving with ray marching","likes":0,"published":1,"flags":0,"usePreview":0,"tags":["3dreconstruction"],"hasliked":0,"parentid":"","parentname":""},"renderpass":[{"inputs":[],"outputs":[{"id":"4dfGRr","channel":0}],"code":"float sdFloor(vec3 p){\n    return p.y;\n}\nfloat plane(vec3 p,vec3 po,vec3 n){\n    n=normalize(n);\n    vec3 dp=po-p;\n    return dot(dp,n);\n}\nfloat sphere(vec3 p,float r){\n    return length(p)-r;\n}\nfloat line(vec3 p,vec3 po,vec3 n){\n    n=normalize(n);\n    vec3 dp=po-p;\n    vec3 prj_dp=dot(n,dp)*n;\n    vec3 d=dp-prj_dp;\n    return length(d);\n}\nfloat cylinder(vec3 p,vec3 po,vec3 n,float r){\n    return line(p,po,n)-r;\n}\nfloat cone(vec3 p,vec3 po,vec3 n,float dr){\n    n=normalize(n);\n    vec3 dp=po-p;\n    vec3 prj_dp=dot(n,dp)*n;\n    float r=length(prj_dp)*dr;\n    vec3 d=dp-prj_dp;\n    return length(d)-r;\n}\nfloat opU( float d1, float d2 )\n{\n    return min(d1,d2);\n}\n\nfloat opS( float d1, float d2 )\n{\n    return max(-d1,d2);\n}\n\nfloat opI( float d1, float d2 )\n{\n    return max(d1,d2);\n}\nfloat carving(vec3 p){\n    vec3 zero=vec3(0,0,0);\n    float d=0.0;\n    vec3 q0=vec3(1,0,10);\n    for(float alpha=3.1459/3.0;alpha<2.0*3.14159;alpha+=3.1459/3.0){\n        float x=cos(alpha);\n        float y=sin(alpha);\n        vec3 q1=vec3(x,y,10);\n        vec3 v1=q1-q0;\n        vec3 n=normalize(cross(q0,v1));\n        q0=q1;  \n        d=opI(d,plane(p,zero,n));\n    }\n    return d;\n}\nfloat map(vec3 p){\n    vec3 zero=vec3(0.0,0.0,0.0);\n    float p1=plane(p,vec3( 0.0,-1.0, 0.0),vec3( 0, 1, 0));\n    float p2=plane(p,vec3( 0.0, 1.0, 0.0),vec3( 0,-1, 0));\n    float p3=plane(p,vec3( 0.0, 0.0, 1.0),vec3( 0, 0,-1));\n    float p4=plane(p,vec3( 0.0, 0.0,-1.0),vec3( 0, 0, 1));\n    float p5=plane(p,vec3( 1.0, 0.0, 0.0),vec3(-1, 0, 0));\n    float p6=plane(p,vec3(-1.0, 0.0, 0.0),vec3( 1, 0, 0));\n    float c=opI(opI(opI(opI(opI(p3,p4),p2),p1),p5),p6);\n    //carved cube\n    //return opI(opI(opI(opI(opI(p3,p4),p2),p1),p5),p6);\n    return carving(p);\n}\nvec3 grad(vec3 p){\n    vec3 eps = vec3( 0.001, 0.0, 0.0 );\n    float d=map(p);\n\tvec3 g = vec3(\n\t    map(p+eps.xyy) - d,\n\t    map(p+eps.yxy) - d,\n\t    map(p+eps.yyx) - d );\n\treturn g;\n}\nfloat trace(vec3 o,vec3 r){\n    float t=0.0;\n    for(int i=0;i<128;i++){\n        vec3 p=o+r*t;\n        float d=map(p);\n        t+=d*0.95;\n    }\n    return t;\n}\nmat3 setCamera( in vec3 ro, in vec3 ta, float cr )\n{\n\tvec3 cw = normalize(ta-ro);\n\tvec3 cp = vec3(sin(cr), cos(cr),0.0);\n\tvec3 cu = normalize( cross(cw,cp) );\n\tvec3 cv = normalize( cross(cu,cw) );\n    return mat3( cu, cv, cw );\n}\nvoid mainImage( out vec4 fragColor, in vec2 fragCoord )\n{\n\tvec2 uv = fragCoord.xy / iResolution.xy;\n    uv=uv*2.0-1.0;\n    uv.x*=iResolution.x/iResolution.y;\n    vec2 mo = iMouse.xy/iResolution.xy;\n\t\t \n\tfloat time = iTime*0.0;\n\n\t// camera\t\n\tvec3 ro = vec3(3.5*cos(0.1*time + 2.0*3.1459*mo.x), 4.0 - 4.0*mo.y, 3.5*sin(0.1*time + 2.0*3.1459*mo.x) );\n\tvec3 ta = vec3( 0.0, .0, 0.0 );\n\t\n\t// camera-to-world transformation\n    mat3 ca = setCamera( ro, ta, 0.0 );\n    \n    // ray direction\n\tvec3 rd = ca * normalize( vec3(uv.xy,2.0) );\n    vec3 r=normalize(vec3(uv,1.0));\n    float the=iTime;\n    //r.xz*=mat2(cos(the),-sin(the),sin(the),cos(the));\n    vec3 o=vec3(0.0,0.0,-3);\n    float t=trace(ro,rd);\n    vec3 p=ro+rd*t;\n    vec3 l=normalize(vec3(3.0,2.0,-1.0));\n    vec3 n=normalize(grad(p));\n    float dif=dot(l,n);\n    float fog=1.0/(1.0+t*t*0.1);\n    //vec3 fc=vec3(fog);\n    vec3 fc=vec3(dif,dif,0.0);\n\tfragColor = vec4(fc,1.0);\n}","name":"Image","description":"","type":"image"}]}