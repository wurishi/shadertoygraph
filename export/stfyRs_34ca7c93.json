{"ver":"0.1","info":{"id":"stfyRs","date":"1648615302","viewed":343,"name":"Boidsh","username":"komrad36","description":"- CLICK to attract/repel\n- SPACE to toggle traces\n- T to toggle mouse attract vs. repel\n- R to reset\n- P to pause","likes":20,"published":1,"flags":48,"usePreview":0,"tags":["fish","birds","flock","flocking","boids"],"hasliked":0,"parentid":"","parentname":""},"renderpass":[{"inputs":[{"id":"4dXGR8","filepath":"/media/previz/buffer00.png","previewfilepath":"/media/previz/buffer00.png","type":"buffer","channel":0,"sampler":{"filter":"nearest","wrap":"clamp","vflip":"true","srgb":"false","internal":"byte"},"published":1}],"outputs":[{"id":"4dfGRr","channel":0}],"code":"void mainImage(out vec4 c, in vec2 f)\n{\n    c = vec4(vec3(0.0), 1.0);\n    uint j = 0u;\n    for (uint i = 1u; i <= kNumBoids; ++i)\n    {\n        vec4 v = texelFetch(iChannel0, ivec2(i & 63u, i >> 6u), 0);\n        vec2 g = f - v.xy;\n        vec2 w = normalize(v.zw);\n        vec2 d = clamp(dot(g, w), -0.5 * kBoidLen, 0.5 * kBoidLen) * w - g;\n        j = dot(d, d) < 1.1 ? i : j;\n    }\n    if (j == 0u)\n    {\n        if (texelFetch(iChannel0, ivec2(0), 0).y != 0.0)\n            discard;\n        return;\n    }\n    vec2 v = texelFetch(iChannel0, ivec2(j & 63u, j >> 6u), 0).zw;\n    float h = atan(v.y, v.x) * (6.0/6.28318530718);\n    c.xyz = clamp(abs(mod(h + vec3(0.0, 4.0, 2.0), 6.0) - 3.0) - 1.0, 0.0, 1.0);\n}\n","name":"Image","description":"","type":"image"},{"inputs":[],"outputs":[],"code":"const uint kNumBoids = 1500u;\nconst float kBoidLen = 11.0;\nconst float kInitialVel = 50.0;\nconst float kMaxVel = 150.0;\nconst float kNeighborDist = 78.0;\nconst float kRepelFactor = 200.0;\nconst float kCmFactor = 11.0;\nconst float kAlignFactor = 0.39;\nconst float kMouseFactor = 300.0;","name":"Common","description":"","type":"common"},{"inputs":[{"id":"4dXGRr","filepath":"/presets/tex00.jpg","previewfilepath":"/presets/tex00.jpg","type":"keyboard","channel":1,"sampler":{"filter":"nearest","wrap":"clamp","vflip":"true","srgb":"false","internal":"byte"},"published":1},{"id":"4dXGR8","filepath":"/media/previz/buffer00.png","previewfilepath":"/media/previz/buffer00.png","type":"buffer","channel":0,"sampler":{"filter":"nearest","wrap":"clamp","vflip":"true","srgb":"false","internal":"byte"},"published":1}],"outputs":[{"id":"4dXGR8","channel":0}],"code":"float rand(float x)\n{\n    return fract(sin(mod(x*91.3458, 6.28318530718)) * 47453.5453);\n}\n\nfloat srand(float x)\n{\n    return 2.0*rand(x) - 1.0;\n}\n\nvec2 dist(in vec2 c1, in vec2 c2)\n{\n\tvec2 d = c2 - c1;\n    vec2 s = abs(d);\n    vec2 w = iResolution.xy - s;\n    uvec2 r = (floatBitsToUint(d) ^ floatBitsToUint(w - s)) & 0x80000000U;\n    return uintBitsToFloat(floatBitsToUint(min(s, w)) ^ r);\n}\n\nvoid mainImage(out vec4 c, in vec2 f)\n{\n    uvec2 xy = uvec2(f.x, f.y);\n    uint i = (xy.y << 6u) + xy.x;\n    if (i > kNumBoids)\n        return;\n        \n    c = vec4(1.0, 0.0, 0.0, 1.0);\n    if (iFrame != 0)\n        c = texelFetch(iChannel0, ivec2(0), 0);\n    if (texelFetch(iChannel1, ivec2(80, 1), 0).x != 0.0)\n        c.x = 1.0 - c.x;\n    if (texelFetch(iChannel1, ivec2(32, 1), 0).x != 0.0)\n        c.y = 1.0 - c.y;\n    if (texelFetch(iChannel1, ivec2(82, 1), 0).x != 0.0)\n        c.z = 0.0;\n    if (texelFetch(iChannel1, ivec2(84, 1), 0).x != 0.0)\n        c.w = 1.0 - c.w;\n        \n    if (i == 0u)\n    {\n        c.z = float(kNumBoids);\n        return;\n    }\n    \n    if (i > uint(c.z))\n    {\n        float f = float(i) + iTime;\n        c.xy = iResolution.xy*vec2(rand(f), rand(f + 12.434993));\n        c.zw = kInitialVel*vec2(srand(f + 88.3843329), srand(f + 34930.39907));\n        return;\n    }\n    \n    float mouseDir = 2.0 * c.w - 1.0;\n    float dt = c.x * min(iTimeDelta, 1.0 / 30.0);\n    c = texelFetch(iChannel0, ivec2(xy), 0);\n\tfloat neighbors = 0.0;\n    vec2 cm = vec2(0.0);\n    vec2 rep = vec2(0.0);\n    vec2 al = -c.zw;\n    vec2 E = dist(c.xy, iMouse.xy);\n    c.zw += dt * E * mouseDir * kMouseFactor * float(iMouse.z > 0.0) / sqrt(dot(E, E) + 0.000000001);\n\tfor (uint idx = 1u; idx <= kNumBoids; ++idx)\n    {\n        vec4 v = texelFetch(iChannel0, ivec2(uvec2(idx & 63u, idx >> 6u)), 0);\n\t\tvec2 d = dist(c.xy, v.xy);\n\t\tfloat lenDSqr = dot(d, d) + 0.000000001;\n        float m = step(lenDSqr, kNeighborDist * kNeighborDist);\n        cm += m * d;\n        rep -= m * d / lenDSqr;\n        al += m * v.zw;\n        neighbors += m;\n\t}\n\tc.zw += dt*((kCmFactor*cm + kAlignFactor*al)/neighbors + kRepelFactor*rep);\n\tfloat lenVelSqr = dot(c.zw, c.zw);\n    if (lenVelSqr > kMaxVel*kMaxVel)\n        c.zw *= kMaxVel / sqrt(lenVelSqr);\n    c.xy = mod(c.xy + dt*c.zw, iResolution.xy);\n}","name":"Buffer A","description":"","type":"buffer"}]}