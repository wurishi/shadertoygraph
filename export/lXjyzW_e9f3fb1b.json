{"ver":"0.1","info":{"id":"lXjyzW","date":"1727064290","viewed":70,"name":"Klein bottle 02","username":"shadertoyjiang","description":"It took a lot of time, but the results were not ideal, the lines were uneven, and artifacts were visible in special cases. Some incomplete processing is already very much affecting the speed.","likes":12,"published":1,"flags":0,"usePreview":0,"tags":["klein","bottle"],"hasliked":0,"parentid":"XXBczW","parentname":"Klein bottle 简单克莱茵瓶"},"renderpass":[{"inputs":[],"outputs":[{"id":"4dfGRr","channel":0}],"code":"// 2024-9-23\n// 简单的克莱茵瓶\nfloat tclr;\nbool ctxt, orn;\n#define rot(t) mat2(cos(t), -sin(t), sin(t), cos(t));\nfloat simpleKleinBottle(vec3 pos) {\n        float r1 = 1.,\n                r2 = .8,\n                w1 = r2 + .8,\n                w2 = .3,\n                \n                h1 = 3.1, //2.*cos(iTime)+3.,  \n                h2 = 1.,\n                h = h1 + r1 + h2;\n        \n        orn=true;if(mod(iTime+6.5,8.)<4.) orn=false;\n        if (ctxt) {\n                vec3 q = pos * 2. + .0;\n                q -= round(q);\n                q = abs(q);\n                tclr = min(q.x, min(q.y, q.z));\n                tclr=min(tclr,  abs(length(pos.xz)-(w1+r1+r2+w2))*.3 );\n                //if(abs(pos.y-h)<.2)tclr=min(tclr,  abs(length(pos.xz-vec2(w1,0))-r2)*.01 );                \n                tclr = clamp(exp(-80. * tclr), 0., 1.);\n        }\n        \n        //hf = h1 * .5;\n        vec3 p0 = pos + vec3(0, h1 * .5, 0);\n        float bx = length(p0.xz) - (w1 + r2 + r1 + w2);\n        bx = max(bx, -p0.y);\n        bx = max(bx, p0.y - h);\n        vec3 p;\n        vec2 f;\n        float d1, d2, d3, d4, d5, d=9999.;\n        // 下环\n        f = vec2(length(p0.xz), p0.y) - vec2(w1 + r2 + r1 + w2, h1 * .5);\n        if (f.x > 0.) d5 = abs(length(f) - h1 * .5);\n        else d5 = .1 + abs(f.x);\n        if(orn)d=min(d,d5);\n        // 两竖管\n        p = p0 - vec3(w1, 0, 0);\n        \n        #define E(D) \\\n        f = vec2(length(p.xz), p.y) - vec2(r2, 0);\\\n        if (f.x < r1 && f.y < r1) {\\\n                D = abs(length(f - r1) - r1);\\\n        } else {\\\n                D = min(abs(f.x), abs(f.y));\\\n        }\n        E(d1)\n        p = p0 - vec3(-w1, h1, 0);\n        E(d2)\n        \n        d2 = max(d2, r2 - length((p0 - vec3(w1, 0, 0)).xz)  );\n        \n        d = min(d, max(min(d1, d2), bx));\n        // 上管\n        p = p0 - vec3(0, h, 0);\n        if (p.y > 0.) {\n                d3 = abs(length(vec2(length(p.xy) - w1, p.z)) - r2);\n        } else {\n                d3 = w1;\n        }\n        if(d5<=d)tclr=0.;\n        //if(orn)\n                d = min(d, d3);\n        return d - 1e-3;\n}\nfloat map(vec3 p) {\n        float t = iTime+.78;//+12.3;\n        p.yz *= rot(t * .1);\n        p.xy *= rot(t * .6);\n        p.xz *= rot(t * 2.7);\n        return simpleKleinBottle(p);\n}\nvoid mainImage(out vec4 O, vec2 v) {\n        O = vec4(0.4);\n        vec2 R = iResolution.xy,\n                u = 1. * (v + v + .1 - R) / R.y,\n                m = 1. * (iMouse.xy * 2. - R) / R.y;\n        vec3 o = vec3(0, 0, -12),\n                r = normalize(vec3(u, 2)),\n                e = vec3(0, 1e-3, 0),\n                p, n,\n                s = normalize(vec3(-1, 2, -3));\n        float d, t, f, g, c, xi = 1.;\n        ctxt = false;\n        for (int i; i < 256 && t < 20.; i++) {\n                p = o + r * t;\n                d = map(p);\n                if (d < .01) {\n                        //O *= 0.;\n                        ctxt = true;\n                        float a = map(p + e);\n                        ctxt = false;\n                        n = normalize(vec3(map(p + e.yxx), a, map(p + e.xxy)) - d);\n                        f = .5 + .5 * dot(n, s);\n                        g = max(dot(n, s), 0.);\n                        c = 1. + pow(f, 200.) - f * .3; // 665.352.6.542.9958.8.63\n                        O += (c + tclr) * xi;\n                        xi *= .3;\n                        d = .2;\n                        //return;\n                }\n                t += d;\n        }\n        O *= .5;\n}\n","name":"Image","description":"","type":"image"}]}