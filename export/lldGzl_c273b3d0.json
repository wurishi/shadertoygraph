{"ver":"0.1","info":{"id":"lldGzl","date":"1471021307","viewed":1346,"name":"music sphere","username":"hcf","description":"vertex texture displacement","likes":6,"published":1,"flags":0,"usePreview":0,"tags":["3d","raymarching","distancefunction"],"hasliked":0,"parentid":"","parentname":""},"renderpass":[{"inputs":[{"id":"4dXGzn","filepath":"/media/a/0c7bf5fe9462d5bffbd11126e82908e39be3ce56220d900f633d58fb432e56f5.png","previewfilepath":"/media/ap/0c7bf5fe9462d5bffbd11126e82908e39be3ce56220d900f633d58fb432e56f5.png","type":"texture","channel":0,"sampler":{"filter":"linear","wrap":"repeat","vflip":"true","srgb":"false","internal":"byte"},"published":1},{"id":"4sXGzn","filepath":"/media/a/a6a1cf7a09adfed8c362492c88c30d74fb3d2f4f7ba180ba34b98556660fada1.mp3","previewfilepath":"/media/ap/a6a1cf7a09adfed8c362492c88c30d74fb3d2f4f7ba180ba34b98556660fada1.mp3","type":"music","channel":1,"sampler":{"filter":"linear","wrap":"clamp","vflip":"true","srgb":"false","internal":"byte"},"published":1}],"outputs":[{"id":"4dfGRr","channel":0}],"code":"\n#define MAXSTEP 200.\n#define FAR 200.\n#define EPS 0.01\n#define time iTime\nconst float PI = 3.14159265359;\n\nvec4 SPHERE = vec4(0.,0.,0.,4.);\n\nfloat displacement(vec3 p,float le)\n{\t\n   \tfloat t = .05;\n    t = texture(iChannel1, vec2(0.33, 0.)).x*0.0615;\n\tp = normalize(p);\n    float l = abs(p.x)+abs(p.y)+abs(p.z);\n    float d = (texture(iChannel0,p.yx*t,le)*abs(p.x)+texture(iChannel0,p.zx*t,le)*abs(p.y)+\n               texture(iChannel0,p.xy*t,le)*abs(p.z)).x/(l);\n    \n    return d*0.5-0.5;\n}\n\nfloat displacement_new(vec3 p,float le)\n{\t\n   \tfloat t = .05;\n    t = texture(iChannel1, vec2(0.33, 0.)).x*0.15;\n    p.xz += vec2(1.1);\n\tvec3 n = normalize(p);\n    //n.xz += vec2(1.1,1.1);\n    vec2 uv =  vec2((atan(n.z,n.x)/(1.0 * PI)) , n.y/2.)+vec2(0.6, 0.0)*1.;\n    float d = texture(iChannel0,uv).x;\n    return d*0.5-0.5;\n}\n\nfloat map(vec3 p)\n{\t\n    float t = texture(iChannel1, vec2(0.0, 0.)).x;\n    float r = SPHERE.w + displacement(p,1.)*t*15.;\n\tfloat d = length(p)-r;\n    return d;\n}\nfloat count = 0.;\nfloat raymarch(vec3 ro,vec3 rd)\n{\n\tfloat t = 0.;\n    vec3 p ;\n    for(float i = 0.;i < MAXSTEP;i++)\n    {\n    \tp = ro+rd*t;\n        float d = map(p);\n        t += d*.1;\n        if(abs(d) < EPS || t > FAR) break;\n        count += 1./(1.+d*d);\n    }\n    return t;\n}\n\nvec3 getNormal(vec3 p)\n{\n    float e = 0.03;\n\tfloat d = map(p);\n    vec2 delta = vec2(e,0.);\n    return normalize(\n    \tvec3(\n        \tmap(p+vec3(delta.xyy))-d,\n            map(p+vec3(delta.yxy))-d,\n            map(p+vec3(delta.yyx))-d\n        )\n    );\n}\nvec3 render(vec3 ro,vec3 rd)\n{\n    vec3 lig = normalize(vec3(100.,120.,100.));\n\tvec3 color = vec3(0.);\n    vec3 glow = vec3(.20,0.52,0.2);\n    float d = raymarch(ro,rd);\n    if(d < FAR)\n    {\n        vec3 p = ro+rd*d;\n    \n        vec3 n = getNormal(p);\n        vec3 amb = vec3(0.2);\n        float dif = clamp(dot(n,lig),0.,1.);\n        float spe = clamp(dot(normalize(reflect(rd,n)),lig),0.,1.);\n        spe = pow(spe,10.);\n        \n        vec3 f = clamp(dif*vec3(1.)*0.+amb*1.,0.,1.);\n        vec3 mat = vec3(.20,0.52,0.2)*f + +.1*spe*vec3(1.);                  \n        color = mat;\n        \n        float l = 1./pow(length(p),1.)*15.2;\n        color = color*l;\n    }else{\n        color = glow*exp(-1./(1.+count)*10.1);\n    } \n    \n    return color;\n}\nmat3 setCamera(vec3 ro,vec3 tar,float a)\n{\n\tvec3 z = normalize(tar-ro);\n    vec3 y = vec3(sin(a),cos(a),0.);\n    vec3 x = normalize(cross(y,z));\n    y = normalize(cross(z,x));\n    return mat3(-x,y,z);\n}\nvoid mainImage( out vec4 fragColor, in vec2 fragCoord )\n{\n\tvec2 uv = (fragCoord.xy*2.-iResolution.xy) / iResolution.y;\n    \n    float r = 8.;\n    vec3 ro = vec3(sin(time*1.)*r,0.,cos(time*1.)*r);\n    vec3 rd = vec3(uv,2.);\n    vec3 tar = vec3(0.);\n    \n    rd = setCamera(ro,tar,0.)*normalize(rd);\n    \n    vec3 color = vec3(0.);\n    color = render(ro,rd);\n    \n\tfragColor = vec4(color,1.0);\n}","name":"Image","description":"","type":"image"}]}