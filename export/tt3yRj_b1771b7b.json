{"ver":"0.1","info":{"id":"tt3yRj","date":"1609454549","viewed":343,"name":"Shader Royale #3","username":"sp4ghet","description":"My final submission for Shader Royale #3. Which placed third.\n\nShoutout to: \nhttps://www.shadertoy.com/view/MsjSW3\n","likes":6,"published":1,"flags":0,"usePreview":0,"tags":["livecode","hogmanay"],"hasliked":0,"parentid":"","parentname":""},"renderpass":[{"inputs":[{"id":"XsX3Rn","filepath":"/media/a/92d7758c402f0927011ca8d0a7e40251439fba3a1dac26f5b8b62026323501aa.jpg","previewfilepath":"/media/ap/92d7758c402f0927011ca8d0a7e40251439fba3a1dac26f5b8b62026323501aa.jpg","type":"texture","channel":1,"sampler":{"filter":"mipmap","wrap":"repeat","vflip":"true","srgb":"false","internal":"byte"},"published":1},{"id":"XsXGzn","filepath":"/media/a/29de534ed5e4a6a224d2dfffab240f2e19a9d95f5e39de8898e850efdb2a99de.mp3","previewfilepath":"/media/ap/29de534ed5e4a6a224d2dfffab240f2e19a9d95f5e39de8898e850efdb2a99de.mp3","type":"music","channel":0,"sampler":{"filter":"linear","wrap":"clamp","vflip":"true","srgb":"false","internal":"byte"},"published":1}],"outputs":[{"id":"4dfGRr","channel":0}],"code":"#define texFFTSmoothed iChannel0\n#define texNoise iChannel1\n#define time iTime\n\nconst float PI = 3.14159265;\nconst float TAU = 2.*PI;\nconst vec3 up = vec3(0,1.,0);\n\nmat2 r2d(float t){\n  float c = cos(t), s = sin(t);\n  return mat2(c,s,-s,c);\n}\n\nfloat mapbg(vec3 q){\n  vec3 p=q;\n  p *= 2.;\n  p.xy *= r2d(time*TAU*.01);\n  float ns = sin(p.x+sin(p.y+sin(p.z)));\n  q += ns;\n  return length(q) - 1.;\n}\nvec3 grad(float t){\n  float bass = texture(texFFTSmoothed, vec2(.003)).r*3.;\n  t += time*.01;\n  t += bass;\n  vec3 a = vec3(.5), b = a, c = vec3(.2, .6, .4), d = vec3(.3,.7,.8);\n  return a + b*cos(TAU*(c*t + d));\n}\n\nvoid chmin(inout vec4 d, vec4 o){\n  d=d.x<o.x?d:o;\n}\nfloat box(vec3 p, vec3 b){\n  p = abs(p) - b;\n  return length(max(vec3(0), p)) + min(0., max(p.x, max(p.y,p.z)));\n}\n\n\nvec4 map(vec3 q){\n  float bass = texture(texFFTSmoothed, vec2(.003)).r;\n  vec3 p = q;\n  vec4 d = vec4(1000., 0,0,0);\n  \n  float t = time*TAU*.03;\n  float scale = 1.4;\n  float mul = scale-1.;\n  const int iter = 5;\n  mat2 rxy = r2d(t*.13 + PI*.23);\n  mat2 ryz = r2d(t*.213 + PI*.39);\n  mat2 rxz = r2d(t*.33 + PI*.13);\n  \n  for(int i=0; i < iter; i++){\n    p.xy *= rxy;\n    p.yz *= ryz;\n    p.xz *= rxz;\n    p= abs(p);\n    \n    if(p.x<p.y) p.xy=p.yx;\n    if(p.x<p.z) p.xz=p.zx;\n    if(p.y<p.z) p.yz=p.zy;\n    \n    p.z -= .5*mul;\n    p.z = -abs(p.z);\n    p.z += .5*mul;\n    \n    p *= scale;\n    p.xy -= mul;\n  }\n  \n  float bx = box(p, vec3(1));\n  bx *= pow(scale, -float(iter));\n  float col = p.y;\n  p=q;\n  bx = mix(length(p)-1., bx, bass);\n  \n  chmin(d, vec4(bx, 1, .99, col*8.));\n  \n  p=q;\n  vec2 uv = p.xz / 75.;\n  float ns = texture(texNoise, uv).g;\n  ns = texture(texNoise, uv + ns + t + bass*.1).g * .2;\n  p += ns;\n  float pl = p.y + 1.3;\n  chmin(d, vec4(pl,1,0.5,p.y*50.));\n  \n  p=q;\n  float id = floor(length(p.xz)/5. + 1.);\n  p.xz *= r2d(t*id);\n  \n  p.xz = length(p.xz)<25.?mod(p.xz, 5.)-2.5:p.xz;\n  p.y = abs(p.y) - 1.;\n  \n  p.xy *= r2d(bass*id);\n  p.yz *= r2d(bass*(1.-id) + PI*.1);\n  \n  vec2 hw = vec2(.5, .05);\n  bx = box(p, hw.xyy);\n  bx = min(bx, box(p, hw.yxy));\n  bx = min(bx, box(p, hw.yyx));\n  chmin(d, vec4(bx, 0, .5, 0));\n  \n  return d;\n}\n\nvec3 normal(vec3 p){\n  vec2 e = vec2(.00368,0);\n  return normalize(vec3(\n  map(p+e.xyy).x - map(p-e.xyy).x,\n  map(p+e.yxy).x - map(p-e.yxy).x,\n  map(p+e.yyx).x - map(p-e.yyx).x\n  ));\n}\n\nvec3 lighting(vec3 p, vec3 n, vec3 v, vec4 light, vec4 d, vec3 bg){\n  vec3 c;\n  vec3 l = light.xyz - p;\n  float r = length(l);\n  l /= r;\n  float lint = light.a / (r*r);\n  float atten = max(.1, dot(n,l));\n  vec3 albedo = d.y==1.?grad(d.a):vec3(.5);\n  vec3 h = normalize(l+v);\n  float alpha = d.z;\n  float bp = pow(max(0.,dot(n,h)), 25.);\n  float schlick = (1.-alpha)+alpha*pow(1.-dot(n,v), 5.);\n  c += albedo*mix(1., bp, alpha);\n  c *= atten;\n  c += schlick*alpha*.005;\n  c *= lint;\n  return c;\n}\n\n\nvec3 post(vec2 uv, vec3 c){\n  float bass = texture(texFFTSmoothed, vec2(.003)).r*TAU;\n  if(abs(length(uv) - bass*.05 - .25) < .03) c = vec3(1.) - c;\n  float mask = uv.x + uv.y*bass*.3;\n  if(mask < 0.) c = vec3(1.) - c;\n  \n  return c;\n}\n\nvoid mainImage(out vec4 fragColor, in vec2 fragCoord)\n{\n  vec2 uv = vec2(fragCoord.x / iResolution.x, fragCoord.y / iResolution.y);\n  uv -= 0.5;\n  uv /= vec2(iResolution.y / iResolution.x, 1);\n  \n  vec3 c;\n  vec3 ro = vec3(0);\n  ro += vec3(0,-.5, 0);\n  float beat = time*.4;\n  float beatprg = mod(beat, 1.);\n  float beatid = floor(beat);\n  float ct = time*PI*.01 + TAU*.5*smoothstep(0., 1., pow(beatprg, 50.));\n  ro += 5. * vec3(cos(ct), 0., sin(ct));\n  vec3 focus = vec3(0);\n  vec3 rov = normalize(focus - ro);\n  vec3 cu = normalize(cross(rov,up));\n  vec3 cv = cross(cu, rov);\n  vec3 rd = mat3(cu,cv,rov) * normalize(vec3(uv, 1));\n  \n  float t = 0., bgd = 0., acc = 0.;\n  vec3 p = ro;\n  \n  float sound = texture(texFFTSmoothed, vec2(.003)).r*.5;\n  vec2 pt = mix(uv, floor(uv*25.)/25., smoothstep(0., 1., sound));\n  rd = mat3(cu,cv,rov) * normalize(vec3(pt,1));\n  for(int i=0;i<9;i++){\n    p = ro + rd*t;\n    bgd = mapbg(p);\n    t += bgd;\n    acc += clamp(bgd - mapbg(p-rd*.05), -.03, 1.);\n  }\n  vec3 bg = grad(acc);\n  c = bg;\n  c=pow(c, vec3(2.2));\n  \n  t=0.;\n  vec4 d;\n  rd = mat3(cu,cv,rov) * normalize(vec3(uv, 1));\n  for(int i=0; i<128; i++){\n    p = ro+rd*t;\n    d = map(p);\n    t += d.x*.666;\n    if(d.x<.01) break;\n  }\n  \n  vec4 l1 = vec4(3., 0., 0., 10);\n  vec4 l2 = vec4(-3., -.5, 2., 10);\n  vec4 l3 = vec4(3., 0., 2., 8);\n  \n  if(d.x<.01){\n    c *= 0.;\n    vec3 n = normal(p);\n    c += lighting(p,n,-rd,l1,d,bg);\n    c += lighting(p,n,-rd,l2,d,bg);\n    c += lighting(p,n,-rd,l3,d,bg);\n    \n    float ao=0., st=.05;\n    for(int i=1; i<=10;i++){\n      ao += clamp(map(p+n*st*float(i)).x/(st*float(i)), 0., .1);\n    }\n    c *= ao;\n  }\n  \n  c = pow(c, vec3(.45454));\n  \n  fragColor = vec4(c,1.);\n}","name":"Image","description":"","type":"image"}]}