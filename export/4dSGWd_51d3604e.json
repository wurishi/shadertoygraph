{"ver":"0.1","renderpass":[{"outputs":[],"inputs":[],"code":"#define PI 3.14159265359\n#define MAX_ITER 128\n#define MAX_ITER_INTERNAL 0\n#define MAX_ITER_SHADOW 32\n#define MAX_DIST_SHADOW 10.0\n#define MIN_DIST_SHADOW 0.1\n#define MAX_DIST 1000.0\n#define MIN_DIST 0.0001\n#define FOV 0.75\n#define SPECULAR 5.0\n#define SAMPLE_RADIUS 0.001\n#define PENUMBRA 5.0\n#define MULTISAMPLE 4\nstruct screen{\n\tvec2 p;\n\tvec2 r;\n\tvec2 m;\n\tfloat t;\n};\nstruct ray{\n\tvec4 c;\n\tvec3 p;\n\tvec3 d;\n\tvec3 n;\n\tfloat t;\n\tint i;\n};\nstruct light{\n\tvec4 c;\n\tvec3 p;\n};\nlight l=light(\n\tvec4(0.5),\n\tvec3(0.0,-5.0,5.0)\n);\nvec4 a=vec4(0.5);\nfloat s;\nvoid srand(vec2 p){\n\ts=sin(dot(p,vec2(423.62431,321.54323)));\n}\nfloat rand(){\n\ts=fract(s*32322.65432+0.12333);\n\treturn abs(fract(s));\n}\nmat2 rot2d(float a){\n\tfloat c=cos(a);\n\tfloat s=sin(a);\n\treturn mat2(\n\t\tc,-s,\n\t\ts, c);\n}\nmat3 rot_x(float a){\n\tfloat c=cos(a);\n\tfloat s=sin(a);\n\treturn mat3(\n\t\t1.0,0.0,0.0,\n\t\t0.0,  c, -s,\n\t\t0.0,  s,  c);\n}\nmat3 rot_y(float a){\n\tfloat c=cos(a);\n\tfloat s=sin(a);\n\treturn mat3(\n\t\tc,  0.0,  s,\n\t\t0.0,1.0,0.0,\n\t\t-s, 0.0,  c);\n}\nmat3 rot_z(float a){\n\tfloat c=cos(a);\n\tfloat s=sin(a);\n\treturn mat3(\n\t\t  c, -s,0.0,\n\t\t  s,  c,0.0,\n\t    0.0,0.0,1.0);\n}\nmat3 rot(vec3 z,float a){\n\tfloat c=cos(a);\n\tfloat s=sin(a);\n\tfloat b=1.0-c;\n\treturn mat3(\n\t\tb*z.x*z.x+c,b*z.x*z.y-z.z*s,b*z.z*z.x+z.y*s,\n\t\tb*z.x*z.y+z.z*s,b*z.y*z.y+c,b*z.y*z.z-z.x*s,\n\t\tb*z.z*z.x-z.y*s,b*z.y*z.z+z.x*s,b*z.z*z.z+c);\n}\nfloat expstep(float x,float k,float n){\n\treturn exp(-k*pow(x,n));\n}\nfloat smin(float a,float b,float k){\n\tfloat h=clamp(0.5+0.5*(b-a)/k,0.0,1.0);\n    return mix(b,a,h)-k*h*(1.0-h);\n}\nfloat dome(inout ray r){\n\tfloat d=dot(r.p,vec3(0.0,0.0,1.0))+0.5;\n\td=smin(d,50.0-length(r.p),10.0);\n\tif(d<0.0){\n\t\tif(fract(r.p.x)<0.5){\n\t\t\tr.c=vec4(0.0);\n\t\t}else{\n\t\t\tr.c=vec4(1.0);\n\t\t}\t\t\n\t\tr.i=MAX_ITER_INTERNAL+1;\n\t}\n\treturn d;\n}\nfloat box(inout ray r){\n\tfloat d=max(max(abs(r.p.x),abs(r.p.y))-0.5,abs(r.p.z)-0.5);\n\tif(d<0.0){\n\t\tif(fract(length(r.p)*10.0+0.25)<0.5)r.c=vec4(1.0);\n\t\telse r.c=vec4(0.5);\n\t\tr.i=MAX_ITER_INTERNAL+1;\n\t}\n\treturn d;\n}\nfloat sphere(inout ray r){\n\tfloat d=length(r.p)-0.5;\t\n\tif(d<0.0){\n\t\tr.c=vec4(1.0);\n\t\tr.i++;\n\t}\n\treturn d;\n}\nfloat morph(inout ray r,vec3 o){\n\tvec3 p=r.p+o;\n\tfloat t=r.t/10.0;\n\tfloat d=0.0;\n\tt=fract(t);\n\t\n\t#define NUM_MORPH 4.0\t\n\tfloat sphere=length(p)-0.5;\n\tfloat box=max(abs(p.x),max(abs(p.y),abs(p.z)))-0.5;\n\tfloat octa=dot(abs(p),normalize(vec3(1.0)))-0.29;\n\tfloat torus=length(vec2(length(p.xz)-0.25,p.y))-0.125;\n\t\t\n\td+=max((NUM_MORPH*(abs(t-0.5))-0.5*(NUM_MORPH-2.0)),0.0)*octa;\n\td+=max((1.0-NUM_MORPH*abs(t-1.0/NUM_MORPH)),0.0)*sphere;\n\td+=max((1.0-NUM_MORPH*abs(t-2.0/NUM_MORPH)),0.0)*box;\n\td+=max((1.0-NUM_MORPH*abs(t-3.0/NUM_MORPH)),0.0)*torus;\n\t\n\tif(d<0.0){\n\t\tif(fract(r.p.y*10.0)<0.5){\n\t\t\tr.c=vec4(0.0);\n\t\t}else{\n\t\t\tr.c=vec4(1.0);\n\t\t}\t\t\n\t\tr.i=MAX_ITER_INTERNAL+1;\n\t}\n\treturn d;\n}\nfloat dist(inout ray r){\n\tfloat d=MAX_DIST;\n\td=min(d,dome(r));\n\td=min(d,morph(r,vec3(0.0)));\n\treturn d;\n}\nvoid normal(inout ray r){\n\tfloat d=dist(r);\n\tvec3 n=vec3(SAMPLE_RADIUS,0.0,0.0);\n\tray r0=r;\n\tray r1=r;\n\tray r2=r;\n\tr0.p+=n.xyy;\n\tr1.p+=n.yxy;\n\tr2.p+=n.yyx;\n\tr.n=normalize(vec3(dist(r0)-d,dist(r1)-d,dist(r2)-d));\n}\nvec4 ambient(ray r){\n\treturn r.c*a;\n}\nvec4 diffuse(ray r){\n\tvec3 v=l.p-r.p;\n\treturn clamp(r.c*l.c*dot(r.n,normalize(v)),0.0,1.0);\n}\nvec4 specular(ray r){\n\tfloat d=length(l.p-r.p);\n\tvec3 v=normalize(l.p-r.p);\n\treturn l.c*max(pow(dot(v,reflect(r.d,r.n)),SPECULAR),0.0);\n}\nvec4 shadow(ray r){\n\tfloat s=1.0;\n\tfloat t=MIN_DIST_SHADOW;\n\tfor(int i=0;i<MAX_ITER_SHADOW;i++){\n\t\tray tmp=r;\n\t\ttmp.p+=r.d*t;\n\t\tfloat h=dist(tmp);\n\t\tif(h<MIN_DIST)return vec4(0.0);\n\t\ts=min(s,PENUMBRA*h/t);\n\t\tt+=h;\n\t\tif(t>MAX_DIST_SHADOW)break;\n\t}\n\treturn vec4(1.0)*s;\n}\nvec4 trace(inout ray r){\n\tr.c=vec4(1.0);\n\tfor(int i=0;i<MAX_ITER;i++){\n\t\tfloat d=dist(r);\n\t\tif(r.i>MAX_ITER_INTERNAL)break;\n\t\tr.p+=r.d*max(d,MIN_DIST);\n\t}\n\tif(r.i==0){\n\t\tif(fract(r.p.x)<0.5){\n\t\t\tr.c=vec4(0.0);\n\t\t}else{\n\t\t\tr.c=vec4(1.0);\n\t\t}\n\t}\n\tnormal(r);\n\tray tmp=r;\n\ttmp.d=normalize(l.p-r.p);\n\ttmp.p-=2.0*MIN_DIST*r.d;\t\n\treturn ambient(r)+min(max(diffuse(r),specular(r)),shadow(tmp));\n}\nvoid initray(out ray r,screen s,vec2 o){\n\tvec3 l=vec3(0.0,0.0,0.0);\n\tvec3 tmp=vec3(2.0,0.0,0.0);\n\ttmp*=rot_y((PI*s.m.y)/4.0-PI/8.0);\n\ttmp*=rot_z(2.0*PI*s.m.x);\n\tvec3 e=l+tmp;\n\tvec3 u=vec3(0.0,0.0,1.0);\n\tvec3 d=normalize(l-e);\n\tvec3 h=normalize(cross(d,u));\n\tvec3 v=normalize(cross(h,d));\n\td*=rot(v,FOV*s.p.x+o.x/s.r.x);\n\td*=rot(h,FOV*s.p.y+o.x/s.r.y);\n\tr=ray(vec4(0.0),e,d,vec3(0.0),s.t,0);\n}\nvoid mainImage( out vec4 fragColor, in vec2 fragCoord ){\n\tfloat t=iTime;\n\tfloat r=iResolution.x/iResolution.y;\n\tvec2 m=vec2(\n\t\t(iMouse.x-iResolution.x/2.0)/iResolution.x*r,\n\t\t(iMouse.y-iResolution.y/2.0)/iResolution.y);\n\tvec2 p=vec2(\n\t\t(fragCoord.x-iResolution.x/2.0)/iResolution.x*r,\n\t\t(fragCoord.y-iResolution.y/2.0)/iResolution.y);\n\tscreen s=screen(p,iResolution.xy,m,t);\n\tsrand(p);\n\tray v;\n\tvec4 c=vec4(0.0);\n\tif(p.x<1.0/iResolution.x&&p.x>-1.0/iResolution.x){\n\t\tc=vec4(1.0,0.0,0.0,0.0);\n\t}else if(p.x<0.0){\n\t\tvec2 x=vec2(0.5,0.0);\n\t\tx*=rot2d(PI/8.0);\n\t\tfor(int i=0;i<MULTISAMPLE;i++){\n\t\t\tinitray(v,s,x);\n\t\t\tc+=trace(v)/float(MULTISAMPLE);\t\t\n\t\t\tx*=rot2d(PI/2.0);\n\t\t}\n\t}else{\n\t\tinitray(v,s,vec2(0.0));\n\t\tc=trace(v);\n\t}\n\tfragColor=c;\n}","name":"Image","description":"","type":"image"}],"flags":{"mFlagVR":false,"mFlagWebcam":false,"mFlagSoundInput":false,"mFlagSoundOutput":false,"mFlagKeyboard":false,"mFlagMultipass":false,"mFlagMusicStream":false},"info":{"id":"4dSGWd","date":"1395098505","viewed":3206,"name":"Antialiasing","username":"Justaway","description":"Multi-sample anti-aliasing adapted for raymarching. Not efficient but it works.  Click to move camera.","likes":46,"published":1,"flags":0,"usePreview":0,"tags":["raymarching","antialiasing"],"hasliked":0,"parentid":"","parentname":""}}