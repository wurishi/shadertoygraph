{"ver":"0.1","info":{"id":"cdcBDM","date":"1697334239","viewed":63,"name":"Fast and Smooth Blob Filter","username":"ascomycody","description":"Cool Difference of Gaussians filter that uses a flow-based bifilter to smooth noise","likes":3,"published":1,"flags":32,"usePreview":0,"tags":["blur","fast","dog"],"hasliked":0,"parentid":"","parentname":""},"renderpass":[{"inputs":[{"id":"4dXGR8","filepath":"/media/previz/buffer00.png","previewfilepath":"/media/previz/buffer00.png","type":"buffer","channel":0,"sampler":{"filter":"linear","wrap":"clamp","vflip":"true","srgb":"false","internal":"byte"},"published":1},{"id":"XsXGR8","filepath":"/media/previz/buffer01.png","previewfilepath":"/media/previz/buffer01.png","type":"buffer","channel":1,"sampler":{"filter":"linear","wrap":"clamp","vflip":"true","srgb":"false","internal":"byte"},"published":1},{"id":"4sXGR8","filepath":"/media/previz/buffer02.png","previewfilepath":"/media/previz/buffer02.png","type":"buffer","channel":2,"sampler":{"filter":"linear","wrap":"clamp","vflip":"true","srgb":"false","internal":"byte"},"published":1},{"id":"XdfGR8","filepath":"/media/previz/buffer03.png","previewfilepath":"/media/previz/buffer03.png","type":"buffer","channel":3,"sampler":{"filter":"linear","wrap":"clamp","vflip":"true","srgb":"false","internal":"byte"},"published":1}],"outputs":[{"id":"4dfGRr","channel":0}],"code":"void mainImage( out vec4 fragColor, in vec2 fragCoord )\n{\n    vec2 p = fragCoord/iResolution.xy;\n    vec2 d = vec2(1.)/iResolution.xy;\n    vec4 c = xDoG(ic3, 11.+sin(iTime*.75)*10., clamp(1. - BRIGHTNESS * .5, 0.001, .999), .001, 1, fragCoord, iResolution);\n\n    fragColor = vec4(vec3(c.r*.25+c.g*.25+c.b*.25+.25),1.);\n}","name":"Image","description":"","type":"image"},{"inputs":[],"outputs":[],"code":"//#define SOBELMAG\n#define BLURMAG .25\n#define BRIGHTNESS .75\n\n#define ic0 iChannel0\n#define ic1 iChannel1\n#define ic2 iChannel2\n#define ic3 iChannel3\n\n#define pi 3.1415926535897\n#define twopi 6.28318530717\n#define e 2.718281828\n\n#define  c_o float[6](1.47657965106, 3.44552953505, 5.4148988458, 7.38491214448, 9.35577489353, 11.3276683008)\n#define c_wt float[6](0.6172117921, 0.453766864901, 0.260815262022, 0.117194152401, 0.0411633741711, 0.0113004808182)\n\nvec4 bifilter(in int dir, in float scale, in sampler2D a, in sampler2D v, in vec2 fc, in vec3 rez){  \n    vec2 p = fc/rez.xy;\n    vec3 c = .3333333333*texture(a, fc/rez.xy).xyz;\n    vec4 ppathx[7];\n    vec4 npathx[7];\n    vec4 ppathy[7];\n    vec4 npathy[7];\n    ppathx[0] = vec4(fc, texture(v, p).xy);\n    npathx[0] = vec4(fc, texture(v, p).xy);\n    ppathy[0] = vec4(fc, texture(v, p).zx);\n    npathy[0] = vec4(fc, texture(v, p).zx);\n    \n    switch (dir){\n        case 0:\n            for(int i = 0; i < 6; i++){\n            \n                ppathx[i+1] = vec4(ppathx[i].xy + ppathx[0].zw * scale, texture(v, ppathx[i].xy + ppathx[0].zw * scale).xy);\n                npathx[i+1] = vec4(npathx[i].xy - npathx[0].zw * scale, texture(v, npathx[i].xy - npathx[0].zw * scale).xy);\n                \n                float pyo = (fract(ppathx[i+1].y)>.5) ? 1. - fract(ppathx[i+1].y)-.5 : -fract(ppathx[i+1].y);\n                float nyo = (fract(npathx[i+1].y)>.5) ? 1. - fract(npathx[i+1].y)-.5 : -fract(npathx[i+1].y);\n                \n                c += c_wt[i] * texture(a, (ppathx[i+1].xy + vec2(-c_o[i], pyo) * scale)/rez.xy ).xyz;\n                c += c_wt[i] * texture(a, (npathx[i+1].xy + vec2( c_o[i], nyo) * scale)/rez.xy ).xyz;\n            \n            }\n        break;\n        case 1:\n            for(int i = 0; i < 6; i++){\n                \n                ppathy[i+1] = vec4(ppathy[i].xy + ppathy[i].zw * scale, texture(v, ppathy[i].xy + ppathy[i].zw * scale).zx);\n                npathy[i+1] = vec4(npathy[i].xy - npathy[i].zw * scale, texture(v, npathy[i].xy - npathy[i].zw * scale).zx);\n                \n                float pxo = (fract(ppathy[i+1].x)>.5) ? 1. - fract(ppathy[i+1].x)-.5 : -fract(ppathy[i+1].x);\n                float nxo = (fract(npathy[i+1].x)>.5) ? 1. - fract(npathy[i+1].x)-.5 : -fract(npathy[i+1].x);\n                                             \n                c += c_wt[i] * texture(a, (ppathy[i+1].xy + vec2(pxo, -c_o[i]) * scale)/rez.xy ).xyz;\n                c += c_wt[i] * texture(a, (npathy[i+1].xy + vec2(nxo,  c_o[i]) * scale)/rez.xy ).xyz;\n            \n            }\n        break;\n    }\n    return vec4(c/3.25, 1.0);\n}\n\n//------------\n\n#ifdef SOBELMAG\n#define x_sobel mat3(vec3(3,0,-3),vec3(10,0,-10),vec3(3,0,-3))\n#define y_sobel mat3(vec3(3,10,3),vec3(0,0,0),vec3(-3,-10,-3))\n#else\n#define x_sobel mat3(vec3(1,0,-1),vec3(2,0,-2),vec3(1,0,-1))\n#define y_sobel mat3(vec3(1,2,1),vec3(0,0,0),vec3(-1,-2,-1))\n#endif\n\n#define ra 0.\n#define ga (2. * pi) / 3.\n#define ba (4. * pi) / 3.\n\n//sd = 1\n#define blur1wt vec3[11](vec3(0., 0., 0.1591549431),vec3(1.1824255, 0.37754067, 0.0455986550),vec3(3.0293122, 0.37754067, 0.0003072413),vec3(5.0040701, 0.37754067, 0.0000000379),vec3(1.1824255, 2.07585820, 0.0022702233),vec3(3.0293122, 2.07585820, 0.0000152966),vec3(1.1824255, 4.01098690, 0.0000010702),vec3(5., 2.07585820, 0.0000000261),vec3(3.0293122, 4., 0.0000001168),vec3(1., 6., 0.0000000015),vec3(3., 5., 0.0000000066))\n//sd = 1.6\n#define blur2wt vec3[11](vec3(0., 0., 0.0621698996),vec3(1.3575675, 0.45132651, 0.0381524400),vec3(3.2030746, 0.45132651, 0.0054111666),vec3(5.1044773, 0.45132651, 0.0001608697),vec3(1.3575675, 2.27357440, 0.0118190740),vec3(3.2030746, 2.27357440, 0.0016763012),vec3(1.3575675, 4.14706450, 0.0007674666),vec3(5., 2.27357440, 0.0001389495),vec3(3.2030746, 4., 0.0002496470),vec3(1., 6., 0.0000451984),vec3(3., 5., 0.0000812070))\n#define blurdiv 121./41.\n\n\nfloat lum(vec4 col){\n    return (dot(col.rgb, vec3(0.21,0.72,0.07)));\n}\n\nvec2 sobel2d(in sampler2D a, in vec2 p, in vec2 d){\n    mat3 b;\n    float cx;\n    float cy;\n    for(int x = -1; x <= 1; x++){\n    for(int y = -1; y <= 1; y++){\n        int i = x + 1;\n        int j = y + 1;\n        vec2 o = p + vec2(float(x), float(y)) * d;\n        b[i][j] = lum(texture(a, o));\n        cx += b[i][j] * x_sobel[i][j];\n        cy += b[i][j] * y_sobel[i][j];\n    }\n    }\n    return vec2(cx, cy);\n}\n\nvec4 stensor(in float cx, in float cy, in int viz, in int dir, in int inv){\n    vec3 a = vec3(cx * cx, cx * cy, cy * cy);\n    vec2 b = vec2(((a.x + a.z) + sqrt((a.x - a.z) * (a.x - a.z) + 4. * (a.y * a.y))) * .5, \n                  ((a.x + a.z) - sqrt((a.x - a.z) * (a.x - a.z) + 4. * (a.y * a.y))) * .5);\n    vec3 v;\n    switch (inv){\n        case 0:\n            v = vec3(a.y, b.x - a.x, b.y - a.z);\n        break;\n        case 1:\n            v = vec3(1.) - vec3(a.y, b.x - a.x, b.y - a.z);\n        break;\n    }\n    switch (viz){\n        case 0:\n            return vec4(v, b.y);\n        case 1:\n            vec2 c = vec2(2. * atan(v.y, v.x), 2. * atan(v.x, v.z));\n            //vec2 d = vec2(dot(v.x, v.y), dot(v.z, v.x));\n            switch (dir){\n                case 0:\n                    return vec4(vec3(sin(c.x + ra), sin(c.x + ga), sin(c.x + ba)) * .5 + .5, 1.);\n                case 1:\n                    return vec4(vec3(sin(c.y + ra), sin(c.y + ga), sin(c.y + ba)) * .5 + .5, 1.);\n                case 2:\n                    return vec4(vec3(sin(c.x * c.y + ra), sin(c.x * c.y + ga), sin(c.x * c.y + ba)) * .5 + .5, 1.);\n            }\n    }\n}\n\nvec4 fastblur(in sampler2D a, in vec2 f, in vec3 rez){\n    // Center\n    vec3 b = 0.0176838826 * texture(a, (f + vec2(0., 0.))/rez.xy).rgb;\n\n    // (x, y)\n    b += 0.0153907200 * texture(a, (f + vec2(1.4584295, 0.48611468))/rez.xy).rgb;\n    b += 0.0088304784 * texture(a, (f + vec2(3.4039848, 0.48611468))/rez.xy).rgb;\n    b += 0.0032485515 * texture(a, (f + vec2(5.3518058, 0.48611468))/rez.xy).rgb;\n    b += 0.0110279330 * texture(a, (f + vec2(1.4584295, 2.4309987))/rez.xy).rgb;\n    b += 0.0063273143 * texture(a, (f + vec2(3.4039848, 2.4309987))/rez.xy).rgb;\n    b += 0.0050665172 * texture(a, (f + vec2(1.4584295, 4.3775407))/rez.xy).rgb;\n    b += 0.0031159763 * texture(a, (f + vec2(5., 2.4309987))/rez.xy).rgb;\n    b += 0.0036810911 * texture(a, (f + vec2(3.4039848, 4.))/rez.xy).rgb;\n    b += 0.0022639206 * texture(a, (f + vec2(1., 6.))/rez.xy).rgb;\n    b += 0.0026745061 * texture(a, (f + vec2(3., 5.))/rez.xy).rgb;\n    \n    // (-x, y)\n    b += 0.0153907200 * texture(a, (f + vec2(-0.48611468, 1.4584295))/rez.xy).rgb;\n    b += 0.0088304784 * texture(a, (f + vec2(-0.48611468, 3.4039848))/rez.xy).rgb;\n    b += 0.0032485515 * texture(a, (f + vec2(-0.48611468, 5.3518058))/rez.xy).rgb;\n    b += 0.0110279330 * texture(a, (f + vec2(-2.4309987, 1.4584295))/rez.xy).rgb;\n    b += 0.0063273143 * texture(a, (f + vec2(-2.4309987, 3.4039848))/rez.xy).rgb;\n    b += 0.0050665172 * texture(a, (f + vec2(-4.3775407, 1.4584295))/rez.xy).rgb;\n    b += 0.0031159763 * texture(a, (f + vec2(-2.4309987, 5.))/rez.xy).rgb;\n    b += 0.0036810911 * texture(a, (f + vec2(-4., 3.4039848))/rez.xy).rgb;\n    b += 0.0022639206 * texture(a, (f + vec2(-6., 1.))/rez.xy).rgb;\n    b += 0.0026745061 * texture(a, (f + vec2(-5., 3.))/rez.xy).rgb;\n    \n    // (-x, -y)\n    b += 0.0153907200 * texture(a, (f + vec2(-1.4584295, -0.48611468))/rez.xy).rgb;\n    b += 0.0088304784 * texture(a, (f + vec2(-3.4039848, -0.48611468))/rez.xy).rgb;\n    b += 0.0032485515 * texture(a, (f + vec2(-5.3518058, -0.48611468))/rez.xy).rgb;\n    b += 0.0110279330 * texture(a, (f + vec2(-1.4584295, -2.4309987))/rez.xy).rgb;\n    b += 0.0063273143 * texture(a, (f + vec2(-3.4039848, -2.4309987))/rez.xy).rgb;\n    b += 0.0050665172 * texture(a, (f + vec2(-1.4584295, -4.3775407))/rez.xy).rgb;\n    b += 0.0031159763 * texture(a, (f + vec2(-5., -2.4309987))/rez.xy).rgb;\n    b += 0.0036810911 * texture(a, (f + vec2(-3.4039848, -4.))/rez.xy).rgb;\n    b += 0.0022639206 * texture(a, (f + vec2(-1., -6.))/rez.xy).rgb;\n    b += 0.0026745061 * texture(a, (f + vec2(-3., -5.))/rez.xy).rgb;\n    \n    // (x, -y)\n    b += 0.0153907200 * texture(a, (f + vec2(0.48611468, -1.4584295))/rez.xy).rgb;\n    b += 0.0088304784 * texture(a, (f + vec2(0.48611468, -3.4039848))/rez.xy).rgb;\n    b += 0.0032485515 * texture(a, (f + vec2(0.48611468, -5.3518058))/rez.xy).rgb;\n    b += 0.0110279330 * texture(a, (f + vec2(2.4309987, -1.4584295))/rez.xy).rgb;\n    b += 0.0063273143 * texture(a, (f + vec2(2.4309987, -3.4039848))/rez.xy).rgb;\n    b += 0.0050665172 * texture(a, (f + vec2(4.3775407, -1.4584295))/rez.xy).rgb;\n    b += 0.0031159763 * texture(a, (f + vec2(2.4309987, -5.))/rez.xy).rgb;\n    b += 0.0036810911 * texture(a, (f + vec2(4., -3.4039848))/rez.xy).rgb;\n    b += 0.0022639206 * texture(a, (f + vec2(6., -1.))/rez.xy).rgb;\n    b += 0.0026745061 * texture(a, (f + vec2(5., -3.))/rez.xy).rgb;\n    \n    return vec4(b*3.82928330162, 1.);\n}\n\nvec4 blur1(in sampler2D a, in vec2 f, in vec3 rez){\n    vec3 b;\n    b += blur1wt[0].z * texture(a, (f + vec2(blur1wt[0].x, blur1wt[0].y))/rez.xy).rgb;\n    \n    for(int i = 1; i < 11; i++){\n        b += blur1wt[i].z * texture(a, (f + vec2(blur1wt[i].x, blur1wt[i].y))/rez.xy).rgb;\n        b += blur1wt[i].z * texture(a, (f + vec2(-blur1wt[i].y, blur1wt[i].x))/rez.xy).rgb;\n        b += blur1wt[i].z * texture(a, (f + vec2(-blur1wt[i].x, -blur1wt[i].y))/rez.xy).rgb;\n        b += blur1wt[i].z * texture(a, (f + vec2(blur1wt[i].y, -blur1wt[i].x))/rez.xy).rgb;\n    }\n    \n    return vec4(b*2.84765471092, 1.);\n}\n\nvec4 blur2(in sampler2D a, in vec2 f, in vec3 rez){\n    vec3 b;\n    b += blur2wt[0].z * texture(a, (f + vec2(blur2wt[0].x, blur2wt[0].y))/rez.xy).rgb;\n    \n    for(int i = 1; i < 11; i++){\n        b += blur2wt[i].z * texture(a, (f + vec2(blur2wt[i].x, blur2wt[i].y))/rez.xy).rgb;\n        b += blur2wt[i].z * texture(a, (f + vec2(-blur2wt[i].y, blur2wt[i].x))/rez.xy).rgb;\n        b += blur2wt[i].z * texture(a, (f + vec2(-blur2wt[i].x, -blur2wt[i].y))/rez.xy).rgb;\n        b += blur2wt[i].z * texture(a, (f + vec2(blur2wt[i].y, -blur2wt[i].x))/rez.xy).rgb;\n    }\n    \n    return vec4(b*3.32960347244, 1.);\n}\n\nvec4 xDoG(in sampler2D a, in float tau, in float thr, in float rng, in int cm, in vec2 f, in vec3 rez){\n    vec4 g = (1. + tau) * blur1(a, f, rez) - tau * blur2(a, f, rez);\n    \n    switch (cm){\n      case 0:\n          return smoothstep(thr - rng*.5, thr + rng*.5, vec4(lum(g)));\n      case 1:\n          return smoothstep(thr - rng*.5, thr + rng*.5, g);\n  }\n}","name":"Common","description":"","type":"common"},{"inputs":[{"id":"4dfGRn","filepath":"/media/a/8de3a3924cb95bd0e95a443fff0326c869f9d4979cd1d5b6e94e2a01f5be53e9.jpg","previewfilepath":"/media/ap/8de3a3924cb95bd0e95a443fff0326c869f9d4979cd1d5b6e94e2a01f5be53e9.jpg","type":"texture","channel":3,"sampler":{"filter":"mipmap","wrap":"repeat","vflip":"true","srgb":"false","internal":"byte"},"published":1}],"outputs":[{"id":"4dXGR8","channel":0}],"code":"void mainImage( out vec4 fragColor, in vec2 fragCoord )\n{\n    vec2 p = fragCoord/iResolution.xy;\n    vec2 d = vec2(1.)/iResolution.xy;\n    \n    vec2 s = sobel2d(ic3, p, d);\n    vec4 c = stensor(s.x, s.y, 0, 0, 0);\n\n    fragColor = c;\n}","name":"Buffer A","description":"","type":"buffer"},{"inputs":[{"id":"4dXGR8","filepath":"/media/previz/buffer00.png","previewfilepath":"/media/previz/buffer00.png","type":"buffer","channel":0,"sampler":{"filter":"linear","wrap":"clamp","vflip":"true","srgb":"false","internal":"byte"},"published":1}],"outputs":[{"id":"XsXGR8","channel":0}],"code":"void mainImage( out vec4 fragColor, in vec2 fragCoord )\n{\n    vec2 p = fragCoord/iResolution.xy;\n    vec2 d = vec2(1.)/iResolution.xy;\n    vec4 c = fastblur(ic0, fragCoord, iResolution);\n    \n    fragColor = c;\n}","name":"Buffer B","description":"","type":"buffer"},{"inputs":[{"id":"4dfGRn","filepath":"/media/a/8de3a3924cb95bd0e95a443fff0326c869f9d4979cd1d5b6e94e2a01f5be53e9.jpg","previewfilepath":"/media/ap/8de3a3924cb95bd0e95a443fff0326c869f9d4979cd1d5b6e94e2a01f5be53e9.jpg","type":"texture","channel":3,"sampler":{"filter":"mipmap","wrap":"repeat","vflip":"true","srgb":"false","internal":"byte"},"published":1},{"id":"4dXGR8","filepath":"/media/previz/buffer00.png","previewfilepath":"/media/previz/buffer00.png","type":"buffer","channel":0,"sampler":{"filter":"linear","wrap":"clamp","vflip":"true","srgb":"false","internal":"byte"},"published":1},{"id":"XsXGR8","filepath":"/media/previz/buffer01.png","previewfilepath":"/media/previz/buffer01.png","type":"buffer","channel":1,"sampler":{"filter":"linear","wrap":"clamp","vflip":"true","srgb":"false","internal":"byte"},"published":1}],"outputs":[{"id":"4sXGR8","channel":0}],"code":"void mainImage( out vec4 fragColor, in vec2 fragCoord )\n{\n    vec2 p = fragCoord/iResolution.xy;\n    vec2 d = vec2(1.)/iResolution.xy;\n    vec4 c = bifilter(0, BLURMAG, ic3, ic1, fragCoord, iResolution);\n\n    fragColor = c;\n}","name":"Buffer C","description":"","type":"buffer"},{"inputs":[{"id":"4dfGRn","filepath":"/media/a/8de3a3924cb95bd0e95a443fff0326c869f9d4979cd1d5b6e94e2a01f5be53e9.jpg","previewfilepath":"/media/ap/8de3a3924cb95bd0e95a443fff0326c869f9d4979cd1d5b6e94e2a01f5be53e9.jpg","type":"texture","channel":3,"sampler":{"filter":"mipmap","wrap":"repeat","vflip":"true","srgb":"false","internal":"byte"},"published":1},{"id":"4dXGR8","filepath":"/media/previz/buffer00.png","previewfilepath":"/media/previz/buffer00.png","type":"buffer","channel":0,"sampler":{"filter":"linear","wrap":"clamp","vflip":"true","srgb":"false","internal":"byte"},"published":1},{"id":"XsXGR8","filepath":"/media/previz/buffer01.png","previewfilepath":"/media/previz/buffer01.png","type":"buffer","channel":1,"sampler":{"filter":"linear","wrap":"clamp","vflip":"true","srgb":"false","internal":"byte"},"published":1},{"id":"4sXGR8","filepath":"/media/previz/buffer02.png","previewfilepath":"/media/previz/buffer02.png","type":"buffer","channel":2,"sampler":{"filter":"linear","wrap":"clamp","vflip":"true","srgb":"false","internal":"byte"},"published":1}],"outputs":[{"id":"XdfGR8","channel":0}],"code":"void mainImage( out vec4 fragColor, in vec2 fragCoord )\n{\n    vec2 p = fragCoord/iResolution.xy;\n    vec2 d = vec2(1.)/iResolution.xy;\n    vec4 c = bifilter(1, BLURMAG, ic2, ic1, fragCoord, iResolution);\n\n    fragColor = c;\n}","name":"Buffer D","description":"","type":"buffer"}]}