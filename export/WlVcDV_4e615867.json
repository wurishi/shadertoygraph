{"ver":"0.1","info":{"id":"WlVcDV","date":"1611805200","viewed":116,"name":"Fractal 05_gaz","username":"gaz","description":"3d","likes":9,"published":1,"flags":0,"usePreview":0,"tags":["fractal"],"hasliked":0,"parentid":"WlKcDV","parentname":"Fractal 04_gaz"},"renderpass":[{"inputs":[],"outputs":[{"id":"4dfGRr","channel":0}],"code":"#define rot(a) mat2(cos(a),sin(a),-sin(a),cos(a))\n\nfloat lpNorm(vec3 p, float n)\n{\n\tp = pow(abs(p),vec3(n));\n\treturn pow(p.x+p.y+p.z,1./n);\n}\n\nfloat map(vec3 p){\n    p.xy*=rot(iTime*.3);\n    p.yz*=rot(iTime*.3);\n    float scale=4.5;\n    float mr2=.5;\n    float off=.5;\n    float s=1.;\n    vec3 p0 = p;\n    for (int i=0; i<16; i++) {\n        if(i%3==0)p=p.yzx;\n        if(i%2==1)p=p.yxz;\n        p -= clamp(p,-1.,1.)*2.;\n        float r2=pow(lpNorm(p.xyz,5.),2.);\n        float g=clamp(mr2*max(1./r2,1.),0.,1.);\n        p=p*scale*g+p0*off;\n        s=s*scale*g+off;\n    }\n    return length(p)/s-.01;\n}\n\nvec3 calcNormal(vec3 pos)\n{\n  vec2 e=vec2(1,-1)*.005;\n  return normalize(\n    e.xyy*map(pos+e.xyy)+e.yyx*map(pos+e.yyx)+ \n    e.yxy*map(pos+e.yxy)+e.xxx*map(pos+e.xxx)\n  );\n}\n\nfloat march(vec3 ro, vec3 rd, float near, float far)\n{\n    float t=near,d;\n    for(int i=0;i<80;i++)\n    {\n        t+=d=map(ro+rd*t);\n        if (d<.001) return t;\n        if (t>=far) return far;\n    }\n    return far;\n}\n\nfloat calcShadow(vec3 light, vec3 ld, float len)\n{\n\tfloat depth=march(light,ld,0.,len);\t\n\treturn step(len-depth,.01 );\n}\n\nvoid mainImage( out vec4 fragColor, in vec2 fragCoord )\n{\n    vec2 uv = (fragCoord*2.-iResolution.xy)/iResolution.y;\n    vec3 ro = vec3(0,0,8.);\n    vec3 rd = normalize(vec3(uv,-2.));\n    vec3 col = vec3(0);\n\tconst float maxd = 40.;\n    float t = march(ro,rd,0.,maxd);\n    if(t<maxd)\n    {\n        vec3 p=ro+rd*t;\n        col=vec3(.3,.3,.6)+cos(p*.17)*.5+.5;\n        vec3 n=calcNormal(p);      \n\t\tvec3 lightPos=vec3(20);\n    \tvec3 li=lightPos-p;\n\t\tfloat len=length(li);\n\t\tli/=len;\n\t\tfloat dif=clamp(dot(n, li),.5,1.);\n        float sha=calcShadow(lightPos,-li,len);\n        col*=max(sha*dif,.4);\n        float rimd=pow(clamp(1.-dot(reflect(-li,n),-rd),0.,1.),2.5);\n\t\tfloat frn=rimd+2.2*(1.-rimd);\n    \tcol*=frn*.9;\n        col*=max(.5+.5*n.y,0.);\n        col*=exp2(-2.*pow(max(0.,1.-map(p+n*.3)/.3),2.));\n        col+=vec3(.5,.9,.9)*pow(clamp(dot(reflect(rd,n),li),0.,1.),8.);\n        col=mix(vec3(0),col,exp(-t*t*.003));\n    }\n    fragColor.xyz=col;\n}","name":"Image","description":"","type":"image"}]}