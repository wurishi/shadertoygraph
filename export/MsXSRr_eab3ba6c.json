{"ver":"0.1","renderpass":[{"outputs":[],"inputs":[],"code":"#define PI 3.1415926\n#define MAX_ITER 64\n#define MIN_STEP 0.001\n#define FOV PI/4.0\n#define SAMPLE_RADIUS 0.001\n#define SPECULAR 5.0\n#define MAX_ITER_SHADOW 32\n#define MAX_DIST_SHADOW 10.0\n#define MIN_DIST_SHADOW 0.1\n#define PENUMBRA 16.0\nstruct light{\n\tvec4 c;\n\tvec4 a;\n\tvec3 p;\t\n};\nstruct ray{\n\tvec4 c;\n\tvec3 p;\n\tvec3 d;\n\tvec3 n;\n\tint i;\n\tlight l;\n};\nstruct view{\n\tvec3 e;\n\tvec3 l;\n\tvec3 u;\n};\nvoid srand(vec2 p,inout float s);\nfloat rand(inout float s);\nfloat grad(float t);\nmat2 rot2d(float a);\nmat3 rotx(float a);\nmat3 roty(float a);\nmat3 rotz(float a);\nmat3 rot(vec3 z,float a);\nvec4 trace(vec2 p,view v,light l);\nfloat dist(inout ray r);\nfloat sphere(inout ray r,vec3 o);\nvec3  normal(ray r);\nvec4 ambient(ray r);\nvec4 diffuse(ray r,vec3 n);\nvec4 specular(ray r,vec3 n);\nvec4 shadow(ray r);\nfloat dome(inout ray r);\nfloat smin(float a,float b,float k);\nfloat ifs(inout ray r,vec3 o,float d,int i);\nfloat octahedron(vec3 p,float r);\nvec3 texture(vec2 p);\nvec3 hash2d(vec2 p);\nvec2 simplex(vec2 p);\nvec2 unsimplex(vec2 p);\nvoid mainImage( out vec4 fragColor, in vec2 fragCoord ){\n\tvec2 p=(fragCoord.xy-iResolution.xy/2.0)/iResolution.y;\n\tvec2 m=(iMouse.xy-iResolution.xy/2.0)/iResolution.y;\n\tview v;\n\tv.l=vec3(0.0,0.0,0.0);\n\tvec3 vv=vec3(2.0,0.0,0.0);\n\tvv*=roty((PI*m.y)/4.0-PI/8.0);\n\tvv*=rotz(2.0*PI*m.x);\n\tv.e=v.l+vv;\n\tv.u=vec3(1.0,1.0,1.0);\n\tlight l=light(\t\t\n\t\tvec4(0.5),\n\t\tvec4(0.5),\n\t\tvec3(5.0,5.0,0.0)\n\t);\n\tfragColor=trace(p,v,l);\n}\nvec4 trace(vec2 p,view v,light l){\n\tray r;\n\tr.d=normalize(v.l-v.e);\n\tvec3 hv=normalize(cross(r.d,v.u));\n\tvec3 vv=normalize(cross(hv,r.d));\n\tr.d*=rot(vv,p.x*FOV);\n\tr.d*=rot(hv,p.y*FOV);\t\n\tr.p=v.e;\n\tr.i=0;\n\tr.c=vec4(1.0);\n\tr.l=l;\n\tfor(int i=0;i<MAX_ITER;i++){\n\t\tfloat d=dist(r);\n\t\tif(r.i==1)break;\n\t\td=max(d,MIN_STEP);\n\t\tr.p+=r.d*d;\n\t}\n\tvec3 n=normal(r);\n\treturn ambient(r)+min(shadow(r),max(diffuse(r,n),specular(r,n)));\n}\nfloat dist(inout ray r){\n\tfloat d=128.0;\n\td=min(d,dome(r));\n\treturn d;\n}\nvec4 ambient(ray r){\n\treturn r.c*r.l.a;\n}\nvec4 diffuse(ray r,vec3 n){\n\tvec3 v=r.l.p-r.p;\n\treturn clamp(r.c*r.l.c*dot(n,normalize(v)),0.0,1.0);\n}\nvec4 specular(ray r,vec3 n){\n\tfloat d=length(r.l.p-r.p);\n\tvec3 v=normalize(r.l.p-r.p);\n\treturn r.l.c*max(pow(dot(v,reflect(r.d,n)),SPECULAR),0.0);\n}\nvec4 shadow(ray r){\n\tr.p-=2.0*MIN_STEP*r.d;\n\tr.d=normalize(r.l.p-r.p);\n\tfloat s=1.0;\n\tfloat t=MIN_DIST_SHADOW;\n\tfor(int i=0;i<MAX_ITER_SHADOW;i++){\n\t\tray tmp=r;\n\t\ttmp.p+=r.d*t;\n\t\tfloat h=dist(tmp);\n\t\tif(h<MIN_STEP)return vec4(0.0);\n\t\ts=min(s,PENUMBRA*h/t);\n\t\tt+=h;\n\t\tif(t>MAX_DIST_SHADOW)break;\n\t}\n\treturn vec4(s);\n}\nvec3 normal(ray r){\n\tfloat d=dist(r);\n\tvec3 n=vec3(SAMPLE_RADIUS,0.0,0.0);\n\tray r0=r;\n\tray r1=r;\n\tray r2=r;\n\tr0.p+=n.xyy;\n\tr1.p+=n.yxy;\n\tr2.p+=n.yyx;\n\treturn normalize(vec3(dist(r0)-d,dist(r1)-d,dist(r2)-d));\n}\nfloat smin(float a,float b,float k){\n\tfloat h=clamp(0.5+0.5*(b-a)/k,0.0,1.0);\n    return mix(b,a,h)-k*h*(1.0-h);\n}\nfloat dome(inout ray r){\n\tvec3 tex=texture(r.p.xy);\n\tfloat d=dot(r.p+vec3(0.0,0.0,0.5*length(tex)),vec3(0.0,0.0,1.0))+0.5;\n\td=smin(d,50.0-length(r.p),10.0);\n\tif(d<0.0){\n\t\tfloat l=length(r.p);\n\t\tr.c=vec4(tex,0.0);\n\t\tr.i=1;\n\t}\n\treturn d;\n}\nfloat sphere(inout ray r,vec3 o){\n\tvec3 p=r.p+o;\n\tfloat d=length(p)-0.5;\n\tif(d<0.0){\n\t\tr.i=1;\n\t\tr.c=vec4(1.0);\n\t}\n\treturn d;\n}\nvoid srand(vec2 p,inout float s){\n\ts=sin(dot(p,vec2(423.62431,321.54323)));\n}\nfloat rand(inout float s){\n\ts=fract(s*32322.65432+0.12333);\n\treturn abs(fract(s));\n}\nvec3 hash2d(vec2 p){\n\tvec3 c;\n\tfloat s;\n\tsrand(p,s);\n\tc.r=rand(s);\n\tc.g=rand(s);\n\tc.b=rand(s);\n\treturn c;\n}\nfloat grad(float t){\n\treturn 6.0*pow(t,5.0)-15.0*pow(t,4.0)+10.0*pow(t,3.0);\n}\nmat2 rot2d(float a){\n\tfloat c=cos(a);\n\tfloat s=sin(a);\n\treturn mat2(\n\t\tc,-s,\n\t\ts, c);\n}\nmat3 rotx(float a){\n\tfloat c=cos(a);\n\tfloat s=sin(a);\n\treturn mat3(\n\t\t1.0,0.0,0.0,\n\t\t0.0,  c, -s,\n\t\t0.0,  s,  c);\n}\nmat3 roty(float a){\n\tfloat c=cos(a);\n\tfloat s=sin(a);\n\treturn mat3(\n\t\tc,  0.0,  s,\n\t\t0.0,1.0,0.0,\n\t\t-s, 0.0,  c);\n}\nmat3 rotz(float a){\n\tfloat c=cos(a);\n\tfloat s=sin(a);\n\treturn mat3(\n\t\t  c, -s,0.0,\n\t\t  s,  c,0.0,\n\t    0.0,0.0,1.0);\n}\nmat3 rot(vec3 z,float a){\n\tfloat c=cos(a);\n\tfloat s=sin(a);\n\tfloat b=1.0-c;\n\treturn mat3(\n\t\tb*z.x*z.x+c,b*z.x*z.y-z.z*s,b*z.z*z.x+z.y*s,\n\t\tb*z.x*z.y+z.z*s,b*z.y*z.y+c,b*z.y*z.z-z.x*s,\n\t\tb*z.z*z.x-z.y*s,b*z.y*z.z+z.x*s,b*z.z*z.z+c);\n}\nfloat ifs(inout ray r,vec3 o,float d,int i){\n\tvec3 p=r.p+o;\n\tfloat l=0.5;\n\tfor(int i=0;i<16;i++){\n\t\td=min(d,octahedron(p,l));\n\t\tp=vec3(p.x+2.5*l,p.y,p.z);\n\t\tl*=0.5;\n\t}\t\n\tif(d<0.0){\n\t\tr.i=1;\n\t\tr.c=vec4(1.0);\n\t}\n\treturn d;\n}\nfloat octahedron(vec3 p,float r){\n\treturn dot(abs(p),normalize(vec3(1.0,1.0,1.0)))-r;\n}\nvec3 texture(vec2 p){\n\tp=simplex(p);\n\tvec2 p0=floor(p);\n\tvec2 p1=p0+vec2(1.0,0.0);\n\tvec2 p2=p0+vec2(1.0,1.0);\n\tvec2 p3=p0+vec2(0.0,1.0);\n\tvec2 i=fract(p);\n\tvec3 r0,r1,r2;\n\tfloat d0,d1,d2;\t\n\tif(i.x>i.y){\n\t\tr0=hash2d(p0);\n\t\tr1=hash2d(p1);\n\t\tr2=hash2d(p2);\n\t\td0=max(1.0-distance(unsimplex(p),unsimplex(p0)),0.0);\n\t\td1=max(1.0-distance(unsimplex(p),unsimplex(p1)),0.0);\n\t\td2=max(1.0-distance(unsimplex(p),unsimplex(p2)),0.0);\n\t}else{\n\t\tr0=hash2d(p0);\n\t\tr1=hash2d(p2);\n\t\tr2=hash2d(p3);\n\t\td0=max(1.0-distance(unsimplex(p),unsimplex(p0)),0.0);\n\t\td1=max(1.0-distance(unsimplex(p),unsimplex(p2)),0.0);\n\t\td2=max(1.0-distance(unsimplex(p),unsimplex(p3)),0.0);\n\t}\n\treturn d0*r0+d1*r1+d2*r2;\n}\nvec2 simplex(vec2 p){\n\tvec2 r;\n\tr.x=1.1547*p.x;\n\tr.y=p.y+0.5*r.x;\n\treturn r;\n}\nvec2 unsimplex(vec2 p){\n\tvec2 r;\n\tr.y=p.y-0.5*p.x;\n\tr.x=p.x/1.1547;\n\treturn r;\n}","name":"Image","description":"","type":"image"}],"flags":{"mFlagVR":false,"mFlagWebcam":false,"mFlagSoundInput":false,"mFlagSoundOutput":false,"mFlagKeyboard":false,"mFlagMultipass":false,"mFlagMusicStream":false},"info":{"id":"MsXSRr","date":"1400630051","viewed":282,"name":"Interesting Landscape","username":"Justaway","description":"Some kind of landscape","likes":2,"published":1,"flags":0,"usePreview":0,"tags":["raytracing"],"hasliked":0,"parentid":"","parentname":""}}