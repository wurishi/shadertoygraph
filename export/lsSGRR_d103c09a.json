{"ver":"0.1","renderpass":[{"outputs":[],"inputs":[{"channel":0,"type":"music","id":"4df3Rn","filepath":"/media/a/3c33c415862bb7964d256f4749408247da6596f2167dca2c86cc38f83c244aa6.mp3","sampler":{"filter":"linear","wrap":"clamp","vflip":"false","srgb":"false","internal":"byte"}}],"code":"#define NUM_BALLS 5 \n#define RADIUS 0.25\n#define TIGHTNESS 1.7\n#define TIME iTime*0.4\n#define MUSIC_STRENGTH 1.5\n#define LIGHT_POWER 0.2\n\n#define DETAIL_LEVEL 128 \n\nvec3 origins[NUM_BALLS];\n\nfloat samp1()\n{\n\treturn MUSIC_STRENGTH * (\n\t\ttexture( iChannel0, vec2( 0.1, 0.25 ) ).x + \n\t\ttexture( iChannel0, vec2( 0.3, 0.05 ) ).x);\n}\n\nvec4 sampleWorld(vec3 at)\n{\n\tfloat s = 0.0;\n\tvec3 avg = vec3(0.0);\n\t\n\tfloat distances[NUM_BALLS];\n\tfloat totalDistance = 0.0;\n\t\n\tfor (int i = 0; i < NUM_BALLS; i++)\n\t{\n\t\tfloat toBall = length(at - origins[i]);\n\t\tdistances[i] = toBall;\n\t\ttotalDistance += toBall;\n\t\tfloat music = samp1();\n\t\ts += ((2.*0.04)*music+RADIUS) / (toBall);\n\t}\n\t\n\tfor (int i = 0; i < NUM_BALLS; i++)\n\t{\n\t\tif ( abs(distances[i]) < 5.) avg += normalize((origins[i]-at)) / ((distances[i]/totalDistance));// * (distances[i] / totalDistance);\n\t}\n\t\n\t\n\treturn vec4(avg, 1. - s);\n}\n\nvec2 rotate(vec2 p, float a)\n{\n\treturn vec2(p.x * cos(a) - p.y * sin(a), p.x * sin(a) + p.y * cos(a));\n}\n\nvec3 calcMetaNormal(vec3 p)\n{\n\tvec4 s = sampleWorld(p);\n\treturn normalize(-s.xyz);\n}\n\nvec3 calcNormal(vec3 p)\n{\n\tvec3 n;\n\t\t\n\tfloat e = 0.04;\n\tn.x = sampleWorld(vec3(p.x + e, p.y, p.z)).w;\n\tn.y = sampleWorld(vec3(p.x, p.y + e, p.z)).w;\n\tn.z = sampleWorld(vec3(p.x, p.y, p.z + e)).w;\n\t\n\treturn normalize(n);\n}\n\n\nvoid updateWorld()\n{\n\tfor (int i = 0; i < NUM_BALLS; i++)\n\t{\n\t\tfloat ii = float(i)+0.3;\n\t\torigins[i] = vec3(sin(TIME*(ii*0.5)),\n\t\t\t\t\t\t  0.25*float(NUM_BALLS)*cos(TIME*ii), \n\t\t\t\t\t\t  2.*sin(TIME*ii)+sin(TIME/ii));\n\t\torigins[i] *= TIGHTNESS;\n\t}\n}\n\nvoid mainImage( out vec4 fragColor, in vec2 fragCoord )\n{\n\tvec2 uv = -1.0 + 2.0*fragCoord.xy / iResolution.xy;\n\tfloat pan = 0.3+TIME*0.5;//0.1 + (iMouse.x / iResolution.y - 0.5) * -3.14;\n\tconst vec3 CAM_UP = vec3(0.0, 1.0, 0.0);\n\tvec3 CAM_POS = vec3(-7.0, 0.5,0.0);\n\tCAM_POS.xz = rotate(CAM_POS.xz, pan);\n\n\tvec3 CAM_LOOKPOINT = vec3(0.0, 0.5, 0.0);\n\t\n\tvec3 lookDirection = normalize(CAM_LOOKPOINT - CAM_POS);\n\tvec3 viewPlaneU = normalize(cross(CAM_UP, lookDirection));\n\tvec3 viewPlaneV = cross(lookDirection, viewPlaneU);\n\tvec3 viewCenter = lookDirection + CAM_POS;\n\t\n\tvec3 fragWorldPos = viewCenter + (uv.x * viewPlaneU * iResolution.x / iResolution.y) + (uv.y * viewPlaneV);\n\tvec3 fragWorldToCamPos = normalize(fragWorldPos - CAM_POS);\n\n\tconst float farClip = 10.0;\n\t\n\tvec3 LIGHT_DIR = CAM_POS - CAM_LOOKPOINT;//normalize(vec3(-1.0, 1.0, 1.));\n\tvec3 LIGHT_COL = normalize(vec3(abs(cos(iTime)+0.2), abs(sin(TIME)), abs(sin(TIME)+0.3)));\n\t\n\tvec3 col = abs(vec3((0.1*samp1()+0.03)/(uv.y)));\n\n\tupdateWorld();\n\n\t\n\tfloat f = 0.0;\n\tfloat s = 0.01;\n\tvec3 p = CAM_POS + fragWorldToCamPos*f;\n\t\n\tfor (int i = 0; i < DETAIL_LEVEL; i++)\n\t{\n\t\tif ( s < 0.0001 )\n\t\t{\n\t\t\tcol = (vec3(0.2)+col*(LIGHT_COL*LIGHT_POWER)*max(0.0,(dot(LIGHT_DIR,(calcNormal(p))))));\n\t\t}\n\t\t\n\t\ts=sampleWorld(p).w;\n\t\tf+=s;\n\t\tp = CAM_POS + fragWorldToCamPos * f;\n\t}\n\t\n\tfragColor = vec4(col, 1.0);\n}","name":"Image","description":"","type":"image"}],"flags":{"mFlagVR":false,"mFlagWebcam":false,"mFlagSoundInput":false,"mFlagSoundOutput":false,"mFlagKeyboard":false,"mFlagMultipass":false,"mFlagMusicStream":false},"info":{"id":"lsSGRR","date":"1382496082","viewed":240,"name":"Musical Metablobs 3D","username":"khalladay","description":"Musical Metaballs in 3D! \n\nMusic won't work in safari (the music channel doesn't generate a texture in safari for some reason). \n\nWould love for someone to point out what I'm missing with the calcMetaNormal function.\n","likes":0,"published":1,"flags":0,"usePreview":0,"tags":["3d","music","metaball"],"hasliked":0,"parentid":"","parentname":""}}