{"ver":"0.1","info":{"id":"WlKcDV","date":"1611804556","viewed":93,"name":"Fractal 04_gaz","username":"gaz","description":"3d","likes":4,"published":1,"flags":0,"usePreview":0,"tags":["fractal"],"hasliked":0,"parentid":"","parentname":""},"renderpass":[{"inputs":[],"outputs":[{"id":"4dfGRr","channel":0}],"code":"#define rot(a) mat2(cos(a),sin(a),-sin(a),cos(a))\n\n#define hash(n) fract(sin(n*234.567+123.34))\n\n#define sabs(x)sqrt((x)*(x)+.005)\n#define sabs2(x)sqrt((x)*(x)+1e-4)\n#define smax(a,b) (a+b+sabs2(a-b))*.5\n\nvoid sfold90(inout vec2 p)\n{\n    p=(p.x+p.y+vec2(1,-1)*sabs(p.x-p.y))*.5;\n}\n\nfloat map(vec3 p){\n\tp.xy *= rot(iTime*0.3);\n    p.yz *= rot(iTime*0.4);\n    vec3 q=p;\n    p=abs(p)-4.;\n    sfold90(p.xy);\n    sfold90(p.yz);\n    sfold90(p.zx);\n    \n\tfloat s=2.5;\n\tp=sabs(p);\n\tvec3  p0 = p*1.5;\n\tfor (float i=0.; i<4.; i++){\n    \tp=1.-sabs2(sabs2(p-2.)-1.); \n    \tfloat g=-5.5*clamp(.7*smax(1.6/dot(p,p),.7),.0,5.5);\n    \tp*=g;\n    \tp+=p0+normalize(vec3(1,5,12))*(5.-.8*i);\n        s*=g;\n\t}\n\ts=sabs(s);\n\tfloat a=25.;\n\tp-=clamp(p,-a,a);\n\t\n\tq=abs(q)-vec3(3.7);\n    sfold90(q.xy);\n    sfold90(q.yz);\n    sfold90(q.zx);\n  \treturn smax(max(abs(q.y),abs(q.z))-1.3,length(p)/s-.00);\n}\n\nvec3 calcNormal(vec3 pos){\n  vec2 e = vec2(1,-1) * 0.005;\n  return normalize(\n    e.xyy*map(pos+e.xyy)+e.yyx*map(pos+e.yyx)+ \n    e.yxy*map(pos+e.yxy)+e.xxx*map(pos+e.xxx)\n  );\n}\n\nfloat march(vec3 ro, vec3 rd, float near, float far)\n{\n    float t=near,d;\n    for(int i=0;i<80;i++)\n    {\n        t+=d=map(ro+rd*t);\n        if (d<0.001) return t;\n        if (t>=far) return far;\n    }\n    return far;\n}\n\nfloat calcShadow( vec3 light, vec3 ld, float len ) {\n\tfloat depth = march( light, ld, 0.0, len );\t\n\treturn step( len - depth, 0.01 );\n}\n\nvoid mainImage( out vec4 fragColor, in vec2 fragCoord )\n{\n    vec2 uv = (fragCoord* 2.0 - iResolution.xy) / iResolution.y;\n    vec3 ro = vec3(0,0,8.);\n    vec3 rd = normalize(vec3(uv,-2.0));\n    vec3 col = vec3(0);\n\tconst float maxd = 40.0;\n    float t = march(ro,rd,0.0,maxd);\n    if(t<maxd)\n    {\n        vec3 p=ro+rd*t;\n        col=vec3(0.3,0.3,0.6)+cos(p*0.17)*0.5+0.5;\n        vec3 n = calcNormal(p);      \n\t\tvec3 lightPos=vec3(20);\n    \tvec3 li = lightPos - p;\n\t\tfloat len = length( li );\n\t\tli /= len;\n\t\tfloat dif = clamp(dot(n, li), 0.5, 1.0);\n        float sha = calcShadow( lightPos, -li, len );\n        col *= max(sha*dif, 0.4);\n        float rimd = pow(clamp(1.0 - dot(reflect(-li, n), -rd), 0.0, 1.0), 2.5);\n\t\tfloat frn = rimd+2.2*(1.0-rimd);\n    \tcol *= frn*.9;\n        col *= max(0.5+0.5*n.y, 0.0);\n        col *= exp2(-2.*pow(max(0.0, 1.0-map(p+n*0.3)/0.3),2.0));\n        col += vec3(0.5,0.9,0.9)*pow(clamp(dot(reflect(rd, n), li), 0.0, 1.0), 8.0);\n        col = mix(vec3(0),col,exp(-t*t*.003));\n    }\n    fragColor.xyz = col;\n}","name":"Image","description":"","type":"image"}]}