{"ver":"0.1","info":{"id":"Nsj3Wt","date":"1618121839","viewed":80,"name":"Mandelbox Rotation","username":"kithy","description":"mandelbox,fractal,raymarching","likes":2,"published":1,"flags":0,"usePreview":0,"tags":["raymarching","fractal","mandelbox"],"hasliked":0,"parentid":"","parentname":""},"renderpass":[{"inputs":[],"outputs":[{"id":"4dfGRr","channel":0}],"code":"#define MAX_STEPS 64\n#define ITR 10\n#define EPS 0.001\n\n//回転行列\nmat2 Rot(float a){\n\tfloat s=sin(a);\n\tfloat c=cos(a);\n\treturn mat2(c,-s,s,c);\n}\n\n//座標の複製\nvec3 rep(vec3 p,vec3 c){\n\tvec3 q=mod(p+0.5*c,c)-0.5*c;\n\treturn q;\n}\n\n//回転折りたたみ\nfloat sphereFold(vec3 p){\n\tfloat r2=dot(p,p);\n\tfloat dz;\n\tif(r2<0.5){\n\t\tfloat temp=2.0;\n\t\tp*=temp;\n\t\tdz*=temp;\n\t}\n\telse if(r2<1.0){\n\t\tfloat temp=1.0/r2;\n\t\tp*=temp;\n\t\tdz*=temp;\n\t}\n\treturn dz;\n}\n//boxFold?\nvoid boxFold(inout vec3 p,inout float dz){\n\tp=clamp(p,-1.0,1.0)*2.0-p;\n}\n//マンデルボックス\nfloat mandelbox(vec3 p){\n\t//p=mod(p,8.0)-4.0;\n\tfloat scale=3.0;\n\tvec3 offset=p;\n\tfloat dr=1.0;\n\tfor(int i=0;i<ITR;i++){\n\t\tboxFold(p,dr);\n\t\tsphereFold(p);\n\t\tp=scale*p+offset;\n\t\tdr=dr*abs(scale);\n\t}\n\tfloat r=length(p);\n\treturn r/abs(dr);\n}\n//メインの距離関数\nfloat mainDist(vec3 p){\n\tp.xy*=Rot(iTime*0.5);\n\tp.zx*=Rot(iTime*0.5);\n\treturn mandelbox(p);\t\n}\n///法線を導出\nvec3 genNormal(vec3 p){\n\treturn normalize(vec3(\n\t\tmainDist(vec3(p.x+EPS,p.y,p.z))-mainDist(vec3(p.x-EPS,p.y,p.z)),\n\t\tmainDist(vec3(p.x,p.y+EPS,p.z))-mainDist(vec3(p.x,p.y+EPS,p.z)),\n\t\tmainDist(vec3(p.x,p.y,p.z+EPS))-mainDist(vec3(p.x-EPS,p.y,p.z-EPS))\n\t\t));\n}\n\n\n//レイマーチング\nfloat rayMarch(vec3 ro,vec3 rd){\n\tfloat dO=0.0;\n\tfor(int i=0;i<MAX_STEPS;i++){\n\t\tvec3 p=ro+rd*dO;\n\t\tfloat dS=mainDist(p);\n\t\tdO+=dS;\n\t\tif(dS<EPS)break;\n\t}\n\treturn dO;\n}\n\n\nvoid mainImage(out vec4 fragColor,in vec2 fragCoord){\n\tvec2 uv=(2.0*fragCoord.xy-iResolution.xy)/iResolution.y;\n\tvec3 ro=vec3(0.0,0.0,-6.0);\n\tvec3 rd=normalize(vec3(uv,1.0));\n\n\tfloat d=rayMarch(ro,rd);\n\tvec3 n;\n\tvec3 r;\n\n\tif(d<float(MAX_STEPS)){\n\t\tvec3 p=ro+rd*d;\n\t\tn=genNormal(p);\n\t\tr=reflect(rd,n);\n\t}\n\n\tfragColor=vec4(cross(n,r)*2.0+0.5,1.0);\n}","name":"Image","description":"","type":"image"}]}