{"ver":"0.1","info":{"id":"clffRf","date":"1693251872","viewed":155,"name":"strange gondola ride","username":"pb","description":"changed from original, looks more solid now","likes":16,"published":1,"flags":32,"usePreview":0,"tags":["fractal","reflection","raymarch"],"hasliked":0,"parentid":"","parentname":""},"renderpass":[{"inputs":[{"id":"4dXGR8","filepath":"/media/previz/buffer00.png","previewfilepath":"/media/previz/buffer00.png","type":"buffer","channel":0,"sampler":{"filter":"linear","wrap":"clamp","vflip":"true","srgb":"false","internal":"byte"},"published":1}],"outputs":[{"id":"4dfGRr","channel":0}],"code":"//philip,bertani@gmail.com\n//Buffer A is where it is at\nvoid mainImage( out vec4 fragColor, in vec2 fragCoord )\n{\n    vec2 uv = fragCoord.xy/iResolution.xy;\n    vec2 texel = 1./iResolution.xy;\n    vec4 total_color;\n    for (int i=0;i<5;i++){\n        float fi = float(i)-2.;\n        for (int j=0;j<5;j++){ \n            float fj = float(j)-2.;\n            vec4 color = texture(iChannel0, \n                uv + vec2( texel.x*fi,texel.y*fj )  );\n            total_color += color * gk1s[i*5 + j];\n        }\n    }\n    fragColor = total_color;\n}\n","name":"Image","description":"","type":"image"},{"inputs":[],"outputs":[],"code":"float[] params = float[] ( \n0.,\n5.,\n-0.4,\n0.,\n-0.08,\n0.5,\n-0.6,\n0.,\n0.,\n0.,\n0.,\n0.,\n1.6,\n1.,\n0.,\n0.1,\n2.,\n0.,\n0.,\n-1.,\n2.,\n1.,\n0.,\n0.4,\n0.2,\n0.0,\n-5.,\n0.,\n.15,\n.4,\n0.,\n0.,\n0.\n);\n\n\n//gaussian_kernel_one_stdev\nfloat[] gk1s = float[] (\n        0.003765,0.015019,0.023792,0.015019,0.003765,\n        0.015019,0.059912,0.094907,0.059912,0.015019,\n        0.023792,0.094907,0.150342,0.094907,0.023792,\n        0.015019,0.059912,0.094907,0.059912,0.015019,\n        0.003765,0.015019,0.023792,0.015019,0.003765 );\n","name":"Common","description":"","type":"common"},{"inputs":[],"outputs":[{"id":"4dXGR8","channel":0}],"code":"#define extraReflection 1.  //set this to zero if your FPS is crashing - sorry\n\nfloat num_iter, objid, inf=1e6, too_small=1e-6, distToFloor;\nvec3 ifs_color, ro;\n\nfloat de(vec3 p) {\n    vec4 q = vec4(p, 6.);\n    float nn=1.;\n    q.xz = mod(q.xz + nn, 2.*nn) - nn;\n    q.xyz -= 1.;\n    num_iter = 0.;\n    float i=0.;\n    for(; i < params[1]; i++) {\n        q.xyz = abs(q.xyz + (1.+params[32])*1.0) - (1.+params[32])*1.0*(1.+q.xyz/50.*(1.+params[19]));\n        q /= clamp(dot(q.xyz, q.xyz), 0.4+params[2], 1.0+params[3]);\n        q *= 1.2 * (1.+params[4]);\n        q *= 1. + (params[30])*q.y;\n        num_iter = i;\n    }\n    \n    float d2 = length( max( abs(q.xyz) - vec3(1.2+params[5],1.2+params[6], 1.2+params[18]), 0.0) )/q.w;\n    float d1 = p.y  + .6 + 1.4 + .2*sin(p.x+iTime) - 1.7*cos(d2*(1.+sin(iTime*5.)))* exp(-d2/5.) ; \n   \n    objid = 0.0;\n    if ( d1 < d2 ) objid = 1.; \n    distToFloor = d1;\n    return min(d1 , d2);\n}\n\nfloat march(vec3 ro, vec3 rd, float mx) {\n    float t = 0.0;\n    float eps = 1e-5, distfac=10.;\n    float hitThreshold = eps;\n    for(int i = 0; i < 100; i++) {\n        float d = de(ro + rd*t);\n        if (d < hitThreshold || t >= mx) break;\n        t += d;\n        hitThreshold = eps*(1.+t*distfac);\n    }\n    return t;\n}\n\n\nvec3 phong(\n  in vec3 pt,\n  in vec3 prp,\n  in vec3 normal,\n  in vec3 light,\n  in vec3 color,\n  in float spec,\n  in vec3 ambLight)\n{\n   vec3  lightv=normalize(light-pt);\n   float diffuse=dot(normal,lightv);\n   vec3  refl=-reflect(lightv,normal);\n   vec3  viewv=normalize(prp-pt);\n   float specular=pow(max(dot(refl,viewv),0.0),spec+params[20]);\n   return .5*max(diffuse,0.)*(color) + .5*specular*vec3(.3,.6,1.);  \n}\n\nvec3 normal(vec3 p, float dist) {\n    vec2 h = vec2(0.01 + params[25] + dist/100., 0.0);\n    vec3 n = vec3(\n        de(p + h.xyy) - de(p - h.xyy),\n        de(p + h.yxy) - de(p - h.yxy),\n        de(p + h.yyx) - de(p - h.yyx));\n    return normalize(n);\n}\n\n\nvec3 render(vec3 ro, vec3 rd) {\n    vec3 col = vec3(0.);\n    vec3 light_dir =  ro;\n    vec3 color     = vec3( params[27], params[28], params[29]);\n    float specular_power = 2.;\n    vec3 ambient_light = vec3(.1);\n    vec3 floor_color = vec3(.01,.1,.1);\n    float t = march(ro, rd, 100.0);\n    if(t < 100.0) {\n        vec3 pos = ro + rd*t;\n        vec3 nor = normal(pos, t);        \n        vec3 cf = phong( pos, ro, nor, light_dir, color, specular_power, ambient_light);       \n        col = cf * (1.-objid); \n        \n        if (params[21] > 0. ) {  //first reflection\n            vec3 pos2 = ro + rd*.999*t; \n            vec3 ref = reflect(rd, nor);\n            float tt =  march( pos2, ref, 100.);\n\n            if ( tt < 100.) {\n                vec3 ppos = pos2 + ref*tt;\n                vec3 nnor = normal(ppos, tt);\n                vec3 rref = reflect(ref, nnor);\n                vec3 cf2 = phong( ppos, ro, nnor, light_dir, color, specular_power, ambient_light); \n                col += params[23] * cf2 * (1.-objid);                    \n  \n                col *= exp(-tt-.5*distToFloor);\n\n              if ( (params[21] + extraReflection) > 1.) {  //second reflection\n                vec3 pos3 = pos2  + ref*.999*tt;\n                float ttt = march( pos3, rref, 150.);\n                if (ttt < 150. ) {\n                   vec3 pppos = pos3 + rref * ttt;\n                   vec3 nnnor = normal(pppos, ttt);\n                   vec3 cf3 = phong( pppos, ro, nnnor, light_dir, color, specular_power, ambient_light);\n                   col += params[24] * cf3 * (1.-objid);\n \n                   col *= exp(-ttt-.5*distToFloor);\n                }\n              }\n            }\n        }\n        \n        col = clamp(col, 1e-6,inf);\n        col *= 60.*exp(-.081*(1.+params[13])*t*t);\n    }\n    return col;\n}\n\n\nvoid mainImage( out vec4 fragColor, in vec2 fragCoord )\n{\n    vec2 p  = (2.*fragCoord.xy-iResolution.xy)/iResolution.y*2.;\n    \n    ro = vec3(0.,0.2,iTime/5.);\n    vec3 rd = normalize( vec3(p,1.9) );\n    \n    float s2 = 1./sqrt(2.);\n    rd.xz *= mat2(s2,-s2,s2,s2);\n    \n    \n    vec3 col = render(ro, rd);\n    col = 1. - exp(-.5 * (1.+params[16]) * col);\n    \n    fragColor = vec4( col, 1.);\n\n}","name":"Buffer A","description":"","type":"buffer"}]}