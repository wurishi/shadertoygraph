{"ver":"0.1","info":{"id":"tdKXWw","date":"1574542275","viewed":84,"name":"Permutation","username":"nolibab","description":"Port compo 'Permutation 23' release for Buenzli party 2012 coded by bitphallus.\nAdd rotation.","likes":3,"published":1,"flags":0,"usePreview":0,"tags":["reflection","raymarch","permutation"],"hasliked":0,"parentid":"","parentname":""},"renderpass":[{"inputs":[],"outputs":[{"id":"4dfGRr","channel":0}],"code":"\n#define EPSILON 0.0001\n#define R0 1.0\n#define ETA 1.07\n\nfloat x = 0.;\nvec2 d;\n\n\nvec2 rotate(vec2 p, float t) \n{\nreturn p * cos(-t) + vec2(p.y, -p.x) * sin(-t);\n}\n\n\nfloat m(vec3 v)\n{\nv.yz = rotate(v.yz, -iTime * 0.125);\nv.zx = rotate(v.zx, iTime * 0.2);   \n    \nv.yz=cos((.5*x))*v.yz+sin((.5*x))*vec2(v.z,-v.y);\nv.xz=cos((.5*x))*v.xz+sin((.5*x))*vec2(v.z,-v.x);\nfloat m=length(v);\nv=abs(normalize(v));\nv=mix(mix(v.zxy,v.yzx,step(v.z,v.y)),v,step(v.y,v.x)*step(v.z,v.x));\nfloat f=max(max(dot(v,vec3(.577)),dot(v.xz,vec2(.934,.357))),\nmax(dot(v.yx,vec2(.526,.851)),dot(v.xz,vec2(.526,.851))));\nf=acos(f-.01)/1.57075;\nf=smoothstep(.25,0.,f);\nreturn m-2.-f*f*.7;\n}\n\n\nfloat m(vec3 v,vec3 x)\n{\nvec3 m=abs(v)-x;\nfloat y=max(m.x,max(m.y,m.z));\nreturn mix(y,length(max(m,0.)),step(0.,y));\n}\n\nfloat t(vec3 v)\n{\nfloat f=dot(v-vec3(0.,-5.,0.),vec3(0.,1.,0.));\nf=min(f,-length(v)+150.);\nf=min(f,length(v-vec3(3.,0.,0.)-1.));\nreturn min(f,m(v-vec3(0.,0.,0.),vec3(1.)));\n}\n\nfloat p(vec3 v)\n{\nreturn t(v);\n}\n\nvec2 m(vec3 v,vec3 y,vec4 m)\n{\nvec3 x=m.xyz-v;\nfloat f=dot(x,y),d=dot(x,x);\nif(f<0.&&d>m.w) return vec2(0.);\nfloat z=d-f*f;\nif(z>m.w) return vec2(0.);\nfloat s=sign(d-m.w);\nreturn vec2(EPSILON*step(z,m.w)*s,f-sqrt(m.w-z)*s);\n}\n\nvec2 p(vec3 v,vec3 m,vec4 x)\n{\nfloat y=-dot(m,x.xyz), f=(dot(v,x.xyz)-x.w)/y;\nreturn vec2(EPSILON*sign(y)*step(0.,f),f);\n}\n\nvec2 m(vec3 v,vec3 y,vec3 m,vec3 x)\n{\nvec3 f=m-x,d=m+x,s=(f-v)/y,z=(d-v)/y,a=min(s,z),p=max(s,z);\nfloat e=min(p.x,min(p.y,p.z)),E=max(max(a.x,0.),max(a.y,a.z));\nvec3 i=step(f,v),w=step(v,d);\nfloat t=step(3.,dot(i,w));\nreturn vec2(EPSILON*(t*-2.+1.)*step(E,e),mix(E,e,t));\n}\n\nvec2 p(vec3 v,vec3 f)\n{\nvec2 s=m(v,f,vec4(0.,-2.,0.,251.203));\nvec3 d=v;\nif(s.x==0.) return s;\nif(s.x>0.) v+=f*s.y;\ns.x=sign(m(v));\nf*=s.x;\nfloat x=0.,y=0.;\nfloat i=0.;\n\ndo\n {\n y=m(v);\n v+=y*f*.5;\n y=abs(y);\n x+=y;\n if(y<x*.001) break;\n i+=1./150.;\n if(i>=1.)break;       \n }\nwhile(i<1.);\n    \nif(i>=1.) return vec2(0.);\ns.x*=y*2.;\ns.y=length(d-v);\nreturn s;\n}\n\n\nvec3 t(vec3 v,vec3 y)\n{\nvec2 f;\nvec3 x=vec3(0.,500.,-1.);\nf=p(v,y,vec4(0.,1.,0.,-5.));\nx=mix(x,vec3(f,0.),abs(sign(f.x))*step(f.y,x.y)*step(0.,f.y));\nf=m(v,y,vec4(0.,0.,0.,22500.));\nf.x*=-1.;\nx=mix(x,vec3(f,1.),abs(sign(f.x))*step(f.y,x.y)*step(0.,f.y));\nf=p(v,y);\nx=mix(x,vec3(f,2.),abs(sign(f.x))*step(f.y,x.y)*step(0.,f.y));\nreturn x;\n}\n\nfloat p(vec3 v,vec3 x,float f,float y_)\n{\nfloat y=y_;\nfloat m=sign(f),d=m*.5+.5;\nwhile(y>0.) \n\t{\n    d-=(y*f-p(v+f*x*y*m))/exp2(y);\n    y-=1.;\n\tif(y<=0.) break;\n    }\nreturn clamp(d,0.,1.);\n}\n\nvec4 m(inout vec3 v,vec3 y,vec3 f,out vec3 d,out bvec2 i)\n{\nvec4 s=vec4(0.);\nd=vec3(0.);\ni=bvec2(false,false);\nv+=y*f.y;\nvec3 z=normalize(vec3(0.,35.,0.)+10.*vec3(cos(x*2.),0.,sin(x*2.))-v);\nif(f.z==0.)\n {\n i=bvec2(false,false);\n d=vec3(0.,1.,0.);\n s=.5*vec4(1.,1.,1.,1.);\n s*=max(dot(d,z),0.);\n s+=.2;\n s*=p(v,z,.3,1.);\n float e=.25;\n vec2 n=fwidth(v.xz),a=n*e*2.;\n float w=max(a.x,a.y);\n vec2 t=fract(v.xz*e),l=smoothstep(vec2(.5),a+vec2(.5),t)+(1.-smoothstep(vec2(0.),a,t));\n vec4 E=vec4(.8),N=vec4(.1),o=E*.5+N*.5,r=mix(E,N,l.x*l.y+(1.-l.y)*(1.-l.x));\n r=mix(r,o,smoothstep(.125,.75,w));\n s*=r;\n }\nelse if(f.z==1.)i=bvec2(false,false),d=-normalize(v),\ns=.5*vec4(1.,1.,1.,1.),s*=max(dot(d,z),0.),s*=p(v,z,.3,6.);\nelse if(f.z==2.)\n {i=bvec2(true,true);\n vec2 a=vec2(.1,0.);\n d=normalize(vec3(m(v+a.xyy)-m(v-a.xyy),m(v+a.yxy)-m(v-a.yxy),m(v+a.yyx)-m(v-a.yyx)));\n s=vec4(1.);\n s*=.5*max(dot(d,z),0.);\n s+=2.*pow(max(dot(reflect(z,d),y),0.),16.);\n }\nreturn s;\n}\n\nfloat n(vec3 v,vec3 y)\n{\nreturn R0+(1.-R0)*pow(1.-abs(dot(y,v)),4.);\n}\n\n\nvoid mainImage( out vec4 fragColor, in vec2 fragCoord )\n{\nd = iResolution.xy;    \nvec3 x=vec3(0.,5.,80.),\nf=normalize(vec3(0.,0.,0.)-x),\ny=normalize(vec3(0.,1.,0.)),\ns=cross(f,y),\ni=vec3(0.,0.,0.),\nz=normalize(vec3(vec2(d.x/d.y,1.)*(fragCoord.xy/d-.5),16.));\ni+=x;\n\nz*=transpose(mat3(s,y,f));\n\nvec3 a=t(i,z);\nif(a.x==0.)\n {\n fragColor=vec4(1.,1.,1.,1.);\n return;\n }\nvec3 e;\nbvec2 w;\nvec4 r=m(i,z,a,e,w),p=mix(exp(-a.y*vec4(2.,.5,.3,1.)),vec4(1.),sign(a.x)*.5+.5);\nvec3 E=i,l=z,o=a,b=e;\nbvec2 c=w;\nfloat k=1.;    \nfor(float N=0.;N<3.;++N)\n {\n k*=n(z,e);\n z=reflect(z,e);\n i+=e*a.x;a=t(i,z);\n if(a.x==0.) break;\n r+=m(i,z,a,e,w)*k;\n if(w.x==false)break;    \n }\nw=c,e=b,a=o,z=l,i=E;\n\n k=1.;   \n for(float N=0.;N<6.;++N)\n {\n vec3 A=z;\n p*=1.-n(z,e);\n z=refract(z,e*sign(a.x),mix(ETA,1./ETA,sign(a.x)*.5+.5));\n if(dot(z,z)==0.) z=reflect(A,e),a.x*=-1.;\n i-=e*a.x;\n a=t(i,z);\n if(a.x==0.) break;\n p*=mix(exp(-a.y*1.3*vec4(.1,.3,.5,1.)),vec4(1.),sign(a.x)*.5+.5);\n r+=m(i,z,a,e,w)*p;\n if(w.y==false)break;    \n }\nfragColor = r;\n}\n","name":"Image","description":"","type":"image"}]}