{"ver":"0.1","info":{"id":"lt23WK","date":"1432641104","viewed":1724,"name":"Knotting","username":"shezard","description":"Testing knots","likes":28,"published":1,"flags":0,"usePreview":0,"tags":["knot"],"hasliked":0,"parentid":"","parentname":""},"renderpass":[{"inputs":[],"outputs":[],"code":"#define PI 3.14\n#define TAU 6.28318530718\n\nvec3 rgb2hsv(vec3 c) {\n    vec4 K = vec4(0.0, -1.0 / 3.0, 2.0 / 3.0, -1.0);\n    vec4 p = mix(vec4(c.bg, K.wz), vec4(c.gb, K.xy), step(c.b, c.g));\n    vec4 q = mix(vec4(p.xyw, c.r), vec4(c.r, p.yzx), step(p.x, c.r));\n\n    float d = q.x - min(q.w, q.y);\n    float e = 1.0e-10;\n    return vec3(abs(q.z + (q.w - q.y) / (6.0 * d + e)), d / (q.x + e), q.x);\n}\n\nvec3 hsv2rgb(vec3 c) {\n    vec4 K = vec4(1.0, 2.0 / 3.0, 1.0 / 3.0, 3.0);\n    vec3 p = abs(fract(c.xxx + K.xyz) * 6.0 - K.www);\n    return c.z * mix(K.xxx, clamp(p - K.xxx, 0.0, 1.0), c.y);\n}\n\nfloat noise(in vec2 uv) {\n\treturn sin(1.5*uv.x)*sin(1.5*uv.y);\n}\n\nconst mat2 m = mat2( 0.80,  0.60, -0.60,  0.80 );\n\nfloat fbm(vec2 uv) {\n    float f = 0.0;\n    f += 0.5000*noise(uv); uv = m*uv*2.02;\n    f += 0.2500*noise(uv); uv = m*uv*2.03;\n    f += 0.1250*noise(uv); uv = m*uv*2.01;\n    f += 0.0625*noise(uv);\n    return f/0.9375;\n}\n\nfloat fbm2(in vec2 uv) {\n   vec2 p = vec2(fbm(uv + vec2(0.0,0.0)),\n                 fbm(uv + vec2(5.2,1.3)));\n\n   return fbm(uv + 4.0*p);\n}\n\nfloat rand(in vec2 uv) {\n    return fract(sin(dot(uv.xy ,vec2(12.9898,78.233))) * 43758.5453);\n}\n\nvec2 add(in vec2 a, in vec2 b) {\n \n    float mat;\n    if(a.x < b.x) {\n      mat = a.y;\n    } else {\n      mat = b.y;\n    }\n    \n    return vec2(min(a.x,b.x), mat);\n}\n\nvec2 sub(in vec2 a, in vec2 b) {\n    \n    float mat;\n    if(a.x < b.x) {\n      mat = b.y;\n    } else {\n      mat = a.y;\n    }\n    \n    return vec2(max(a.x, b.x), mat);\n}\n\nvec3 rep(in vec3 p, in vec3 c) {\n    vec3 q = mod(p,c)-0.5*c;\n    return q;\n}\n\nvec2 rotate(in vec2 p, in float ang) {\n    float c = cos(ang), s = sin(ang);\n    return vec2(p.x*c - p.y*s, p.x*s + p.y*c);\n}\n\nvec2 torus(in vec3 p, in vec2 t, in float mat) {\n  vec2 q = vec2(length(p.xz)-t.x,p.y);\n  return vec2(length(q)-t.y, mat);\n}\n\nvec2 sphere(in vec3 p, in float r, in float mat) {\n    return vec2(length(p) - r, mat);\n}\n\nvec2 plane(in vec3 p, in vec4 n, in float mat) {\n  return vec2(dot(p,n.xyz) + n.w, mat);\n}\n\nvec2 cylinder(in vec3 p, in vec3 c, in float mat) {\n  return vec2(length(p.xz-c.xy)-c.z, mat);\n}\n\nvec2 box(in vec3 p, in vec3 b, in float mat) {\n  return vec2(length(max(abs(p)-b,0.0)), mat);\n}\n\n// WIP\nfloat trans(in float x, in vec2 p) {\n   return mod(x, 0.001*TAU) - 0.001*TAU / 2.0;\n}\n\n\nvec2 knot(in vec3 p, in float k, in float mat) {\n    float r = length(p.xy);\n    float oa, a = atan(p.y, p.x); \n    oa = k*a;\n    a = trans(a, p.xy);\n    \n    p.xy = r*vec2(cos(a), sin(a)); p.x -= 6.0;\n    p.xz = cos(oa)*p.xz + sin(oa)*vec2(-p.z, p.x);\n    p.x = abs(p.x) - 1.35; \n    return vec2(length(p) - 1.0, mat);\n}\n\nfloat map(in vec3 p, inout float mat) {\n   \n   p.z = cos(p.z);\n    \n   vec2 scene = vec2(999.0, 0.0);\n   \n    // TODO : see how to interpolate between rate N and N+1\n   float rate = 1.0; // mod(iTime, 3.0);\n   \n   float r1 = floor(rate);\n   float r2  = floor(rate) + 1.0;\n    \n   vec2 k = knot(p, r1, length(p+fbm2(p.xy))*.1);\n    \n   vec2 k2 = knot(p, r2, length(p+fbm2(p.xy))*.1);\n    \n   float y = 0.5 + cos(iTime) * 0.5;\n    \n   scene = add(scene,mix(k,k2,y));\n    \n   mat = scene.y;\n   return scene.x;\n}\n\nmat3 setLookAt(in vec3 ro, in vec3 ta,in float cr) {\n\tvec3  cw = normalize(ta-ro);\n\tvec3  cp = vec3(sin(cr), cos(cr),0.0);\n\tvec3  cu = normalize( cross(cw,cp) );\n\tvec3  cv = normalize( cross(cu,cw) );\n    return mat3( cu, cv, cw );\n}\n\nfloat softshadow(in vec3 ro, in vec3 rd, in float mint, in float tmax) {\n\tfloat res = 1.0;\n    float t = mint;\n    \n    float mat = 0.0;\n    \n    for( int i = 0; i < 16; i++ ) {\n\t\tfloat h = map(ro + rd*t, mat);\n        res = min( res, 4.0*h/t );\n        t += clamp( h, 0.02, 0.10 );\n        if( h<0.001 || t>tmax ) break;\n    }\n    return clamp( res, 0.0, 1.0 );\n}\n\nvoid mainImage( out vec4 fragColor, in vec2 fragCoord ) {\n\tvec2 uv = fragCoord.xy / iResolution.xy;\n    vec2 p = -1.0 + 2.0*uv;\n    p.x *= iResolution.x / iResolution.y;\n    \n    // camera\t\n    vec3 ro = vec3(\n        0.0,\n        0.0,\n        16.0+iTime*5.0\n   \t);\n    vec3 ta = vec3(0.0,0.0,0.0);\n    float roll = iTime*.1;\n\n    // camera tx\n    mat3 ca = setLookAt( ro, ta, roll );\n    vec3 rd = normalize( ca * vec3(p.xy,1.75) );\n\n    float t = 0.001;      // Near\n    float tmax = 120.0; // Far\n   \t\n    float h = 0.001;\n    float hmax = 0.001;\n    \n    float mat = 0.0;\n    \n    vec3 c = vec3(0.0);\n    vec3 ao = vec3(0.0);\n    \n    const int steps = 100;\n    for(int i = 0 ; i < steps ; i++) {\n        \n        if(h < hmax || t > tmax ) {\n        \tao = vec3(1.0) - float(i)/float(steps);\n            break;\n        }\n        \n        h = map(ro + t *rd, mat);\n        t += h;\n    }\n    \n    if(t < tmax) {\n        vec3 pos = ro+rd*t;\n        \n        vec2 r = vec2(0.001,0.0);\n        vec3 nor = normalize(vec3(map(pos+r.xyy, mat)-map(pos-r.xyy, mat),\n                                  map(pos+r.yxy, mat)-map(pos-r.yxy, mat),\n                                  map(pos+r.yyx, mat)-map(pos-r.yyx, mat)));\n      \tvec3 ref = reflect(rd,nor);\n        \n        c = vec3(1.0,1.2,1.1);;\n        \n        if(mat == 0.0) {\n            c = vec3(0.0);\n        } else {\n            c = vec3(.5,.1,.3);\n            \n            c = rgb2hsv(c);\n            \n            c.x += mat+.1 + pos.z*.1;\n            c.y = .85;\n            c.z = 1.4;\n            \n            c = hsv2rgb(c);\n        }\n        \n        float power = 8.0;\n        ao = vec3(pow(ao.x,power),pow(ao.y,power),pow(ao.z,power));\n        \n        c *= 1.0 - exp(1.0 / log(ao));\n    } else {\n        c = vec3(0.);\n    }\n    \n\tfragColor = vec4(c,1.0);\n}","name":"Image","description":"","type":"image"}]}