{"ver":"0.1","info":{"id":"7ljXDR","date":"1628399645","viewed":103,"name":"naive cloud","username":"yunhai","description":"my first try for volumetric Ray Marching a cloud without properly lighting and a bunch of other details.\nI will try to improve it later~,\ndrag your mouse could change your direction of view. q_q\n","likes":5,"published":1,"flags":0,"usePreview":0,"tags":["try"],"hasliked":0,"parentid":"","parentname":""},"renderpass":[{"inputs":[{"id":"XsfGzn","filepath":"/media/a/585f9546c092f53ded45332b343144396c0b2d70d9965f585ebc172080d8aa58.jpg","previewfilepath":"/media/ap/585f9546c092f53ded45332b343144396c0b2d70d9965f585ebc172080d8aa58.jpg","type":"cubemap","channel":1,"sampler":{"filter":"mipmap","wrap":"clamp","vflip":"false","srgb":"false","internal":"byte"},"published":1},{"id":"4sfGRr","filepath":"/media/a/27012b4eadd0c3ce12498b867058e4f717ce79e10a99568cca461682d84a4b04.bin","previewfilepath":"/media/ap/27012b4eadd0c3ce12498b867058e4f717ce79e10a99568cca461682d84a4b04.bin","type":"volume","channel":0,"sampler":{"filter":"mipmap","wrap":"repeat","vflip":"true","srgb":"false","internal":"byte"},"published":1}],"outputs":[{"id":"4dfGRr","channel":0}],"code":"#define NOLIGHT\n\nvec4 S=vec4(0,0,0,1.9);\nfloat density(vec3 p)\n{\n    #define T(p) texture(iChannel0,(p*.4+vec3(iTime*.1))*.2).x\n    float n1=T(p)*.5+\n             T(p*2.)*.25+\n             T(p*4.)*.125;\n    float l=length(p-S.xyz);\n    return (-l+S.w*(pow((n1-.2)*.8,3.)*6.+.75))*(n1+.5)*max((-abs(p.y)*2.+3.)*2.,0.)*.6/pow((l+.9),2.);\n}\nfloat od(Ray r,float steps)\n{\n    float ds=4./steps;\n    vec3 p=r.o+r.d*.5*ds;\n    float sum=density(p),times=1.;\n    for(float i=1.;i<steps;i+=1.)\n    {\n        //cull\n        vec3 l=p-S.xyz;\n        if(dot(l,l)>S.w*S.w)\n            break;\n        float den=density(p);\n        if(den>0.)\n            sum+=den,\n            times++;\n        \n        p+=r.d*ds;\n    }\n    return sum/times;\n}\n\nvoid mainImage( out vec4 O, in vec2 C )\n{\n    vec2 uv=(C-iR*.5)/iR.y;\n    float cRotX=-iM.x*4.*PI/iR.x,\n          cRotY=-(iM.y/iR.y-.5)*PI*.9,cy=cos(cRotY);\n    if(iM.x<10.)\n         cRotX=iT*.5,\n         cRotY=-1.*PI*.9,cy=cos(cRotY);\n    vec3 camPos=vec3\n        (cy*cos(cRotX),sin(cRotY),cy*sin(cRotX))*5.;\n    vec3 lookat=vec3(0);\n    Ray r=Ray(camPos,normalize(\n          getCamMat(camPos,lookat)*vec3(uv,1)));\n    vec3 ligPos=vec3(10,10,10)*.3;\n    float ds=MAX_DIST/MAX_STEP;\n    float inacc=0.;\n    float sumc=0.;\n    //cull\n    if(iS(r,S)>0.)\n    {\n        for(float i=0.;i<MAX_STEP;i++)\n        {\n            vec3 p=r.o+r.d*(i+.5)*ds;\n            //cull\n            vec3 l=p-S.xyz;\n            if(dot(l,l)>S.w*S.w)\n                continue;\n            float den=max(0.,density(p));\n            inacc+=den*ds;\n            #ifndef NOLIGHT\n            vec3 ld=normalize(ligPos-p);\n            sumc+=exp(-.2*(od(Ray(p,-r.d),10.)+od(Ray(p,ld),10.)))*ds*den;\n            #endif\n        }\n    }\n    \n    \n    float trans=exp(-inacc*1.);\n    \n    vec3 bg=texture(iChannel1,r.d).xyz*.6;\n    \n\n#ifdef NOLIGHT\n    O.rgb=mix(vec3(1),bg,trans*1.1);\n#else\n    O.rgb=mix(bg,vec3(1),sumc*.5);\n#endif\n    \n}","name":"Image","description":"","type":"image"},{"inputs":[],"outputs":[],"code":"#define PI 3.14159265\n#define iR iResolution.xy\n#define iT iTime\n#define iM iMouse.xy\n#define MAX_DIST 10.\n#define MAX_STEP 20.\nstruct Ray{vec3 o,d;};\nfloat iS(Ray r,vec4 s)\n{\n    vec3 co=r.o-s.xyz;\n    float b=2.*dot(co,r.d),c=dot(co,co)-s.w*s.w;\n    float delta=b*b-4.*c;\n    if(delta<0.)\n        return -1.;\n    if(c<0.)\n        return (-b+sqrt(delta))/2.;\n    if(b>0.)\n        return -1.;\n    return (-b-sqrt(delta))/2.;\n}\n/*\nfloat sdCube(vec3 p,vec3 size)\n{\n    vec3 r=abs(p)-size*.5;\n    float o=length(max(r,0.));\n    float i=min(max(r.x,max(r.y,r.z)),0.);\n    return o+i;\n}\n*/\nmat3 getCamMat(vec3 camPos,vec3 lookat)\n{\n    vec3 cf=normalize(lookat-camPos),\n         cr=cross(vec3(0,1,0),cf),\n         cu=cross(cf,cr);\n    return mat3(cr,cu,cf);\n}\n","name":"Common","description":"","type":"common"}]}