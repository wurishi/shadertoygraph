{"ver":"0.1","info":{"id":"WlsyD7","date":"1592239057","viewed":162,"name":"railway forksong","username":"darkfox","description":"\"I've Been Working on the Railroad\" (American fork.)\nreference:https://www.youtube.com/watch?v=pP3asnGN6f0\nreference:https://www.youtube.com/watch?v=YJhzwe0KUDA","likes":5,"published":1,"flags":8,"usePreview":0,"tags":["sound"],"hasliked":0,"parentid":"","parentname":""},"renderpass":[{"inputs":[{"id":"4dXGzr","filepath":"/media/a/08b42b43ae9d3c0605da11d0eac86618ea888e62cdd9518ee8b9097488b31560.png","previewfilepath":"/media/ap/08b42b43ae9d3c0605da11d0eac86618ea888e62cdd9518ee8b9097488b31560.png","type":"texture","channel":0,"sampler":{"filter":"mipmap","wrap":"repeat","vflip":"true","srgb":"false","internal":"byte"},"published":1}],"outputs":[{"id":"4dfGRr","channel":0}],"code":"#define pi 3.14159\n\n// palette.\n#define GREEN vec3(0.13, 0.69, 0.29)\n#define RED vec3(1.0, 0.4, 0.3)\n#define BLUE vec3(0.4, 0.6, 1.0)\n#define ORANGE vec3(0.9, 0.6, 0.05)\n#define SKYBLUE vec3(0.0, 0.65, 0.9)\n\n// space.\n#define Ch_sp 127\n// double quotation.\n#define Ch_dq 168\n// period, comma, apostrophe.\n#define Ch_prd 46\n#define Ch_com 44\n#define Ch_apt 39\n\n// notes.\n#define Ch_n8 10\n\n// small alphabets.\n#define Ch_a 97\n#define Ch_b 98\n#define Ch_c 99\n#define Ch_d 100\n#define Ch_e 101\n#define Ch_f 102\n#define Ch_g 103\n#define Ch_h 104\n#define Ch_i 105\n#define Ch_j 106\n#define Ch_k 107\n#define Ch_l 108\n#define Ch_m 109\n#define Ch_n 110\n#define Ch_o 111\n#define Ch_p 112\n#define Ch_q 113\n#define Ch_r 114\n#define Ch_s 115\n#define Ch_t 116\n#define Ch_u 117\n#define Ch_v 118\n#define Ch_w 119\n#define Ch_x 120\n#define Ch_y 121\n#define Ch_z 122\n\n// draw character\nvec2 getCodePos(float code){\n    return vec2(mod(code, 16.0), 15.0 - floor(code / 16.0));\n}\n\nvec4 getCharLU(int charCode, vec2 p, vec2 lu, vec2 size, vec4 col){\n    // size: right, down.\n    float code = float(charCode);\n    if(p.x < lu.x || p.x > lu.x + size.x || p.y > lu.y || p.y < lu.y - size.y){\n        return vec4(0.0);\n    }\n\n    vec2 co = vec2(p.x - lu.x, lu.y - p.y) / size;\n    co.y = 1.0 - co.y;\n\n    vec4 tex = texture(iChannel0, (co + getCodePos(code)) / 16.0);\n    if(tex.r < 0.5 * (tex.g + tex.b)){ return vec4(0.0); }\n    return col;\n}\n\nvec4 Ch(vec2 p, int CharCode, float x, float y, float alpha){\n    return getCharLU(CharCode, p, vec2(x, y), vec2(0.08, 0.1), vec4(SKYBLUE, alpha));\n}\n\n// white keys(16)\n// y:0.0～0.4\nvoid drawWhiteKey(in vec2 p, inout vec3 col, float n, bool isPressed){\n    vec2 pos = vec2((n * 2.0 + 1.0) / 32.0, 0.2);\n    vec2 size = vec2(0.9 / 32.0, 0.2);\n    if(abs(p.x - pos.x) > size.x || abs(p.y - pos.y) > size.y){ return; }\n    if(isPressed){ col = RED; return; }\n    col = vec3(0.9);\n}\n\n// black keys(17)\n// y:0.18～0.4\nvoid drawBlackKey(in vec2 p, inout vec3 col, float n, bool isPressed){\n    vec2 pos = vec2(n / 16.0, 0.29);\n    vec2 size = vec2(0.8 / 32.0, 0.11);\n    if(abs(p.x - pos.x) > size.x || abs(p.y - pos.y) > size.y){ return; }\n    if(isPressed){ col = BLUE; return; }\n    col = vec3(0.1);\n}\n\nfloat getCurrentNote(){\n    float prevTerm = 0.0;\n    for(int i = 0; i < note_count; i++){\n        // a bit shorten.\n        if(prevTerm < iTime && iTime < prevTerm + sus[i] * unit * 0.85){\n            return float(notes[i]);\n        }\n        prevTerm = term[i] * unit;\n    }\n    return -1.0;\n}\n\nvoid mainImage( out vec4 fragColor, in vec2 fragCoord )\n{\n    \n    vec2 p = fragCoord.xy / iResolution.xy;\n    vec2 st = fragCoord.xy / min(iResolution.x, iResolution.y);\n\n    vec3 col = mix(SKYBLUE, vec3(1.0), p.y); // background.\n\n    float cur = getCurrentNote(); // current note.\n\n    for(float n = 0.0; n < 16.0; n += 1.0){\n        drawWhiteKey(p, col, n, n == cur);\n    }\n    for(float n = 0.0; n < 17.0; n += 1.0){\n        if(mod(n, 7.0) == 0.0 || mod(n, 7.0) == 4.0){ continue; }\n        drawBlackKey(p, col, n, n - 0.5 == cur);\n    }\n    \n    const int titleLength1 = 37;\n    int title1[titleLength1] = int[titleLength1](Ch_n8, Ch_dq,\n                            Ch_i, Ch_apt, Ch_v, Ch_e, Ch_sp,\n                            Ch_b, Ch_e, Ch_e, Ch_n, Ch_sp,\n                            Ch_w, Ch_o, Ch_r, Ch_k, Ch_i, Ch_n, Ch_g, Ch_sp,\n                            Ch_o, Ch_n, Ch_sp, Ch_t, Ch_h, Ch_e, Ch_sp,\n                            Ch_r, Ch_a, Ch_i, Ch_l, Ch_r, Ch_o, Ch_a, Ch_d,\n                            Ch_prd, Ch_dq);\n\n    const int titleLength2 = 16;\n    int title2[titleLength2] = int[titleLength2](Ch_n8, Ch_dq,\n                            Ch_t, Ch_e, Ch_t, Ch_s, Ch_u, Ch_d, Ch_o, Ch_sp,\n                            Ch_s, Ch_h, Ch_o, Ch_k, Ch_a, Ch_dq);\n    vec4 texts = vec4(0.0);\n    vec2 textAlpha = vec2(1.0);\n    \n    for(int i = 0; i < titleLength1; i++){\n        if(iTime < 96.0 * unit){\n            textAlpha.x = 0.5 + 0.5 * cos(iTime * pi * 2.0);\n        }\n        texts += Ch(st, title1[i], 0.1 + 0.04 * float(i), 0.85, textAlpha.x);\n    }\n    for(int i = 0; i < titleLength2; i++){\n        if(96.0 * unit < iTime && iTime < 140.0 * unit){\n            textAlpha.y =  0.5 + 0.5 * cos(iTime * pi * 2.0);\n        }\n        texts += Ch(st, title2[i], 0.1 + 0.04 * float(i), 0.65, textAlpha.y);\n    }\n    \n    fragColor = mix(vec4(col, 1.0), texts, texts.a);\n}","name":"Image","description":"","type":"image"},{"inputs":[],"outputs":[],"code":"// common constants, functions, etc...\n\n// keyboard code. (sharp key is fractional.)\nconst float _RA = 2.0;\nconst float _RASP = 2.5;\nconst float _SI = 3.0;\nconst float DO = 4.0;\nconst float DOSP = 4.5;\nconst float RE = 5.0;\nconst float RESP = 5.5;\nconst float MI = 6.0;\nconst float FA = 7.0;\nconst float FASP = 7.5;\nconst float SO = 8.0;\nconst float SOSP = 8.5;\nconst float RA = 9.0;\nconst float RASP = 9.5;\nconst float SI = 10.0;\nconst float DO_ = 11.0;\nconst float DOSP_ = 11.5;\nconst float RE_ = 12.0;\nconst float RESP_ = 12.5;\nconst float MI_ = 13.0;\n\n// song data\n\nconst int note_count = 145;\nconst float BPM = 240.0;\nconst float unit = 60.0 / BPM;\n\n// terminal time of each segment.\nconst float term[note_count] =\n        float[note_count](2.5, 3.0, 4.0, 4.5, 5.5, 6.0, 9.0, 12.0,\n                          14.5, 15.0, 16.5, 18.0, 24.0,\n                          26.5, 27.0, 28.0, 28.5, 29.5, 30.0, 33.0, 36.0,\n                          38.5, 39.0, 40.5, 42.0, 48.0,\n                          50.5, 51.0, 52.0, 52.5, 53.5, 54.0, 57.0, 60.0,\n                          62.5, 63.0, 64.5, 66.0, 72.0,\n                          74.5, 75.0, 76.0, 76.5, 77.5, 78.0, 81.0, 84.0,\n                          86.5, 87.0, 88.5, 90.0, 96.0,\n                          97.0, 97.5, 98.5, 99.0, 101.5, 102.0,\n                          103.0, 103.5, 104.5, 105.0, 107.5, 108.0,\n                          109.0, 109.5, 110.5, 111.0,\n                          112.5, 114.0, 115.5, 117.0, 120.0,\n                          121.0, 121.5, 122.5, 123.0, 125.5, 126.0,\n                          127.0, 127.5, 128.5, 129.0, 131.5, 132.0,\n                          133.0, 133.5, 134.5, 135.0,\n                          136.5, 138.0, 139.5, 141.0, 144.0,\n                          145.0, 145.5, 146.5, 147.0, 148.0, 148.5, 149.5, 150.0,\n                          151.0, 151.5, 152.5, 153.0, 156.0,\n                          157.0, 157.5, 158.5, 159.0, 160.0, 160.5, 162.0,\n                          163.0, 163.5, 164.5, 165.0, 168.0,\n                          169.0, 169.5, 170.5, 171.0, 172.0, 172.5, 173.5, 174.0,\n                          175.0, 175.5, 176.5, 177.0, 180.0,\n                          181.0, 181.5, 182.5, 183.0, 184.0, 184.5, 185.5, 186.0,\n                          187.0, 187.5, 188.5, 189.0, 192.0);\n\nconst float sus[note_count] =\n        float[note_count](2.5, 0.5, 1.0, 0.5, 1.0, 0.5, 2.5, 2.5,\n                          2.5, 0.5, 1.5, 1.5, 3.0,\n                          2.5, 0.5, 1.0, 0.5, 1.0, 0.5, 2.5, 2.5,\n                          2.5, 0.5, 1.5, 1.5, 3.0,\n                          2.5, 0.5, 1.0, 0.5, 1.0, 0.5, 2.5, 2.5,\n                          2.5, 0.5, 1.5, 1.5, 3.0,\n                          2.5, 0.5, 1.0, 0.5, 1.0, 0.5, 2.5, 2.5,\n                          2.5, 0.5, 1.5, 1.5, 3.0,\n                          1.0, 0.5, 1.0, 0.5, 2.5, 0.5,\n                          1.0, 0.5, 1.0, 0.5, 2.5, 0.5,\n                          1.0, 0.5, 1.0, 0.5, 1.5, 1.5, 1.5, 1.5, 2.5,\n                          1.0, 0.5, 1.0, 0.5, 2.5, 0.5,\n                          1.0, 0.5, 1.0, 0.5, 2.5, 0.5,\n                          1.0, 0.5, 1.0, 0.5, 1.5, 1.5, 1.5, 1.5, 2.5,\n                          1.0, 0.5, 1.0, 0.5, 1.0, 0.5, 1.0, 0.5,\n                          1.0, 0.5, 1.0, 0.5, 2.5,\n                          1.0, 0.5, 1.0, 0.5, 1.0, 0.5, 1.5,\n                          1.0, 0.5, 1.0, 0.5, 2.5,\n                          1.0, 0.5, 1.0, 0.5, 1.0, 0.5, 1.0, 0.5,\n                          1.0, 0.5, 1.0, 0.5, 2.5,\n                          1.0, 0.5, 1.0, 0.5, 1.0, 0.5, 1.0, 0.5,\n                          1.0, 0.5, 1.0, 0.5, 2.5);\n\n\nconst float notes[note_count] =\n        float[note_count](FA, DO, FA, DO, FA, SO, RA, FA,\n                          RASP, RASP, FA, SO, RA,\n                          FA, DO, FA, DO, FA, SO, RA, FA,\n                          SO, SO, SO, RA, SO,\n                          SO, SO, FASP, SO, RA, SO, FA, DO,\n                          RASP, RASP, FA, SO, RA,\n                          RE, MI, FA, MI, FA, RE, DO, FA,\n                          RA, RASP, RA, SO, FA,\n                          DO, DO, DO, DO, FA, MI,\n                          RE, RE, RE, RE, SO, FA,\n                          MI, MI, MI, MI, RE, MI, FA, SO, RA,\n                          DO, DO, DO, DO, FA, MI,\n                          RE, RE, RE, RE, SO, FA,\n                          MI, MI, MI, MI, RE, MI, FA, RA, FA,\n                          SO, SO, SO, RA, SI, SI, SI, RA,\n                          SO, SO, SO, MI, RE,\n                          MI, MI, RE, RE, SO, SO, SI,\n                          RA, RA, SO, RA, SI,\n                          RE_, RE_, RE_, RE_, RE_, RE_, MI_, RE_,\n                          SI, SO, RA, SI, RA,\n                          SO, RA, SI, SI, RA, RA, RE_, RE_,\n                          SI, SI, RA, RA, SO);\n\n// 鍵盤の番号からオクターブの指数を出すための若干美しくない処理\nconst float array_w[7] = float[7](-4.0, -2.0, 0.0, 2.0, 3.0, 5.0, 7.0);\nconst float array_b[7] = float[7](0.0, -3.0, -1.0, 1.0, 0.0, 4.0, 6.0); //0:dummy.\n\n// get exponent. 0:white key, 1:black key.\n// これを440.0に掛ける\nfloat getExponent(float index){\n    float r, q;\n    int diffType = 0;\n    if(fract(index) > 0.25){ index += 0.5; diffType = 1; }\n    for(int i = 0; i < 7; i++){\n        r = mod(index, 7.0);\n        q = floor(index / 7.0);\n        if(float(i) == r){\n            return 12.0 * q - 12.0 + (diffType == 0 ? array_w[i] : array_b[i]);\n        }\n    }\n    return 0.0;\n}","name":"Common","description":"","type":"common"},{"inputs":[],"outputs":[],"code":"#define TAU 6.2831\n\nfloat squ(float x){\n    x = fract(x);\n    return smoothstep(0.48, 0.52, x) * 2.0 - 1.0;\n}\n\nvec2 squWave(float time, float freq, float m){\n  return vec2(squ(freq * time)) * exp(-m * time);\n}\n\nvec2 sound(float t, float freq, float span){\n    return squWave(t, freq, 1.6 / span);\n}\n\nvec2 mainSound( in int samp,float time){\n    vec2 wv = vec2(0.0);\n    float prevTerm = 0.0;\n    float frequency;\n    \n    for(int i = 0; i < note_count; i++){\n        if(time < term[i] * unit){\n            frequency = 440.0 * pow(2.0, getExponent(notes[i]) / 12.0);\n            wv += sound(time - prevTerm, frequency, sus[i] * unit);\n            break;\n        }\n        prevTerm = term[i] * unit;\n    }\n    return wv;\n}\n","name":"Sound","description":"","type":"sound"}]}