{"ver":"0.1","info":{"id":"NdGXDy","date":"1635183067","viewed":234,"name":"InScatter","username":"shivaduke28","description":"ref: https://blog.mmacklin.com/2010/06/10/faster-fog/","likes":21,"published":1,"flags":0,"usePreview":0,"tags":["raymarching","fog"],"hasliked":0,"parentid":"","parentname":""},"renderpass":[{"inputs":[],"outputs":[{"id":"4dfGRr","channel":0}],"code":"precision highp float;\nconst float PI=3.141592;\n\nmat2 rot(float t){\n  return mat2(cos(t),-sin(t),sin(t),cos(t));\n}\n\nfloat sphere(vec3 p){\n  p.xz=mod(p.xz, 4.)-2.;\n  return length(p-vec3(0.,1.,0))-1.;\n}\n\nfloat plane(vec3 p){\n  return p.y;\n}\n\nfloat map(vec3 p){\n  return min(sphere(p),plane(p));\n}\n\nvec3 normal(vec3 p){\n  vec2 e=vec2(1,0)*0.01;\n  return normalize(vec3(\n    map(p+e.xyy)-map(p-e.xyy),\n    map(p+e.yxy)-map(p-e.yxy),\n    map(p+e.yyx)-map(p-e.yyx)\n    ));\n}\n\n// https://blog.mmacklin.com/2010/06/10/faster-fog/\nfloat InScatter(vec3 start, vec3 dir, vec3 lightPos, float d)\n{\n   vec3 q = start - lightPos;\n   float b = dot(dir, q);\n   float c = dot(q, q);\n   float s = 1.0 / max(0.001,sqrt(c - b*b));\n   float x = d*s;\n   float y = b*s;\n   float l = s * atan(x/max(0.001,1.+(x+y)*y));\n   return l;\n}\n\n\nvoid mainImage( out vec4 fragColor, in vec2 fragCoord )\n{\n  vec2 st = (fragCoord.xy - iResolution.xy * 0.5)/min(iResolution.x,iResolution.y);\n  vec3 col;\n  vec3 cam=vec3(0,4,0);\n  cam.z += iTime;\n  vec3 ray=cam;\n  vec3 dir=normalize(vec3(st,.5));\n  dir.yz *= rot(0.3);\n\n  vec3 lightpos = vec3(0,8,-4);\n  lightpos.xz *= rot(iTime);\n  lightpos.z += cam.z+16.;\n\n  float totald=0.;\n  for(int i=0;i<128;i++)\n  {\n    float d = map(ray);\n    if (d<0.001)\n    {\n      vec3 n=normal(ray);\n      vec3 l=normalize(lightpos-ray);\n      float lightDist = length(lightpos-ray);\n      vec3 lightColor = vec3(1,1,1)/(lightDist*lightDist)*10.;\n      col=lightColor*max(0.,dot(n,l));\n      float ocr=.6;\n      float oc=max(0.,1.-map(ray+l*ocr)/ocr);\n      oc=exp(-2.*pow(oc,2.));\n      col*=oc;\n      break;\n    }\n    totald+=d;\n    ray += dir*d;\n  }\n\n  float s = InScatter(cam, dir, lightpos,totald);\n  float fog=0.01;\n  col*=exp(-totald*fog);\n  col+= s;\n  col = pow(col, vec3(0.454545));\n  fragColor = vec4(col,1);\n}","name":"Image","description":"","type":"image"}]}