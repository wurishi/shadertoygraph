{"ver":"0.1","info":{"id":"3d2yzc","date":"1587122964","viewed":227,"name":"Escher Intersecting Planes","username":"ZiMMaBuE","description":"Esheder","likes":8,"published":1,"flags":0,"usePreview":0,"tags":["escher","reproduction"],"hasliked":0,"parentid":"","parentname":""},"renderpass":[{"inputs":[],"outputs":[{"id":"4dfGRr","channel":0}],"code":"#define MAX_STEPS 64\n#define MAX_DIST 20.\n#define EPS 0.001\nconst float PI = acos(-1.0);\n\nmat3 rotX(float angle)\n{\n    return mat3(1,\t0,\t\t\t0,\n               0,\tcos(angle), -sin(angle),\n               0,\tsin(angle), cos(angle));\n}\n\nmat3 rotY(float angle)\n{\n\treturn mat3(cos(angle), 0, sin(angle),\n               0,\t\t\t1, 0,\n               -sin(angle), 0, cos(angle));\n}\n\nmat3 rotZ(float angle)\n{\n\treturn mat3(cos(angle), -sin(angle), 0,\n               sin(angle), \tcos(angle),\t 0,\n               0,\t\t \t0,\t\t\t 1);\n}\n\nvec2 opRepLim( in vec2 p, in float s, in vec2 lima, in vec2 limb )\n{\n    return p-s*clamp(round(p/s),lima,limb);\n}\n\n\nfloat sdCube(vec2 pos, float r)\n{\n\tvec2 q = abs(pos) - r;\n\treturn length(max(q,0.0)) + min(max(q.x,q.y),0.0);\n}\n\nfloat sdCube(vec3 pos, vec3 r)\n{\n\tvec3 q = abs(pos) - r;\n\treturn length(max(q,0.0)) + min(max(q.x,max(q.y,q.z)),0.0);\n}\n\nfloat plane(vec3 pos)\n{\n    pos.z = mod((pos.z + iTime*0.2), 0.5);\n    pos.xz = opRepLim(pos.xz, 0.5, vec2(-1., -1), vec2(1., 1.0));\n    \n    return sdCube(pos, vec3(0.125,0.02,0.125));\n}\n\nfloat map(vec3 pos)\n{\n    vec3 p = vec3(0);\n    vec2 rot = vec2(PI/4., PI/2.);\n    \n    p = pos;\n    float d1 = max(p.z-0.65, plane(p));\n    \n    p = pos;\n    p *= rotY(rot.x);\n    p *= rotZ(rot.y);\n    p *= rotY(rot.x);\n    float d2 = max(p.z-0.65, plane(p));\n    \n    p = pos;\n    p *= rotY(-rot.x);\n    p *= rotZ(-rot.y);\n    p *= rotY(-rot.x);\n    float d3 = max(p.z-0.65, plane(p));\n    \n    float res = MAX_DIST;\n    res = min(res, d1);\n    res = min(res, d2);\n    res = min(res, d3);\n    return res;\n}\n\nvec3 normals(vec3 pos)\n{\n    vec2 e = vec2(0, 0.01);\n    return normalize(vec3(\n    \tmap(pos+e.yxx)-map(pos-e.yxx),\n        map(pos+e.xyx)-map(pos-e.xyx),\n        map(pos+e.xxy)-map(pos-e.xxy)\n    ));\n}\n\nconst vec4 miss = vec4(MAX_DIST, vec3(0));\nvec4 raymarch(vec3 ro, vec3 rd)\n{\n    float t = 0.0;\n    for(int i = 0; i<MAX_STEPS; i++)\n    {\n        vec3 pos = ro + rd*t;\n        float d = map(pos);\n        \n        if(abs(d)<=EPS) return vec4(length(pos-ro), normals(pos));\n        if(d >= MAX_DIST) return miss;\n        \n        t+=d;\n    }\n         \n    \n    return miss;\n}\n\nconst vec3 BACK_GROUND = vec3(0.2);\nvec3 GetScene(vec3 ro, vec3 rd, vec3 lightDir)\n{\n    \n    vec4 a = raymarch(ro, rd);\n    float d = a.x;\n    vec3 nor = a.yzw;\n    \n    vec3 col = BACK_GROUND;\n    \n    if(d < MAX_DIST)\n    {\n        float li = dot(lightDir, nor);\n        \n        vec3 pos = ro+rd*d;\n        pos *= rotX(0.9);\n        \n        float lines = sin(pos.y * 300.) * 0.5+0.5;\n        lines = smoothstep(li+0.25, li-0.25, lines);\n        lines = lines*0.7+0.3;\n        \n        col = vec3(1, 0.94, 0.8) * lines;\n        col = mix(col, BACK_GROUND, smoothstep(1., 10., d)); // fog\n    }\n    \n    return col;\n    \n}\n\nmat3 setCamera( in vec3 ro, in vec3 ta, float cr )\n{\n\tvec3 cw = normalize(ta-ro);\n\tvec3 cp = vec3(sin(cr), cos(cr),0.0);\n\tvec3 cu = normalize( cross(cw,cp) );\n\tvec3 cv =          ( cross(cu,cw) );\n    return mat3( cu, cv, cw );\n}\n\nvoid mainImage( out vec4 fragColor, in vec2 fragCoord )\n{\n    vec2 uv = (2.0*fragCoord-iResolution.xy)/iResolution.x;\n    \n    vec2 mouse = iMouse.xy / iResolution.xy;\n    float camAngle = PI/2.;\n    \n    vec2 p = 1.3 * vec2(cos(camAngle), sin(camAngle));\n    \n    \n    vec3 ro = vec3(p.x,0.915,p.y);\n    mat3 ca = setCamera(ro, vec3(0,0.2,0), 0.0);\n    vec3 rd = ca*normalize(vec3(uv,0.9));\n    \n    vec3 ld = normalize(vec3(1, 0.5, -0.5));\n    \n    vec3 col = GetScene(ro, rd, ld);\n    \n    float v = dot(uv,uv);\n    col = mix(col, vec3(0.4), pow(v,2.));\n\n    // Output to screen\n    fragColor = vec4(col,1.0);\n}","name":"Image","description":"","type":"image"}]}