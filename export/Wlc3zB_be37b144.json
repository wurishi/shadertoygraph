{"ver":"0.1","info":{"id":"Wlc3zB","date":"1576679920","viewed":387,"name":"[â™ª]Sewer World","username":"Catzpaw","description":"Experiment to play music","likes":12,"published":1,"flags":8,"usePreview":0,"tags":["raymarching","music"],"hasliked":0,"parentid":"","parentname":""},"renderpass":[{"inputs":[],"outputs":[{"id":"4dfGRr","channel":0}],"code":"//--- sewer world\n// by Catzpaw 2019\n\n#define BPM 135.\n\n#define OCT 7\n#define ITER 96\n#define EPS 0.005\n#define NEAR .1\n#define FAR 18.\n\nvec2 rot(vec2 p,float a){return vec2(p.x*cos(a)-p.y*sin(a),p.x*sin(a)+p.y*cos(a));}\nvec3 hsv(float h,float s,float v){return ((clamp(abs(fract(h+vec3(0.,.666,.333))*6.-3.)-1.,0.,1.)-1.)*s+1.)*v;}\nfloat beat(){return 1.+exp(-mod(iTime*BPM/60.,1.)*6.)*.07;}\n\nfloat map(vec3 p){float b=beat(),r=1.,lr=0.,s=1.;p.yz=rot(p.yz,iTime*.15);p.xy=rot(p.xy,iTime*.111);p.z+=iTime*.5;\n  for(int i=0;i<OCT;i++){vec3 q=clamp(sin(p)*b,-.47,.45);\n    r=max(lr,.35-dot(q,q));lr=r;s*=1.25;p*=s;}\n  return r;\n}\nfloat trace(vec3 ro,vec3 rd,out float n){float t=NEAR,d;\n  for(int i=0;i<ITER;i++){rd.xy=rot(rd.xy,d*.1);d=map(ro+rd*t);\n    if(abs(d)<EPS||t>FAR)break;t+=step(d,1.)*d*.2+d*.6;n+=1.;}\n  return min(t,FAR);\n}\nvoid mainImage(out vec4 fragColor,in vec2 fragCoord){\n  vec2 uv=(fragCoord.xy-.5*iResolution.xy)/iResolution.y;\n  vec3 rd=vec3(uv,-.4);\n  float n=0.,v=1.8-trace(vec3(0),rd,n)/FAR;n/=float(ITER);\n  float a=step(mod(v+.03,.04),.003)*.8;\n  fragColor=vec4(pow(mix(hsv(v+a,1.,1.),vec3(1),n)*(n+a),vec3(.4545)),1);\n}\n","name":"Image","description":"","type":"image"},{"inputs":[],"outputs":[],"code":"//--- sewer world\n// by Catzpaw 2019\n\n//SETUP\nconst float base =432.;\t//A tuning (Hz)\nconst float bpm  =135.;\t//beats per minute\nconst float steps=240.;\t//block length\n\n//AMP\nvec2 amp(vec2 i,vec3 p){vec2 v=pow(abs(i*p.x),vec2(1./p.y));return clamp(sign(i)*v,-1.,1.)*p.z;}\n\n//OSC\nfloat freq(float n){return pow(2.,(n-72.)/12.)*base*6.283;}\nfloat osc_saw(float t,float v){return clamp(mod(t/6.283,1.)*2.-1.,-1.,1.)*v;}\nfloat osc_sin(float t,float v){return clamp(sin(t)*v,-1.,1.);}\nfloat osc_sqr(float t,float v){return clamp(sign(sin(t))*v,-1.,1.);}\nfloat osc_noise(float t,float v){t=floor(t*1e3/v)*1e-3;return fract(sin(t*1717.17)*1313.13)*2.-1.;}\nfloat osc_metal(float t,float v){return fract(sin(t*v*171.17)*313.13)*2.-1.;}\n\n//ENV\nconst vec4 env0=vec4(.02,3.,.3,2.);\nconst vec4 env1=vec4(.1,4.,.5,2.);\nfloat env_r(float t,float r){return exp(-t*r);}\nfloat env_adsr(float t,vec4 e,float g){return min(t/e.x,max(exp(-e.y*(t-e.x)),min(e.z,e.z*exp(-e.w*(t-g)))));}\n\n//INSTRUMENTS\nvec2 bass_drum(float t){return vec2(.6)*osc_sin(t*freq(46./(1.+t*2.)),8.*env_r(t,50.));}\nvec2 snare_drum(float t){return vec2(.4)*(osc_noise(t,.194)*env_r(t,20.)+osc_sin(t*freq(53./(1.+t*.4)),8.*env_r(t,45.)));}\nvec2 hihat(float t,float r){return vec2(.3)*osc_metal(t,2.5)*env_r(t,r);}\nvec2 piano(float f,float m){return vec2(.35)*osc_saw(f,1.)*osc_sin(f*m,1.);}\nvec2 reed(float f,float m){return vec2(.2)*osc_sin(f,1.)*osc_sqr(f*m,1.);}\nvec2 fm_bass(float f,float x){return vec2(.2)*osc_sqr(f+osc_sin(f*8.,env_r(x,16.)),1.)*env_r(x,6.);}\n\n//PATTERNS\n#define P(l,s) float x=1e3,y=15.*float(l)/bpm,z=0.,v=mod(t,y*float(s));\n#define T(s) if(v>float(s)*y){x=v-float(s)*y;}\n#define N(s,n) if(v>float(s)*y){x=v-float(s)*y;z=float(n);}\n\n#define C 63\n#define Cs 64\n#define D 65\n#define Ds 66\n#define E 67\n#define F 68\n#define Fs 69\n#define G 70\n#define Gs 71\n#define A 72\n#define As 73\n#define B 74\n#define HI 12+\n#define LO -12+\n\nvec2 bd0(float t){P(1,4)T(0) return amp(bass_drum(x),vec3(1,2.2,1));}\nvec2 sd0(float t){P(1,16)T(4)T(7)T(12)T(16) return snare_drum(x);}\nvec2 hh0(float t){P(1,8)N(0,70)N(1,60)N(2,18)N(4,70)N(5,60)N(6,18) return hihat(x,z);}\n\nvec2 bs0(float t,float o){\n  P(1,16)\n  N(0,A)\n  N(2,A)\n  N(3,G)\n  N(4,A)\n  N(6,A)\n  N(7,G)\n  N(9,A)\n  N(10,HI A)\n  N(11,A)\n  N(12,A)\n  N(14,G)\n  N(15,HI G)\n  z+=o-36.;float f=x*freq(z);\n  return amp(fm_bass(f,x),vec3(1,1.3,1));\n}\nvec2 pi0(float t,float o){\n  P(4,16)\n  N(0,A)\n  N(3,HI C)\n  N(8,A)\n  N(11,Fs)\n  z+=o-12.;float f1=x*freq(z),f2=x*freq(z+5.),f3=x*freq(z+9.);\n  return (piano(f1,3.)+piano(f2,3.)+piano(f3,3.))*env_adsr(x,env0,1.);\n}\nvec2 re0(float t,float o){\n  P(4,16)\n  N(0,A)\n  N(3,HI C)\n  N(8,A)\n  N(11,Fs)\n  z+=o-24.;float f1=x*freq(z),f2=x*freq(z+5.),f3=x*freq(z+7.);\n  return (reed(f1,3.)+reed(f2,3.)+reed(f3,3.))*env_adsr(x,env1,1.5);    \n}\n\n//SEQUENCE\n#define SEQ(block,patterns) if(t>float(block)*l){o=patterns;}\n#define SEGNO(block,blocks) if(t>float(block)*l){t=mod(t-float(block)*l,float(blocks)*l);\n#define DS }\nvec2 mainSound( in int samp,float t){\n  float l=steps/bpm,vol=1.;\n  vec2 o=vec2(0);\n  if(t>170.){vol=(180.-min(t,180.))/10.;}\n\n  SEGNO(0,8)\n    SEQ(0,bd0(t)+hh0(t)+sd0(t)+bs0(t,0.)+re0(t,0.)+re0(t-.2,0.04)*.3);\n    SEQ(4,bd0(t)+hh0(t)+sd0(t)+bs0(t,3.)+pi0(t,3.)+pi0(t-.2,3.04)*.3);\n  DS\n\n  return amp(o,vec3(1,1,vol));\n}\n","name":"Sound","description":"","type":"sound"}]}